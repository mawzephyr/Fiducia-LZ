<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiducia v4.0.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'bbt-dark': '#0a0e14',
                        'bbt-darker': '#050810',
                        'bbt-gold': '#fbbf24',
                        'bbt-orange': '#f97316',
                        'bbt-cyan': '#67e8f9',
                        'bbt-blue': '#3b82f6',
                        'bbt-panel': '#1f2937',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap');
        
        .diff-added { background-color: #dcfce7; color: #166534; }
        .diff-removed { background-color: #fee2e2; color: #991b1b; }
        .diff-modified { background-color: #fef9c3; color: #854d0e; }
        .drop-active { border-color: #fbbf24; background-color: rgba(251, 191, 36, 0.1); }
        .report-content { white-space: pre-wrap; font-family: monospace; }
        
        /* Retro Electric Theme */
        .bbt-gradient { 
            background: linear-gradient(180deg, #0a0e14 0%, #1f2937 50%, #0a0e14 100%);
        }
        .bbt-title {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 50%, #1e40af 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(59, 130, 246, 0.5);
        }
        .bbt-title-gold {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(180deg, #fef08a 0%, #fbbf24 50%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .bbt-version {
            font-family: 'Orbitron', sans-serif;
            color: #f97316;
            text-shadow: 0 0 20px rgba(249, 115, 22, 0.7);
        }
        .bbt-subtitle {
            font-family: 'Rajdhani', sans-serif;
            color: #67e8f9;
            letter-spacing: 0.2em;
            text-shadow: 0 0 15px rgba(103, 232, 249, 0.5);
        }
        .bbt-tagline {
            font-family: 'Rajdhani', sans-serif;
            color: #9ca3af;
        }
        .bbt-border {
            border: 2px solid #374151;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 0 10px rgba(59, 130, 246, 0.2);
        }
        .bbt-glow-box {
            border: 1px solid #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3), inset 0 0 15px rgba(0,0,0,0.8);
            background: linear-gradient(180deg, rgba(17, 24, 39, 0.9) 0%, rgba(10, 14, 20, 0.95) 100%);
        }
        .lightning-border {
            position: relative;
        }
        .lightning-border::before {
            content: "‚ö°";
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: #fbbf24;
            font-size: 24px;
            text-shadow: 0 0 10px #fbbf24;
        }
        .lightning-border::after {
            content: "‚ö°";
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            color: #fbbf24;
            font-size: 24px;
            text-shadow: 0 0 10px #fbbf24;
        }
        .nav-dark {
            background: linear-gradient(180deg, #1f2937 0%, #0a0e14 100%);
            border-bottom: 1px solid #374151;
        }
        
        .hl-added { background-color: #86efac; padding: 2px 4px; border-radius: 3px; font-weight: 700; border-bottom: 3px solid #22c55e; }
        .hl-removed { background-color: #fca5a5; padding: 2px 4px; border-radius: 3px; font-weight: 700; text-decoration: line-through; border-bottom: 3px solid #ef4444; }
        .array-item { display: block; padding: 8px 12px; margin: 4px 0; border-radius: 6px; font-family: monospace; font-size: 13px; word-break: break-all; }
        .array-item-added { background-color: #bbf7d0; border-left: 4px solid #22c55e; }
        .array-item-removed { background-color: #fecaca; border-left: 4px solid #ef4444; }
        .loading { opacity: 0.5; pointer-events: none; }
        .clickable-card { cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; }
        .clickable-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        .status-investigation { background: #e0e7ff; color: #3730a3; }
    </style>
</head>
<body class="bg-gray-800 min-h-screen">
    <div id="app"></div>

    <!-- Confirmation Dialog -->
    <div id="confirm-dialog" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-700 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl border border-gray-700">
            <h3 id="confirm-title" class="text-lg font-bold text-white mb-2"></h3>
            <p id="confirm-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="confirm-cancel" class="px-4 py-2 bg-gray-600 text-gray-200 rounded hover:bg-gray-6000">Cancel</button>
                <button id="confirm-ok" class="px-4 py-2 bg-red-800 text-white rounded hover:bg-red-600">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="report-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-700 rounded-lg p-6 max-w-4xl w-full mx-4 shadow-xl max-h-[90vh] flex flex-col border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h3 id="report-title" class="text-lg font-bold text-white"></h3>
                <button id="report-close" class="text-gray-400 hover:text-gray-200 text-2xl">&times;</button>
            </div>
            <div id="report-content" class="flex-1 overflow-auto bg-gray-800 p-4 rounded border border-gray-600 text-sm report-content text-gray-300"></div>
            <div class="flex justify-end gap-3 mt-4">
                <button id="report-copy" class="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-600">Copy to Clipboard</button>
                <button id="report-download" class="px-4 py-2 bg-green-800 text-white rounded hover:bg-green-600">Download Report</button>
                <button id="report-download-pdf" class="px-4 py-2 bg-red-700 text-white rounded hover:bg-red-600 hidden">Download PDF</button>
            </div>
        </div>
    </div>

    <!-- Group Selection Modal -->
    <div id="group-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-700 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl border border-gray-700">
            <h3 class="text-lg font-bold text-white mb-2">Assign Asset Group</h3>
            <p id="group-modal-asset" class="text-gray-300 mb-4"></p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-1">Change Management Ticket # <span class="text-red-500">*</span></label>
                <input type="text" id="group-modal-ticket" class="w-full px-3 py-2 bg-gray-800 border border-amber-500 rounded text-gray-200 placeholder-gray-500"
                       placeholder="Required - e.g., CHG0012345" required>
                <p class="text-xs text-amber-500 mt-1">Required: A ticket number must be provided to establish the initial baseline</p>
            </div>
            <p class="text-sm text-gray-400 mb-4">Which group manages this asset?</p>
            <div class="space-y-2" id="group-options"></div>
        </div>
    </div>

    <!-- Investigation Notes Modal -->
    <div id="investigation-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-700 rounded-lg p-6 max-w-lg w-full mx-4 shadow-xl border border-gray-700">
            <h3 class="text-lg font-bold text-white mb-2">üîç Open Investigation</h3>
            <p class="text-gray-300 mb-4">This change will be marked for investigation. Add notes about what needs to be investigated:</p>
            <textarea id="investigation-notes" class="w-full h-32 p-3 border border-gray-600 rounded-lg mb-4 bg-gray-700 text-gray-200" placeholder="Enter investigation notes..."></textarea>
            <div class="flex justify-end gap-3">
                <button id="investigation-cancel" class="px-4 py-2 bg-gray-600 text-gray-200 rounded hover:bg-gray-6000">Cancel</button>
                <button id="investigation-confirm" class="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-800">Start Investigation</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        
        var API_BASE = '';  // Change if your API is elsewhere
        var APP_NAME = 'Fiducia';
        var APP_VERSION = '4.0.4';

        var CHANGELOG = [
            {
                version: '4.0.4',
                date: '2025-12-18',
                changes: [
                    'Fixed: Consistent UTC timestamps throughout application (was mixing local and UTC time)',
                    'Fixed: Unix timestamp parsing now uses UTC instead of local time',
                    'Added: Single-session login enforcement - logging in from a new device automatically logs out previous sessions',
                    'Added: UserSession model for tracking active sessions',
                    'Security: Session tokens embedded in JWT for server-side session validation'
                ]
            },
            {
                version: '4.0.4',
                date: '2025-12-18',
                changes: [
                    'UI text update: Date picker now says "Select date for the reports to the right"',
                    'Bug fix: Removed orphaned event handler for deleted Historical View button'
                ]
            },
            {
                version: '4.0.2',
                date: '2025-12-17',
                changes: [
                    'Compliance Page UI cleanup: Removed Historical View button (date picker controls all reports)',
                    'Renamed baseline buttons: "Print All Assets (TXT)" and "PDF by Asset Name" for clarity',
                    'Removed Scheduled Check History section from Compliance page',
                    'Baseline Promotion Report PDF: Download comprehensive PDF after finalizing changes',
                    'Time to Close tracking: Each change shows days from detection to resolution',
                    'Updated "How Compliance Tracking Works" documentation to emphasize 30-day per-change timers',
                    'Updated Help section to reflect UI changes'
                ]
            },
            {
                version: '4.0.1',
                date: '2025-12-17',
                changes: [
                    'Investigation Closure Reports: Added date filtering and search by asset name or ticket number',
                    'Ticket Search PDF Export: Download PDF reports of all changes for a specific ticket',
                    'Custom Baseline PDF: Generate baseline reports for specific assets (comma-separated) as PDF',
                    'Enhanced Audit Logging: Ticket numbers and asset names now included in audit log details',
                    'Password Reset Tracking: Admin password resets are now logged in audit trail',
                    'User Audit Modal: Now displays ticket numbers for change approvals/rejections',
                    'Investigation Closure PDF: Fixed logo aspect ratio (square 1.5 inch)',
                    'Null Value Display: Changed from showing "null" to "-" for empty values',
                    'Various bug fixes for PDF generation and frontend error handling'
                ]
            },
            {
                version: '4.0.0',
                date: '2025-12-17',
                changes: [
                    'Security Hardening: Added security headers middleware (X-Frame-Options, CSP, X-Content-Type-Options)',
                    'API docs (/docs, /redoc) disabled when DEBUG=False',
                    'Added Trusted Host middleware for host header validation',
                    'Added request body size limiting (10MB default)',
                    'New config options: ALLOWED_HOSTS, MAX_REQUEST_SIZE, session cookie settings',
                    'Added comprehensive Security & Production Deployment documentation in Help',
                    'Includes Nginx reverse proxy configuration examples'
                ]
            },
            {
                version: '3.8.9',
                date: '2025-12-17',
                changes: [
                    'Redesigned Reports & Tools section on Compliance page',
                    'Unified layout: 4-column report row + 2-3 column tools row',
                    'Equal height cards with consistent styling',
                    'Separated Historical View into its own button'
                ]
            },
            {
                version: '3.8.8',
                date: '2025-12-17',
                changes: [
                    'Removed separate PNCI Report button (now part of Baseline & Compliance Report)',
                    'Updated Help section to reflect consolidated reporting',
                    'Renamed button to "Baseline Report"'
                ]
            },
            {
                version: '3.8.7',
                date: '2025-12-17',
                changes: [
                    'Merged PNCI report into Baseline Report for comprehensive audit documentation',
                    'Added report legend explaining contents (Section 1: PNCI, Section 2: Baselines)',
                    'PNCI section shows compliance status, recommendations, and assets by team',
                    'Renamed download file to CIP010_Baseline_Compliance_Report'
                ]
            },
            {
                version: '3.8.6',
                date: '2025-12-17',
                changes: [
                    'Baseline Report now shows full field values without truncation for audit purposes',
                    'Changed report format to key-value style with ticket reference per field'
                ]
            },
            {
                version: '3.8.5',
                date: '2025-12-17',
                changes: [
                    'Muted report button colors on Compliance page (Baseline, PNCI, File Comparison)',
                    'Changed bright green, amber, and blue buttons to neutral gray tones'
                ]
            },
            {
                version: '3.8.4',
                date: '2025-12-17',
                changes: [
                    'Fixed Assets tab highlighting when viewing individual asset detail page'
                ]
            },
            {
                version: '3.8.3',
                date: '2025-12-16',
                changes: [
                    'Fixed comparison tool back button to return to previous view instead of login',
                    'Added active state highlighting to navigation tabs (Dashboard, Assets, Compliance, etc.)',
                    'Navigation now shows amber highlight on current section for better orientation'
                ]
            },
            {
                version: '3.8.2',
                date: '2025-12-16',
                changes: [
                    'Added "Philosophy of Using Arrays for Baseline Comparisons" to Help section',
                    'Technical documentation of set-based comparison engine for auditors and leadership',
                    'Explains order-independent array comparison, canonical key generation, and change signatures'
                ]
            },
            {
                version: '3.8.1',
                date: '2025-12-16',
                changes: [
                    'Changed pending changes in asset detail view from amber to blue (amber reserved for investigations)',
                    'Fixed pending changes display in asset detail to show array diffs properly',
                    'Null values now display as "(none)" instead of "null"'
                ]
            },
            {
                version: '3.8.0',
                date: '2025-12-16',
                changes: [
                    'Flexible compliance check scheduling - choose between day-of-month or weekday pattern',
                    'Weekday pattern support: schedule checks on nth weekday (e.g., 1st & 3rd Tuesday)',
                    'Dynamic countdown timer updates based on configured schedule',
                    'Schedule description shown in countdown display',
                    'Settings UI with interactive weekday pattern configuration'
                ]
            },
            {
                version: '3.7.9',
                date: '2025-12-16',
                changes: [
                    'Version synchronization release - all components now consistent',
                    'Frontend, backend, and browser tab versions unified'
                ]
            },
            {
                version: '3.7.8',
                date: '2025-12-16',
                changes: [
                    'Expanded "How Compliance Tracking Works" Help section with detailed workflow documentation',
                    'Added Change Status vs Asset State distinction explanation',
                    'Documented two queue types: Pending Changes vs Investigation Queue',
                    'Added investigation escalation triggers (manual vs automatic 30-day)',
                    'Documented compliance timer and status indicators (green/amber/red)',
                    'Step-by-step resolution process with Investigation Notes usage',
                    'PNCI reporting requirements documentation'
                ]
            },
            {
                version: '3.7.7',
                date: '2025-12-16',
                changes: [
                    'API Integration - POST /api/assets/submit-config endpoint for script-based config submission',
                    'Submit JSON configurations directly via API without file uploads',
                    'Investigation Notes - add notes during investigation for inclusion in closure reports',
                    'Enhanced Investigation Closure Report with detailed timeline, notes, and change details',
                    'Fixed pending vs investigation queue separation - now based on change status, not asset state',
                    'Array diff detection for stringified arrays (e.g., ports_services_string)',
                    'New Help section: API Integration & Automation with curl and Python examples',
                    'Asset state sync endpoint to fix orphaned investigation states'
                ]
            },
            {
                version: '3.7.6',
                date: '2025-12-16',
                changes: [
                    'Professional dark mode color scheme overhaul',
                    'Replaced vibrant purple, cyan, pink with muted slate and blue tones',
                    'All accent colors toned down for reduced visual noise',
                    'Cleaner, less rainbow look while maintaining dark mode aesthetic'
                ]
            },
            {
                version: '3.7.5',
                date: '2025-12-16',
                changes: [
                    'Countdown timer on Action Required banner shows time until next scheduled check',
                    'Countdown displays on Dashboard and Asset Detail pending changes sections',
                    'Color-coded urgency: green (>2 days), yellow (‚â§2 days), red (<12 hours)',
                    'Shows target date (e.g., "Day 1 - Jan 1") alongside countdown',
                    'Auto-updates every minute without page refresh',
                    'Loads scheduled check days from system config API'
                ]
            },
            {
                version: '3.7.4',
                date: '2025-12-16',
                changes: [
                    'Security: Rate limiting on login (10 attempts per minute per IP)',
                    'Security: Account lockout after 5 failed attempts (15 minute lockout)',
                    'Security: CORS origins now configurable via CORS_ORIGINS environment variable',
                    'Security: Comparison API endpoints now require authentication',
                    'Security: Startup warning if using default SECRET_KEY',
                    'Login error messages now show remaining attempts before lockout'
                ]
            },
            {
                version: '3.7.3',
                date: '2025-12-16',
                changes: [
                    'Active Sessions panel on admin dashboard - shows users logged in within last 8 hours',
                    'Helps identify users who need to be warned about maintenance',
                    'Delete Asset now requires password confirmation and admin role',
                    'Delete confirmation shows warning that audit logs are preserved for compliance',
                    'Audit logs persist after asset deletion with asset_name field for reference',
                    'Database migration adds asset_name column to audit_logs table'
                ]
            },
            {
                version: '3.7.2',
                date: '2025-12-16',
                changes: [
                    'User Activity Audit - admins can now view detailed audit logs per user on Compliance page',
                    'User dropdown shows all users with action counts, modal displays full activity history',
                    'Color-coded action badges with summary by action type',
                    'Moved File Comparison tool from login page to Compliance page (now requires authentication)',
                    'Reorganized Compliance page tools into compact 3-column grid layout',
                    'Fixed [object Object] display for array items in pending changes view',
                    'Added formatValue() helper for proper object/array formatting in reports'
                ]
            },
            {
                version: '3.7.1',
                date: '2025-12-15',
                changes: [
                    'Asset Rename Approval Workflow - renaming assets now requires approval like other baseline changes',
                    'Rename requests appear in Changes view with "Asset Name (FQDN)" label',
                    'Warning dialog explains rename will be tracked and requires approval',
                    'Required Ticket Numbers - all change reviews and initial baselines now require a ticket #',
                    'UI updated with "Required" indicators on ticket fields',
                    'Compliance page title updated to "Compliance Tracking"',
                    'Fixed signature handling for rename changes in bulk review'
                ]
            },
            {
                version: '3.7.0',
date: '2025-12-15',
                changes: [
                    'RFC 5424 Syslog Forwarding - forward audit events to remote syslog servers',
                    'Supports UDP, TCP, and TLS protocols with configurable facility levels',
                    'Per-event configuration - enable/disable forwarding for 26 event types',
                    'New Settings section: Syslog Forwarding with server config and event toggles',
                    'Test Connection button to verify syslog server connectivity',
                    'Collapsible section UI pattern for better settings organization',
                    'Syslog hooks integrated into all audit events (assets, changes, scheduler)'
                ]
            },
            {
                version: '3.5.9',
                date: '2025-12-15',
                changes: [
                    'Ticket Impact Report - view before/after baseline changes for any ticket',
                    'Click üìã button next to any ticket number in Effective Baseline to see impact',
                    'Side-by-side comparison shows fields BEFORE and AFTER ticket changes',
                    'Downloadable text report with full change details',
                    'API endpoint: GET /api/assets/{id}/ticket-impact/{ticket_number}'
                ]
            },
            {
                version: '3.5.8',
                date: '2025-12-15',
                changes: [
                    'Effective Baseline Report - displays baselines in table format matching UI view',
                    'Each asset shows Field | Value | Ticket columns for all baseline fields',
                    'Per-field ticket numbers displayed (falls back to baseline ticket if none)',
                    'Flattened field paths (e.g., network.dns.servers) for nested config values',
                    'Investigation Report now sources closed investigations from audit logs',
                    'Closed investigations persist in reports even after change deletion'
                ]
            },
            {
                version: '3.5.7',
                date: '2025-12-15',
                changes: [
                    'Investigation Report - now shows BOTH open and closed investigations for the report date',
                    'Closed investigations sourced from audit logs (persists after finalization deletes changes)',
                    'Closed investigations show: investigation start, closure time, duration, ticket numbers',
                    'Each resolved change displays "PROMOTED TO BASELINE" with old and new values',
                    'Investigation closure tracked via bulk_investigation and change_approved audit entries',
                    'Clear separation between Open and Closed Investigation sections with summaries'
                ]
            },
            {
                version: '3.5.6',
                date: '2025-12-15',
                changes: [
                    'Investigation Queue - dedicated amber-styled section on Dashboard for assets under investigation',
                    'Staged review workflow - approve/reject changes locally, then finalize all at once',
                    'Per-change and per-asset ticket inputs with "Apply to All" button',
                    'Real-time progress bar shows changes reviewed vs remaining to close investigation',
                    'Revert button on each change and "Revert All" in header to undo local decisions',
                    'Dedicated "Finalize Investigation Changes" button directly in Investigation Queue',
                    'Investigation closure logging - audit logs and promotion summaries document when investigations are closed',
                    'Asset state restored to COMPLIANT when all investigation changes are resolved'
                ]
            },
            {
                version: '3.5.5',
                date: '2025-12-15',
                changes: [
                    'Asset search - filter assets by name on the Assets tab',
                    'Debounced search input (600ms) maintains focus while typing'
                ]
            },
            {
                version: '3.5.4',
                date: '2025-12-15',
                changes: [
                    'Field ticket persistence fix - tickets now survive change finalization/deletion',
                    'Added field_tickets_json column to baseline snapshots for per-field ticket storage',
                    'Asset list latest ticket now pulls from persisted field tickets after finalization',
                    'Fixed ticket input values being lost after approving changes (save/restore pattern)'
                ]
            },
            {
                version: '3.5.3',
                date: '2025-12-15',
                changes: [
                    'Ticket # column added to Effective Baseline table - shows ticket associated with each field',
                    'Latest Ticket column added to Assets list - displays most recent ticket for quick reference',
                    'Admin backfill endpoint for mass-importing ticket numbers to existing data'
                ]
            },
            {
                version: '3.5.2',
                date: '2025-12-15',
                changes: [
                    'Change Management Ticket # - Associate ticket numbers with baseline promotions and field changes',
                    'Two-tier ticket application: Per-Asset and Per-Field levels',
                    'Asset-specific change grouping on Dashboard and Changes page for better organization',
                    'Visual hierarchy with distinct color themes: Slate (Asset), Subtle (Field)',
                    'Ticket # displayed in all reports, promotion summaries, and approved changes list',
                    'Database migration system for automatic schema updates'
                ]
            },
            {
                version: '3.3.0',
                date: '2025-12-15',
                changes: [
                    'Revert Feature - undo approved changes before finalizing (24h configurable window)',
                    'Per-Change Finalize - finalize approved changes without waiting for full asset review',
                    'Improved Compliance Workflow - changes start as PENDING, assets stay COMPLIANT until user action',
                    'Fixed baseline flip-flop bug - scheduler only compares against newly uploaded configs',
                    'Compliance counts now mutually exclusive (Compliant + Awaiting Review + Investigation + Failed = Total)',
                    'Approved changes section shows alongside pending with individual revert buttons',
                    'Promotion Summary includes full old/new values for ticket documentation',
                    'Scheduled Check History shows trigger type (manual vs auto) and investigated assets',
                    'Dashboard updates immediately after finalize (no stale approved changes visible)'
                ]
            },
            {
                version: '3.2.5',
                date: '2025-12-15',
                changes: [
                    'SMTP Email Notifications - configurable alerts for compliance events',
                    'Approaching Deadline Alert - notifies when assets enter warning threshold',
                    'Failed/Overdue Alert - critical notification when assets exceed 30-day window',
                    'Weekly Investigation Report - scheduled summary of compliance status',
                    'Email Settings UI - SMTP configuration with test connection and test email',
                    'Alert Recipients - separate email lists for compliance team and managers',
                    'Scheduler integration - automatic alerts after compliance checks'
                ]
            },
            {
                version: '3.2.4',
                date: '2025-12-15',
                changes: [
                    'User Management UI - admins can create users, assign roles, reset passwords, delete users',
                    'Investigation Report feature - Day 1 tracking, days elapsed, detailed change history',
                    'Compliance summary redesign - 6 status cards including Awaiting Review count',
                    'Awaiting Review warnings - alerts on Dashboard, Changes, and Assets pages before auto-check',
                    'Fixed ACTIVE vs COMPLIANT state confusion - consolidated asset states',
                    'Replaced FQDN column with Last Baseline Promotion date on Assets page',
                    'Updated Help section with User Management and compliance status documentation'
                ]
            },
            {
                version: '3.2.3',
                date: '2025-12-15',
                changes: [
                    'Redesigned Reports & Historical View section on Compliance page',
                    'Three-column layout with clear descriptions for each report function',
                    'Added Reports documentation to Help section',
                    'Added asset renaming to Audit Logs documentation',
                    'Improved UI explanations throughout the application'
                ]
            },
            {
                version: '3.2.2',
                date: '2025-12-15',
                changes: [
                    'Historical Baseline Report generation',
                    'Export ALL active assets with approved baselines for any date',
                    'Full configuration JSON included for each asset',
                    'Grouped by team for compliance documentation',
                    'Downloads as .txt file from Compliance page'
                ]
            },
            {
                version: '3.2.1',
                date: '2025-12-15',
                changes: [
                    'Asset Rename feature - change FQDN while preserving all history and audit records',
                    'Dedicated rename endpoint preserves baselines, changes, and compliance data',
                    'Audit log clearly captures old name ‚Üí new name transitions',
                    'Help section documentation for asset renaming'
                ]
            },
            {
                version: '3.2.0',
                date: '2025-12-15',
                changes: [
                    'Asset Retirement feature - retire/restore assets with ticket tracking',
                    'Active/Retired/All filter tabs on Assets page',
                    'Comprehensive Help section with user documentation',
                    'Clickable version number showing changelog history',
                    'Role-based access control for change visibility by team',
                    'Dashboard redesign with inline pending changes review',
                    'Group tabs for filtering changes by team',
                    'Bulk change approval with affected assets preview',
                    'Smart diff highlighting showing only changed portions',
                    'Simplified UI styling to match settings page',
                    'Fixed login input text visibility'
                ]
            },
            {
                version: '3.1.0',
                date: '2025-12-14',
                changes: [
                    'Manual configuration editor with audit logging',
                    'Audit log improvements for bulk approvals',
                    'Enhanced diff view with color-coded changes',
                    'Asset detail page with effective baseline view'
                ]
            },
            {
                version: '3.0.0',
                date: '2025-12-13',
                changes: [
                    'Complete UI rewrite with modern dashboard',
                    'CIP-010 compliance tracking with 30-day timer',
                    'Scheduled compliance checks',
                    'LDAP authentication support',
                    'Watch folder auto-ingestion',
                    'User management and role-based access'
                ]
            }
        ];

        // ============================================================
        // STATE
        // ============================================================
        
        var currentView = 'login';
        var previousView = 'login';  // Track previous view for back navigation
        var currentUser = null;
        var authToken = null;
        var groups = [];
        var selectedAsset = null;
        var selectedNewAsset = null;
        var newAssetsQueue = [];
        var filterGroup = null;
        var dashboardSelectedGroup = 'all';  // 'all' or group_id for dashboard filtering
        var assetStatusFilter = 'active';  // 'active', 'retired', or 'all'
        var assetSortBy = 'asset_name';
        var assetSortOrder = 'asc';
        var assetSearchTerm = '';
        var reviewDecisions = {};
        var investigationTickets = {};  // Store tickets for investigation assets by assetId
        var investigationNotes = {};    // Store investigation notes by assetId
        var ticketValues = {};  // Store ticket # values to persist across renders
        var scheduledCheckDays = [1, 15];  // Default, loaded from config (backwards compatibility)
        var scheduleConfig = null;  // Full schedule configuration object
        var countdownInterval = null;  // For updating the countdown timer

        // ============================================================
        // API CLIENT
        // ============================================================

        async function api(endpoint, options = {}) {
            var url = API_BASE + endpoint;
            var headers = { 'Content-Type': 'application/json' };
            
            if (authToken) {
                headers['Authorization'] = 'Bearer ' + authToken;
            }
            
            var config = {
                method: options.method || 'GET',
                headers: headers
            };
            
            if (options.body) {
                config.body = JSON.stringify(options.body);
            }
            
            try {
                var response = await fetch(url, config);
                
                if (response.status === 401) {
                    clearAuth();
                    currentView = 'login';
                    render();
                    throw new Error('Session expired');
                }
                
                if (!response.ok) {
                    var error = await response.json().catch(() => ({}));
                    var detail = error.detail;
                    // Handle FastAPI validation errors (array of objects)
                    if (Array.isArray(detail)) {
                        detail = detail.map(function(e) { return e.msg || JSON.stringify(e); }).join(', ');
                    } else if (typeof detail === 'object' && detail !== null) {
                        detail = JSON.stringify(detail);
                    }
                    throw new Error(detail || 'API Error: ' + response.status);
                }
                
                return await response.json();
            } catch (err) {
                console.error('API Error:', err);
                throw err;
            }
        }

        async function apiUpload(endpoint, files) {
            var formData = new FormData();
            for (var i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            
            var response = await fetch(API_BASE + endpoint, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + authToken },
                body: formData
            });
            
            if (!response.ok) {
                var error = await response.json().catch(() => ({}));
                throw new Error(error.detail || 'Upload failed');
            }
            
            return await response.json();
        }

        // Global function for downloading investigation closure PDFs
        async function downloadInvestigationClosurePdf(auditLogId, assetId) {
            try {
                var url = API_BASE + '/api/reports/investigation-closure-pdf/' + auditLogId;
                if (assetId) {
                    url += '?asset_id=' + assetId;
                }

                var response = await fetch(url, {
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    }
                });

                if (!response.ok) {
                    var errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Failed to generate PDF');
                }

                var blob = await response.blob();
                var downloadUrl = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = downloadUrl;

                // Get filename from Content-Disposition header if available
                var contentDisposition = response.headers.get('Content-Disposition');
                var filename = 'Investigation_Closure_Report.pdf';
                if (contentDisposition) {
                    var matches = contentDisposition.match(/filename=([^;]+)/);
                    if (matches && matches[1]) {
                        filename = matches[1].replace(/"/g, '');
                    }
                }

                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);
            } catch (err) {
                alert('Error downloading PDF: ' + err.message);
            }
        }
        // Make it globally accessible
        window.downloadInvestigationClosurePdf = downloadInvestigationClosurePdf;


        // ============================================================
        // INVESTIGATION CLOSURE FILTERING
        // ============================================================

        var closureCurrentOffset = 0;
        var closureLimit = 25;
        var closureHasMore = false;

        async function loadInvestigationClosures(append) {
            if (!append) {
                closureCurrentOffset = 0;
            }

            var filterDate = document.getElementById("closure-filter-date").value;
            var search = document.getElementById("closure-search").value;
            var searchType = document.getElementById("closure-search-type").value;

            var statusEl = document.getElementById("closure-status");
            var tableContainer = document.getElementById("closure-table-container");
            var loadMoreBtn = document.getElementById("closure-load-more");

            statusEl.textContent = "Loading...";

            try {
                var params = new URLSearchParams();
                if (filterDate) params.append("filter_date", filterDate);
                if (search) params.append("search", search);
                params.append("search_type", searchType);
                params.append("limit", closureLimit);
                params.append("offset", closureCurrentOffset);

                var response = await api("/api/reports/investigation-closures/list?" + params.toString());

                closureHasMore = response.has_more;

                if (response.closures.length === 0 && closureCurrentOffset === 0) {
                    statusEl.textContent = "No investigation closures found" + (filterDate || search ? " matching your filters." : ".");
                    tableContainer.innerHTML = "";
                    loadMoreBtn.classList.add("hidden");
                    return;
                }

                var showing = closureCurrentOffset + response.closures.length;
                statusEl.textContent = "Showing " + showing + " of " + response.total_closures + " closures";

                var tableHtml = renderClosureTable(response.closures);
                tableContainer.innerHTML = tableHtml;

                if (closureHasMore) {
                    loadMoreBtn.classList.remove("hidden");
                } else {
                    loadMoreBtn.classList.add("hidden");
                }

                closureCurrentOffset += response.closures.length;

            } catch (err) {
                statusEl.textContent = "Error loading closures: " + err.message;
            }
        }

        function renderClosureTable(closures) {
            var html = '<table class="w-full text-sm"><thead class="bg-gray-900 sticky top-0"><tr>' +
                '<th class="px-3 py-2 text-left font-semibold text-gray-300">Closure Date</th>' +
                '<th class="px-3 py-2 text-left font-semibold text-gray-300">Asset</th>' +
                '<th class="px-3 py-2 text-left font-semibold text-gray-300">Team</th>' +
                '<th class="px-3 py-2 text-left font-semibold text-gray-300">Duration</th>' +
                '<th class="px-3 py-2 text-left font-semibold text-gray-300">Changes</th>' +
                '<th class="px-3 py-2 text-left font-semibold text-gray-300">Closed By</th>' +
                '<th class="px-3 py-2 text-left font-semibold text-gray-300">Actions</th>' +
                '</tr></thead><tbody>';

            closures.forEach(function(c) {
                var dur = c.investigation_duration_days !== null
                    ? (c.investigation_duration_days === 0 ? "Same day" : c.investigation_duration_days + " day" + (c.investigation_duration_days !== 1 ? "s" : ""))
                    : "-";
                var durClass = c.investigation_duration_days !== null && c.investigation_duration_days > 35 ? "text-red-400" : "text-green-400";
                html += '<tr class="border-t border-gray-700 hover:bg-gray-700">' +
                    '<td class="px-3 py-2 text-gray-300">' + escapeHtml(c.closure_date_display) + '</td>' +
                    '<td class="px-3 py-2"><span class="font-medium text-blue-400">' + escapeHtml(c.asset_name || "Unknown") + '</span></td>' +
                    '<td class="px-3 py-2 text-gray-400">' + escapeHtml(c.group || "-") + '</td>' +
                    '<td class="px-3 py-2 ' + durClass + '">' + dur + '</td>' +
                    '<td class="px-3 py-2 text-gray-400">' + c.changes_count + '</td>' +
                    '<td class="px-3 py-2 text-gray-400">' + escapeHtml(c.closed_by_username || "-") + '</td>' +
                    '<td class="px-3 py-2"><button onclick="downloadInvestigationClosurePdf(' + c.audit_log_id + ', ' + c.asset_id + ')" class="px-2 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-500">Download PDF</button></td></tr>';
            });

            return html + '</tbody></table>';
        }

        function loadMoreClosures() {
            loadInvestigationClosures(true);
        }

        function clearClosureFilters() {
            document.getElementById("closure-filter-date").value = "";
            document.getElementById("closure-search").value = "";
            document.getElementById("closure-search-type").value = "asset";
            loadInvestigationClosures();
        }

        window.loadInvestigationClosures = loadInvestigationClosures;
        window.loadMoreClosures = loadMoreClosures;
        window.clearClosureFilters = clearClosureFilters;


        // ============================================================
        // AUTH
        // ============================================================

        function saveAuth(token, user) {
            authToken = token;
            currentUser = user;
            localStorage.setItem('cip010_token', token);
            localStorage.setItem('cip010_user', JSON.stringify(user));
        }

        function loadAuth() {
            var token = localStorage.getItem('cip010_token');
            var user = localStorage.getItem('cip010_user');
            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                return true;
            }
            return false;
        }

        function clearAuth() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('cip010_token');
            localStorage.removeItem('cip010_user');
        }

        function userCanViewAllGroups() {
            // Admin or users without a group assignment can view all groups
            return currentUser && (currentUser.role === 'admin' || !currentUser.group_id);
        }

        function initDashboardGroupSelection() {
            // Set initial group selection based on user permissions
            if (userCanViewAllGroups()) {
                dashboardSelectedGroup = 'all';
            } else if (currentUser && currentUser.group_id) {
                dashboardSelectedGroup = currentUser.group_id;
            }
        }

        // ============================================================
        // SMART ARRAY COMPARISON (Order-Independent Set Comparison)
        // ============================================================

        /**
         * Convert any object to a consistent string key for set comparison.
         * Handles nested objects and arrays - ORDER INDEPENDENT.
         */
        function objectToKey(obj) {
            if (obj === null || obj === undefined) return 'null';
            if (typeof obj === 'boolean') return obj ? 'true' : 'false';
            if (typeof obj === 'number' || typeof obj === 'string') return String(obj);
            if (Array.isArray(obj)) {
                // Sort array elements for consistent comparison
                return '[' + obj.map(objectToKey).sort().join(',') + ']';
            }
            if (typeof obj === 'object') {
                // Sort keys and recurse
                var keys = Object.keys(obj).sort();
                return '{' + keys.map(function(k) {
                    return k + ':' + objectToKey(obj[k]);
                }).join(',') + '}';
            }
            return String(obj);
        }

        /**
         * Try to parse a value as an array (handles JSON strings, arrays, etc.)
         */
        function tryParseAsArray(value) {
            if (Array.isArray(value)) {
                return value;
            }
            if (typeof value === 'string') {
                // Try to parse as JSON array
                var trimmed = value.trim();
                if (trimmed.startsWith('[') && trimmed.endsWith(']')) {
                    try {
                        var parsed = JSON.parse(trimmed);
                        if (Array.isArray(parsed)) {
                            return parsed;
                        }
                    } catch (e) {
                        // Not valid JSON, try Python-style parsing
                        return tryParsePythonArray(trimmed);
                    }
                }
                // Check if it's a quoted JSON string
                if (trimmed.startsWith('"[') || trimmed.startsWith("'[")) {
                    try {
                        var unquoted = JSON.parse(trimmed);
                        return tryParseAsArray(unquoted);
                    } catch (e) {}
                }
            }
            return null;
        }

        /**
         * Parse Python-style array string like "[{'key': 'value'}, ...]"
         */
        function tryParsePythonArray(str) {
            try {
                // Convert Python dict syntax to JSON
                var jsonStr = str
                    .replace(/'/g, '"')  // Single quotes to double quotes
                    .replace(/True/g, 'true')
                    .replace(/False/g, 'false')
                    .replace(/None/g, 'null');
                var parsed = JSON.parse(jsonStr);
                if (Array.isArray(parsed)) {
                    return parsed;
                }
            } catch (e) {}
            return null;
        }

        /**
         * Compare two arrays as sets and return added/removed items.
         * Order does NOT matter - only cares about what items exist.
         */
        function compareArraysAsSet(oldArr, newArr) {
            var oldKeys = {};
            var newKeys = {};
            
            // Build key maps
            oldArr.forEach(function(item) {
                var key = objectToKey(item);
                oldKeys[key] = item;
            });
            
            newArr.forEach(function(item) {
                var key = objectToKey(item);
                newKeys[key] = item;
            });
            
            // Find differences
            var added = [];
            var removed = [];
            
            for (var key in oldKeys) {
                if (!(key in newKeys)) {
                    removed.push(oldKeys[key]);
                }
            }
            
            for (var key in newKeys) {
                if (!(key in oldKeys)) {
                    added.push(newKeys[key]);
                }
            }
            
            return { added: added, removed: removed };
        }

        /**
         * Analyze a change and enhance it with smart array comparison if applicable.
         * This handles cases where arrays are stored as strings.
         */
        function enhanceChangeWithArrayDiff(change) {
            // If already array_modified, it's good
            if (change.change_type === 'array_modified') {
                return change;
            }
            
            // If it's a modification, check if values are array-like
            if (change.change_type === 'modified') {
                var oldArr = tryParseAsArray(change.old_value);
                var newArr = tryParseAsArray(change.new_value);
                
                if (oldArr && newArr) {
                    // Do set comparison
                    var diff = compareArraysAsSet(oldArr, newArr);
                    
                    // Return enhanced change
                    return {
                        field_path: change.field_path,
                        change_type: 'array_modified',
                        old_value: change.old_value,
                        new_value: change.new_value,
                        items_added: diff.added,
                        items_removed: diff.removed,
                        signature: change.signature
                    };
                }
            }
            
            return change;
        }

        /**
         * Format an array item for display (compact, readable)
         */
        function formatArrayItem(item) {
            if (typeof item === 'object' && item !== null) {
                // Format object nicely
                var parts = [];
                for (var key in item) {
                    parts.push(key + ': ' + JSON.stringify(item[key]));
                }
                return '{ ' + parts.join(', ') + ' }';
            }
            return JSON.stringify(item);
        }

        /**
         * Format any value for display (handles objects, arrays, primitives)
         */
        function formatValue(value) {
            if (value === null || value === undefined) {
                return '‚Äî';
            }
            if (typeof value === 'object') {
                if (Array.isArray(value)) {
                    return value.map(formatArrayItem).join(', ');
                }
                // Format object nicely
                var parts = [];
                for (var key in value) {
                    parts.push(key + ': ' + JSON.stringify(value[key]));
                }
                return '{ ' + parts.join(', ') + ' }';
            }
            return String(value);
        }

        // ============================================================
        // UTILITIES
        // ============================================================

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        function escapeAttr(text) {
            // Escape for use in HTML attributes (includes quotes)
            return String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function getNthWeekdayOfMonth(year, month, weekday, occurrence) {
            // Get the nth occurrence of a weekday in a given month
            // weekday: 0=Sunday, 1=Monday, ... 6=Saturday (JS convention)
            // occurrence: 1=1st, 2=2nd, 3=3rd, 4=4th
            var firstDay = new Date(year, month, 1);
            var firstWeekday = firstDay.getDay();

            // Calculate days until first occurrence of target weekday
            var daysUntilWeekday = (weekday - firstWeekday + 7) % 7;
            var firstOccurrence = 1 + daysUntilWeekday;

            // Calculate nth occurrence
            var targetDay = firstOccurrence + (occurrence - 1) * 7;

            // Check if it's still in the same month
            var lastDayOfMonth = new Date(year, month + 1, 0).getDate();
            if (targetDay > lastDayOfMonth) {
                return null;
            }

            return new Date(year, month, targetDay, 0, 0, 0);
        }

        function getNextNthWeekday(weekday, occurrence, fromDate) {
            // Get the next occurrence of an nth weekday pattern
            // weekday: 0=Monday...6=Sunday (Python convention, convert to JS)
            var jsWeekday = (weekday + 1) % 7;  // Convert Python weekday to JS weekday

            if (!fromDate) fromDate = new Date();
            var year = fromDate.getFullYear();
            var month = fromDate.getMonth();

            // Check this month first
            var thisMonthDate = getNthWeekdayOfMonth(year, month, jsWeekday, occurrence);
            if (thisMonthDate && thisMonthDate > fromDate) {
                return thisMonthDate;
            }

            // Move to next month
            month++;
            if (month > 11) {
                month = 0;
                year++;
            }

            return getNthWeekdayOfMonth(year, month, jsWeekday, occurrence);
        }

        function getNextScheduledCheck() {
            // If we have a server-provided next check date, use it
            if (scheduleConfig && scheduleConfig.next_check_date) {
                return new Date(scheduleConfig.next_check_date + 'T00:00:00');
            }

            // Calculate the next scheduled check date based on schedule configuration
            var now = new Date();
            var currentDay = now.getDate();
            var currentMonth = now.getMonth();
            var currentYear = now.getFullYear();

            // Check if we have the new schedule config format
            if (scheduleConfig && scheduleConfig.type === 'weekday_pattern' && scheduleConfig.patterns) {
                // New behavior - nth weekday of month
                var nextDates = [];
                scheduleConfig.patterns.forEach(function(pattern) {
                    var nextDate = getNextNthWeekday(pattern.weekday, pattern.occurrence, now);
                    if (nextDate) {
                        nextDates.push(nextDate);
                    }
                });

                if (nextDates.length > 0) {
                    // Return the earliest date
                    return nextDates.reduce(function(min, d) {
                        return d < min ? d : min;
                    });
                }
            }

            // Fall back to day-of-month behavior
            var days = (scheduleConfig && scheduleConfig.days) ? scheduleConfig.days : scheduledCheckDays;
            var sortedDays = days.slice().sort(function(a, b) { return a - b; });

            // Find the next check day
            for (var i = 0; i < sortedDays.length; i++) {
                if (sortedDays[i] > currentDay) {
                    // Next check is this month
                    return new Date(currentYear, currentMonth, sortedDays[i], 0, 0, 0);
                }
            }

            // Next check is next month (first scheduled day)
            var nextMonth = currentMonth + 1;
            var nextYear = currentYear;
            if (nextMonth > 11) {
                nextMonth = 0;
                nextYear++;
            }
            return new Date(nextYear, nextMonth, sortedDays[0], 0, 0, 0);
        }

        function formatCountdown(targetDate) {
            var now = new Date();
            var diff = targetDate - now;

            if (diff <= 0) {
                return { text: 'Check imminent', urgent: true };
            }

            var days = Math.floor(diff / (1000 * 60 * 60 * 24));
            var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            var parts = [];
            if (days > 0) parts.push(days + 'd');
            if (hours > 0 || days > 0) parts.push(hours + 'h');
            parts.push(minutes + 'm');

            var urgent = days === 0 && hours < 12;
            var warning = days <= 2;

            return {
                text: parts.join(' '),
                urgent: urgent,
                warning: warning,
                days: days
            };
        }

        function updateCountdownDisplay() {
            var nextCheck = getNextScheduledCheck();
            var countdown = formatCountdown(nextCheck);

            var dateStr = nextCheck.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            var colorClass = countdown.urgent ? 'text-red-500' : countdown.warning ? 'text-yellow-400' : 'text-green-500';

            // Build the display string - show schedule description if available
            var scheduleDesc = '';
            if (scheduleConfig && scheduleConfig.description) {
                scheduleDesc = ' <span class="text-gray-500 text-xs">(' + escapeHtml(scheduleConfig.description) + ')</span>';
            }

            var html = '<span class="' + colorClass + ' font-mono font-bold">' + countdown.text + '</span> <span class="text-gray-400">(' + dateStr + ')</span>' + scheduleDesc;

            // Update both dashboard and asset detail countdown elements
            var dashboardEl = document.getElementById('next-check-countdown');
            var assetEl = document.getElementById('asset-next-check-countdown');

            if (dashboardEl) dashboardEl.innerHTML = html;
            if (assetEl) assetEl.innerHTML = html;
        }

        function startCountdownTimer() {
            // Clear any existing interval
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            // Update immediately
            updateCountdownDisplay();
            // Update every minute
            countdownInterval = setInterval(updateCountdownDisplay, 60000);
        }

        function formatFieldPath(fieldPath) {
            // Special handling for asset name changes (rename requests)
            if (fieldPath === '__asset_name__') {
                return 'üè∑Ô∏è Asset Name (FQDN)';
            }
            return fieldPath;
        }

        function getTimestamp() {
            return new Date().toISOString().replace('T', ' ').substring(0, 19);
        }

        function getGroupById(id) {
            for (var i = 0; i < groups.length; i++) {
                if (groups[i].id === id) return groups[i];
            }
            return { id: 'unknown', name: 'Unknown', color: '#6b7280' };
        }

        function getGroupClasses(groupId) {
            // Muted, cohesive colors for dark mode
            var colors = {
                'server': { bg: 'bg-slate-600', text: 'text-slate-100', border: 'border-slate-400', solid: 'bg-slate-500', ring: 'ring-slate-400' },
                'desktop': { bg: 'bg-slate-700', text: 'text-slate-200', border: 'border-slate-500', solid: 'bg-slate-600', ring: 'ring-slate-500' },
                'network': { bg: 'bg-blue-900', text: 'text-blue-100', border: 'border-blue-600', solid: 'bg-blue-700', ring: 'ring-blue-600' },
                'telecom': { bg: 'bg-amber-800', text: 'text-amber-100', border: 'border-amber-500', solid: 'bg-amber-800', ring: 'ring-amber-500' }
            };
            return colors[groupId] || { bg: 'bg-gray-700', text: 'text-gray-100', border: 'border-gray-500', solid: 'bg-gray-700', ring: 'ring-gray-500' };
        }

        function flattenObject(obj, prefix) {
            var entries = [];
            prefix = prefix || '';
            for (var key in obj) {
                var newKey = prefix ? prefix + '.' + key : key;
                if (obj[key] && typeof obj[key] === 'object' && !Array.isArray(obj[key])) {
                    entries = entries.concat(flattenObject(obj[key], newKey));
                } else {
                    entries.push({ path: newKey, value: obj[key] });
                }
            }
            return entries;
        }

        function formatValue(value) {
            if (value === null || value === undefined) return 'null';
            if (typeof value === 'object') return JSON.stringify(value, null, 2);
            return String(value);
        }

        function showConfirmDialog(title, message) {
            return new Promise(function(resolve) {
                var dialog = document.getElementById('confirm-dialog');
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                dialog.classList.remove('hidden');

                document.getElementById('confirm-ok').onclick = function() {
                    dialog.classList.add('hidden');
                    resolve(true);
                };
                document.getElementById('confirm-cancel').onclick = function() {
                    dialog.classList.add('hidden');
                    resolve(false);
                };
            });
        }

        function showPromptDialog(title, message, placeholder) {
            return new Promise(function(resolve) {
                var modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 border border-gray-600">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-white mb-2">${escapeHtml(title)}</h3>
                            <p class="text-gray-300 text-sm mb-4">${escapeHtml(message)}</p>
                            <input type="text" id="prompt-input" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="${escapeHtml(placeholder || '')}">
                        </div>
                        <div class="flex justify-end gap-3 p-4 border-t border-gray-700">
                            <button id="prompt-cancel" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500">Cancel</button>
                            <button id="prompt-ok" class="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-600">Submit</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                var input = document.getElementById('prompt-input');
                input.focus();

                function cleanup(result) {
                    document.body.removeChild(modal);
                    resolve(result);
                }

                document.getElementById('prompt-ok').onclick = function() {
                    cleanup(input.value);
                };
                document.getElementById('prompt-cancel').onclick = function() {
                    cleanup(null);
                };
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') cleanup(input.value);
                });
            });
        }

        function showDeleteConfirmDialog(assetName) {
            return new Promise(function(resolve) {
                var modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 border border-red-600">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-red-500 mb-4">‚ö†Ô∏è Delete Asset</h3>
                            <p class="text-white mb-2">You are about to permanently delete:</p>
                            <p class="text-yellow-400 font-mono text-sm mb-4 bg-gray-900 p-2 rounded">${escapeHtml(assetName)}</p>

                            <div class="bg-gray-900 border border-gray-700 rounded p-3 mb-4">
                                <p class="text-amber-500 text-sm font-medium mb-2">‚ö†Ô∏è Important:</p>
                                <ul class="text-gray-300 text-sm space-y-1">
                                    <li>‚Ä¢ This action <strong class="text-red-500">cannot be undone</strong></li>
                                    <li>‚Ä¢ All baselines and changes will be deleted</li>
                                    <li>‚Ä¢ Audit logs will be <strong class="text-green-500">preserved</strong> for compliance</li>
                                </ul>
                            </div>

                            <label class="block text-gray-300 text-sm mb-2">Enter your password to confirm:</label>
                            <input type="password" id="delete-password-input"
                                   class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded text-white focus:ring-2 focus:ring-red-500 focus:border-red-500"
                                   placeholder="Your password">
                            <p id="delete-error" class="text-red-500 text-sm mt-2 hidden"></p>
                        </div>
                        <div class="flex justify-end gap-3 p-4 border-t border-gray-700">
                            <button id="delete-cancel" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500">Cancel</button>
                            <button id="delete-confirm" class="px-4 py-2 bg-red-800 text-white rounded hover:bg-red-600 font-medium">Delete Permanently</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                var input = document.getElementById('delete-password-input');
                var errorEl = document.getElementById('delete-error');
                input.focus();

                function cleanup(result) {
                    document.body.removeChild(modal);
                    resolve(result);
                }

                document.getElementById('delete-confirm').onclick = function() {
                    var password = input.value.trim();
                    if (!password) {
                        errorEl.textContent = 'Password is required';
                        errorEl.classList.remove('hidden');
                        return;
                    }
                    cleanup(password);
                };
                document.getElementById('delete-cancel').onclick = function() {
                    cleanup(null);
                };
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        var password = input.value.trim();
                        if (password) cleanup(password);
                    }
                });
                modal.onclick = function(e) {
                    if (e.target === modal) cleanup(null);
                };
            });
        }

        function showChangelog() {
            var modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.onclick = function(e) {
                if (e.target === modal) document.body.removeChild(modal);
            };

            var changelogHtml = CHANGELOG.map(function(release) {
                var changesHtml = release.changes.map(function(c) {
                    return '<li class="text-gray-300 text-sm">' + escapeHtml(c) + '</li>';
                }).join('');
                return `
                    <div class="mb-6 last:mb-0">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-lg font-bold text-amber-500">v${release.version}</span>
                            <span class="text-sm text-gray-500">${release.date}</span>
                        </div>
                        <ul class="list-disc list-inside space-y-1 ml-2">
                            ${changesHtml}
                        </ul>
                    </div>
                `;
            }).join('<hr class="border-gray-600 my-4">');

            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col border border-gray-600">
                    <div class="flex justify-between items-center p-4 border-b border-gray-600">
                        <h3 class="text-xl font-semibold text-white">Fiducia Changelog</h3>
                        <button id="changelog-close" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <div class="p-6 overflow-auto flex-1">
                        ${changelogHtml}
                    </div>
                    <div class="p-4 border-t border-gray-600 text-center">
                        <p class="text-gray-500 text-sm">CIP-010 Baseline Configuration Management</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('changelog-close').onclick = function() {
                document.body.removeChild(modal);
            };
        }

        function showValueModal(fieldName, value) {
            var modal = document.getElementById('value-modal');
            if (!modal) {
                // Create modal if it doesn't exist
                modal = document.createElement('div');
                modal.id = 'value-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
                modal.innerHTML = `
                    <div class="bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col border border-gray-600">
                        <div class="flex justify-between items-center p-4 border-b border-gray-600">
                            <h3 id="value-modal-title" class="text-lg font-semibold text-white"></h3>
                            <button id="value-modal-close" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div class="p-4 overflow-auto flex-1">
                            <pre id="value-modal-content" class="text-sm text-gray-200 bg-gray-900 p-4 rounded font-mono whitespace-pre-wrap break-all"></pre>
                        </div>
                        <div class="p-4 border-t border-gray-600 flex justify-end gap-3">
                            <button id="value-modal-copy" class="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-600 text-sm">Copy to Clipboard</button>
                            <button id="value-modal-close-btn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('value-modal-title').textContent = fieldName;
            document.getElementById('value-modal-content').textContent = value;
            modal.classList.remove('hidden');

            document.getElementById('value-modal-close').onclick = function() {
                modal.classList.add('hidden');
            };
            document.getElementById('value-modal-close-btn').onclick = function() {
                modal.classList.add('hidden');
            };
            document.getElementById('value-modal-copy').onclick = function() {
                navigator.clipboard.writeText(value).then(function() {
                    var btn = document.getElementById('value-modal-copy');
                    var originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    btn.className = 'px-4 py-2 bg-green-800 text-white rounded text-sm';
                    setTimeout(function() {
                        btn.textContent = originalText;
                        btn.className = 'px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-600 text-sm';
                    }, 1500);
                });
            };
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            };
        }

        function showInvestigationModal() {
            return new Promise(function(resolve) {
                var modal = document.getElementById('investigation-modal');
                document.getElementById('investigation-notes').value = '';
                modal.classList.remove('hidden');
                
                document.getElementById('investigation-confirm').onclick = function() {
                    var notes = document.getElementById('investigation-notes').value.trim();
                    modal.classList.add('hidden');
                    resolve(notes || 'Investigation opened');
                };
                document.getElementById('investigation-cancel').onclick = function() {
                    modal.classList.add('hidden');
                    resolve(null);
                };
            });
        }

        function showReport(title, content, auditLogId, reportType) {
            document.getElementById("report-title").textContent = title;
            document.getElementById("report-content").textContent = content;
            document.getElementById("report-modal").classList.remove("hidden");
            
            var pdfBtn = document.getElementById("report-download-pdf");
            if (auditLogId) {
                pdfBtn.classList.remove("hidden");
                pdfBtn.onclick = async function() {
                    try {
                        // Choose endpoint based on report type
                        var endpoint = reportType === 'promotion' 
                            ? "/api/reports/promotion-pdf/" + auditLogId
                            : "/api/reports/investigation-closure-pdf/" + auditLogId;
                        var response = await fetch(endpoint, {
                            headers: { "Authorization": "Bearer " + localStorage.getItem("cip010_token") }
                        });
                        if (!response.ok) {
                            var err = await response.json();
                            throw new Error(err.detail || "PDF generation failed");
                        }
                        var blob = await response.blob();
                        var a = document.createElement("a");
                        a.href = URL.createObjectURL(blob);
                        var filename = reportType === 'promotion' 
                            ? "Baseline_Promotion_" + new Date().toISOString().slice(0,10) + ".pdf"
                            : "Investigation_Closure_" + new Date().toISOString().slice(0,10) + ".pdf";
                        a.download = filename;
                        a.click();
                    } catch (err) {
                        alert("Error downloading PDF: " + err.message);
                    }
                };
            } else {
                pdfBtn.classList.add("hidden");
            }
            
            document.getElementById("report-close").onclick = function() {
                document.getElementById("report-modal").classList.add("hidden");
            };
            document.getElementById("report-copy").onclick = function() {
                navigator.clipboard.writeText(content).then(function() {
                    alert("Copied to clipboard!");
                });
            };
            document.getElementById("report-download").onclick = function() {
                var blob = new Blob([content], { type: "text/plain" });
                var a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = "CIP010_report_" + getTimestamp().replace(/[: ]/g, "_") + ".txt";
                a.click();
            };
        }

        async function showGroupModal(assetName, assetId) {
            return new Promise(function(resolve) {
                var modal = document.getElementById('group-modal');
                document.getElementById('group-modal-asset').textContent = 'Asset: ' + assetName;

                // Clear ticket input
                var ticketInput = document.getElementById('group-modal-ticket');
                ticketInput.value = '';

                var html = '';
                for (var i = 0; i < groups.length; i++) {
                    var g = groups[i];
                    var classes = getGroupClasses(g.id);
                    html += '<button data-group="' + g.id + '" class="group-select-btn w-full px-4 py-3 text-left rounded-lg border-2 border-gray-600 hover:border-tva-blue hover:bg-blue-900/30 flex items-center gap-3">';
                    html += '<span class="w-4 h-4 rounded-full ' + classes.solid + '"></span>';
                    html += '<span class="font-medium">' + escapeHtml(g.name) + '</span></button>';
                }
                document.getElementById('group-options').innerHTML = html;
                modal.classList.remove('hidden');

                var buttons = document.querySelectorAll('.group-select-btn');
                buttons.forEach(function(btn) {
                    btn.addEventListener('click', async function() {
                        var groupId = this.getAttribute('data-group');
                        var ticketNumber = ticketInput.value.trim();

                        // Validate ticket number is provided
                        if (!ticketNumber) {
                            alert('Ticket number is required to establish the initial baseline.\n\nPlease enter a change management ticket number.');
                            ticketInput.focus();
                            return;
                        }

                        modal.classList.add('hidden');

                        if (assetId) {
                            try {
                                await api('/api/assets/' + assetId + '/group', {
                                    method: 'PUT',
                                    body: { group_id: groupId, ticket_number: ticketNumber }
                                });
                            } catch (err) {
                                alert('Error assigning group: ' + err.message);
                            }
                        }
                        resolve({ groupId: groupId, ticketNumber: ticketNumber });
                    });
                });
            });
        }

        // ============================================================
        // REPORT GENERATION
        // ============================================================

        function generateReportHeader(title) {
            return [
                '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                '            ' + title,
                '            ' + APP_NAME + ' v' + APP_VERSION,
                '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                '',
                'Timestamp:    ' + getTimestamp(),
                currentUser ? 'User:         ' + currentUser.full_name + ' (' + currentUser.username + ')' : 'User:         Anonymous (not logged in)',
                currentUser && currentUser.group_id ? 'Group:        ' + getGroupById(currentUser.group_id).name : '',
                ''
            ].filter(function(line) { return line !== ''; }).join('\n');
        }

        function generateReportFooter() {
            return [
                '',
                '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                '                    END OF REPORT',
                '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
            ].join('\n');
        }

        function generateInitialBaselineReport(asset, config, groupName, ticketNumber) {
            var entries = flattenObject(config);
            var lines = [
                generateReportHeader('INITIAL BASELINE PROMOTION REPORT'),
                '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                'ASSET INFORMATION',
                '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                'Asset Name:   ' + asset.asset_name,
                'Assigned To:  ' + groupName,
                'FQDN:         ' + (asset.fqdn || 'N/A'),
                'Version:      ' + (asset.version || 'N/A'),
                ticketNumber ? 'Ticket #:     ' + ticketNumber : '',
                '',
                '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                'BASELINE CONFIGURATION (' + entries.length + ' variables)',
                '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                ''
            ].filter(function(line) { return line !== ''; });
            
            entries.forEach(function(entry) {
                lines.push('  ' + entry.path);
                lines.push('    Value: ' + formatValue(entry.value));
                lines.push('');
            });
            
            lines.push('');
            lines.push('‚úÖ INITIAL BASELINE ESTABLISHED');
            lines.push('   This configuration is now the approved baseline.');
            lines.push(generateReportFooter());
            
            return lines.join('\n');
        }

        function generateChangeReviewReport(change, assets, status, notes, ticketNumber) {
            // Enhance change with array diff if applicable
            var enhanced = enhanceChangeWithArrayDiff(change);

            var statusText = status === 'approved' ? '‚úÖ APPROVED' :
                            status === 'rejected' ? '‚ùå REJECTED' : 'üîç INVESTIGATION OPENED';

            var lines = [
                generateReportHeader(status.toUpperCase() + ' REPORT'),
                '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                'DECISION: ' + statusText,
                ticketNumber ? 'TICKET #: ' + ticketNumber : '',
                '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                ''
            ].filter(function(line) { return line !== ''; });
            
            if (assets && assets.length > 0) {
                lines.push('Affected Assets (' + assets.length + '):');
                assets.forEach(function(a) {
                    var g = a.group_id ? getGroupById(a.group_id).name : 'Unassigned';
                    lines.push('  ‚Ä¢ ' + a.asset_name + ' (' + g + ')');
                });
                lines.push('');
            }
            
            lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            lines.push('CHANGE DETAILS');
            lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            lines.push('Field:        ' + formatFieldPath(enhanced.field_path));
            lines.push('Change Type:  ' + enhanced.change_type.toUpperCase().replace('_', ' '));
            lines.push('');
            
            if (enhanced.change_type === 'array_modified') {
                if (enhanced.items_added && enhanced.items_added.length > 0) {
                    lines.push('‚ûï ADDED (' + enhanced.items_added.length + ' items):');
                    enhanced.items_added.forEach(function(item) {
                        lines.push('  + ' + formatArrayItem(item));
                    });
                    lines.push('');
                }
                if (enhanced.items_removed && enhanced.items_removed.length > 0) {
                    lines.push('‚ûñ REMOVED (' + enhanced.items_removed.length + ' items):');
                    enhanced.items_removed.forEach(function(item) {
                        lines.push('  - ' + formatArrayItem(item));
                    });
                    lines.push('');
                }
            } else {
                if (enhanced.old_value !== null && enhanced.old_value !== undefined) {
                    lines.push('Old Value:    ' + JSON.stringify(enhanced.old_value));
                }
                if (enhanced.new_value !== null && enhanced.new_value !== undefined) {
                    lines.push('New Value:    ' + JSON.stringify(enhanced.new_value));
                }
                lines.push('');
            }
            
            if (notes) {
                lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                lines.push('NOTES');
                lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                lines.push(notes);
                lines.push('');
            }
            
            if (status === 'approved') {
                lines.push('');
                lines.push('BASELINE UPDATED - New configuration promoted to baseline.');
            } else if (status === 'rejected') {
                lines.push('');
                lines.push('‚ö†Ô∏è  BASELINE UNCHANGED - Requires remediation.');
                lines.push('    The detected change was not authorized and must be');
                lines.push('    investigated and corrected.');
            } else if (status === 'investigation') {
                lines.push('');
                lines.push('üîç INVESTIGATION REQUIRED');
                lines.push('    This change requires further analysis before a decision');
                lines.push('    can be made. Investigation timer started.');
            }
            
            lines.push(generateReportFooter());
            return lines.join('\n');
        }

        function generateBulkFinalizeReport(results) {
            // If the API returned a promotion_summary, use it directly
            if (results.promotion_summary) {
                return results.promotion_summary;
            }

            // Fallback to building our own report
            var lines = [
                generateReportHeader('BASELINE PROMOTION SUMMARY'),
                '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                'SUMMARY',
                '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                'Assets Finalized: ' + results.finalized_assets.length,
                'Total Changes:    ' + results.finalized_assets.reduce(function(sum, a) { return sum + a.changes_finalized; }, 0),
                ''
            ];

            if (results.finalized_assets.length > 0) {
                results.finalized_assets.forEach(function(asset) {
                    lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                    lines.push('ASSET: ' + asset.name);
                    if (asset.fqdn) lines.push('FQDN:  ' + asset.fqdn);
                    if (asset.group) lines.push('Group: ' + asset.group);
                    lines.push('Changes Approved: ' + asset.changes_finalized);
                    lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

                    if (asset.changes && asset.changes.length > 0) {
                        asset.changes.forEach(function(change) {
                            lines.push('');
                            lines.push('  Field: ' + change.field);
                            lines.push('  Type:  ' + change.change_type);

                            var oldVal = change.old_value;
                            var newVal = change.new_value;

                            // Format arrays
                            if (Array.isArray(oldVal)) oldVal = oldVal.join(', ');
                            if (Array.isArray(newVal)) newVal = newVal.join(', ');

                            if (oldVal !== null && oldVal !== undefined) {
                                lines.push('  Old:   ' + oldVal);
                            }
                            if (newVal !== null && newVal !== undefined) {
                                lines.push('  New:   ' + newVal);
                            }

                            if (change.ticket_number) {
                                lines.push('  Ticket #: ' + change.ticket_number);
                            }
                            if (change.approved_by) {
                                lines.push('  Approved By: ' + change.approved_by + ' at ' + (change.approved_at || 'N/A'));
                            }
                            if (change.resolution_notes) {
                                lines.push('  Notes: ' + change.resolution_notes);
                            }
                        });
                    }
                    lines.push('');
                });
            }

            lines.push('‚úÖ All approved changes have been promoted to baseline.');
            lines.push(generateReportFooter());

            return lines.join('\n');
        }

        // ============================================================
        // RENDER
        // ============================================================

        function render() {
            var app = document.getElementById('app');
            
            switch (currentView) {
                case 'login':
                    renderLogin(app);
                    break;
                case 'dashboard':
                    renderAppContainer(app, renderDashboard);
                    break;
                case 'assets':
                    renderAppContainer(app, renderAssets);
                    break;
                case 'assetDetail':
                    renderAppContainer(app, renderAssetDetail);
                    break;
                case 'newAssetReview':
                    renderAppContainer(app, renderNewAssetReview);
                    break;
                case 'review':
                    renderAppContainer(app, renderReview);
                    break;
                case 'compare':
                    renderManualCompare(app);
                    break;
                case 'settings':
                    renderAppContainer(app, renderSettings);
                    break;
                case 'compliance':
                    renderAppContainer(app, renderCompliance);
                    break;
                case 'help':
                    renderAppContainer(app, renderHelp);
                    break;
            }
        }

        // ============================================================
        // LOGIN VIEW
        // ============================================================

        function renderLogin(container) {
            container.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center p-4" style="background: linear-gradient(135deg, #1a365d 0%, #1e293b 50%, #0f172a 100%);">
                    <!-- Main Hero Section -->
                    <div class="rounded-xl p-8 w-full max-w-4xl mb-8 text-center shadow-2xl" style="background: linear-gradient(180deg, #e8ecf1 0%, #dce2e9 100%); border: 3px solid #1e40af;">

                        <!-- Fiducia Logo -->
                        <div class="mb-6">
                            <img src="/fiducia-logo.jpg" alt="Fiducia - Infrastructure Baseline Management" class="h-80 mx-auto">
                        </div>

                        <!-- Version -->
                        <p class="text-lg text-amber-600 font-semibold mb-4"><span onclick="showChangelog()" class="cursor-pointer hover:underline" title="View changelog">v${APP_VERSION}</span> <span class="text-slate-500 font-normal">by Michael Wooten</span></p>

                        <!-- Subtitle -->
                        <div class="border-t-2 border-blue-700 pt-4 mt-4 mb-6">
                            <p class="text-slate-600">
                                Your all-in-one change detection, approval, and promotion tool.
                            </p>
                        </div>

                        <!-- Login Card -->
                        <div class="max-w-sm mx-auto mt-6">
                            <div class="bg-blue-900 border-2 border-blue-700 rounded-lg shadow-xl p-6 text-left">
                                <h3 class="text-xl font-bold text-amber-500 mb-4 text-center">
                                    üîê SYSTEM ACCESS
                                </h3>

                                <div id="login-error" class="hidden mb-4 p-3 bg-red-900/80 border border-red-500 text-red-200 rounded text-sm"></div>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-1">Username</label>
                                        <input type="text" id="login-username" class="w-full px-4 py-2 bg-gray-700 border-2 border-gray-500 rounded-lg text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="Enter username">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-300 mb-1">Password</label>
                                        <input type="password" id="login-password" class="w-full px-4 py-2 bg-gray-700 border-2 border-gray-500 rounded-lg text-white focus:ring-2 focus:ring-amber-500 focus:border-amber-500" placeholder="Enter password">
                                    </div>
                                    <button id="login-btn" class="w-full py-3 bg-gradient-to-r from-amber-500 to-amber-600 text-slate-900 font-bold rounded-lg hover:from-amber-400 hover:to-amber-500 transition-all shadow-lg">
                                        LOGIN
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="text-slate-400 text-xs mt-6">CIP-010 Compliance Engine</p>
                </div>
            `;
            
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('login-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
        }

        async function handleLogin() {
            var username = document.getElementById('login-username').value.trim();
            var password = document.getElementById('login-password').value;
            var errorDiv = document.getElementById('login-error');
            
            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            try {
                var formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);
                
                var response = await fetch(API_BASE + '/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Invalid username or password');
                }
                
                var tokenData = await response.json();
                authToken = tokenData.access_token;

                var user = await api('/api/auth/me');
                saveAuth(authToken, user);

                groups = await api('/api/system/groups');

                // Set initial group selection based on user permissions
                initDashboardGroupSelection();

                currentView = 'dashboard';
                render();
                
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.classList.remove('hidden');
            }
        }

        // ============================================================
        // APP CONTAINER
        // ============================================================

        function renderAppContainer(container, contentRenderer) {
            var groupBadge = '';
            if (currentUser.group_id) {
                var gc = getGroupClasses(currentUser.group_id);
                var g = getGroupById(currentUser.group_id);
                groupBadge = '<span class="ml-2 px-2 py-1 text-xs rounded ' + gc.bg + ' ' + gc.text + '">' + escapeHtml(g.name) + '</span>';
            } else if (currentUser.role === 'admin') {
                groupBadge = '<span class="ml-2 px-2 py-1 text-xs rounded bg-yellow-900 text-amber-400 border border-amber-700">Admin</span>';
            }
            
            container.innerHTML = `
                <div class="min-h-screen" style="background: linear-gradient(180deg, #1a1f2e 0%, #1f2937 100%);">
                    <nav class="shadow-lg" style="background: linear-gradient(90deg, #1e3a5f 0%, #1e40af 100%);">
                        <div class="container mx-auto px-4">
                            <div class="flex justify-between items-center h-16">
                                <div class="flex items-center gap-4">
                                    <div>
                                        <h1 class="text-lg font-bold text-white">Fiducia</h1>
                                        <p class="text-xs text-slate-300">Infrastructure Baseline Management</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-amber-300 cursor-pointer hover:underline" onclick="showChangelog()" title="View changelog">v${APP_VERSION}</p>
                                    </div>
                                </div>

                                <div class="flex items-center gap-2">
                                    <button id="nav-dashboard" class="px-3 py-2 rounded text-sm border transition-all ${currentView === 'dashboard' ? 'bg-amber-600 text-white border-amber-400 font-semibold' : 'text-white hover:bg-blue-800 border-transparent hover:border-amber-400'}">Dashboard</button>
                                    <button id="nav-assets" class="px-3 py-2 rounded text-sm border transition-all ${currentView === 'assets' || currentView === 'assetDetail' ? 'bg-amber-600 text-white border-amber-400 font-semibold' : 'text-white hover:bg-blue-800 border-transparent hover:border-amber-400'}">Assets</button>
                                    <button id="nav-compliance" class="px-3 py-2 rounded text-sm border transition-all ${currentView === 'compliance' || currentView === 'compare' ? 'bg-amber-600 text-white border-amber-400 font-semibold' : 'text-white hover:bg-blue-800 border-transparent hover:border-amber-400'}">Compliance</button>
                                    ${currentUser.role === 'admin' ? '<button id="nav-settings" class="px-3 py-2 rounded text-sm border transition-all ' + (currentView === 'settings' ? 'bg-amber-600 text-white border-amber-400 font-semibold' : 'text-white hover:bg-blue-800 border-transparent hover:border-amber-400') + '">Settings</button>' : ''}
                                    <button id="nav-help" class="px-3 py-2 rounded text-sm border transition-all ${currentView === 'help' ? 'bg-amber-600 text-white border-amber-400 font-semibold' : 'text-white hover:bg-blue-800 border-transparent hover:border-amber-400'}">Help</button>
                                </div>

                                <div class="flex items-center gap-4">
                                    <span class="text-sm text-slate-200">${escapeHtml(currentUser.full_name)}${groupBadge}</span>
                                    <button id="logout-btn" class="px-4 py-2 bg-gray-600 text-slate-200 rounded hover:bg-gray-500 transition-all">Logout</button>
                                </div>
                            </div>
                        </div>
                    </nav>
                    
                    <div class="container mx-auto px-4 py-8 max-w-screen-2xl">
                        <div id="main-content"></div>
                    </div>
                </div>
            `;
            
            document.getElementById('logout-btn').addEventListener('click', function() {
                clearAuth();
                currentView = 'login';
                render();
            });
            document.getElementById('nav-dashboard').addEventListener('click', function() {
                filterGroup = null;
                currentView = 'dashboard';
                render();
            });
            document.getElementById('nav-assets').addEventListener('click', function() {
                filterGroup = null;
                currentView = 'assets';
                render();
            });
            document.getElementById('nav-compliance').addEventListener('click', function() {
                currentView = 'compliance';
                render();
            });
            if (currentUser.role === 'admin') {
                document.getElementById('nav-settings').addEventListener('click', function() {
                    currentView = 'settings';
                    render();
                });
            }
            document.getElementById('nav-help').addEventListener('click', function() {
                currentView = 'help';
                render();
            });

            contentRenderer(document.getElementById('main-content'));
        }

        // ============================================================
        // DASHBOARD VIEW
        // ============================================================

        async function renderDashboard(container) {
            container.innerHTML = '<div class="text-center py-12"><p class="text-gray-400">Loading dashboard...</p></div>';

            try {
                var stats = await api('/api/system/stats');
                var pendingChanges = await api('/api/changes/pending');
                var groupedData = await api('/api/changes/grouped');
                var assets = await api('/api/assets');

                // Load config for scheduled check days
                try {
                    var config = await api('/api/system/config');
                    if (config.scheduled_check_days && config.scheduled_check_days.length > 0) {
                        scheduledCheckDays = config.scheduled_check_days;
                    }
                    // Load full schedule configuration (new format)
                    if (config.schedule_config) {
                        scheduleConfig = config.schedule_config;
                    }
                } catch (e) {
                    console.log('Could not load config, using default schedule');
                }

                newAssetsQueue = assets.filter(function(a) { return !a.group_id; });

                // Enhance changes with array diff
                var grouped = (groupedData.grouped_changes || []).map(enhanceChangeWithArrayDiff);
                var assetSpecific = (groupedData.asset_specific_changes || []).map(enhanceChangeWithArrayDiff);

                // Separate investigation changes from regular pending changes
                // Use CHANGE STATUS (not asset state) to determine queue placement
                var investigationChanges = [];
                var regularAssetSpecific = [];
                assetSpecific.forEach(function(item) {
                    // Check if ANY of the changes in this group have investigation status
                    var hasInvestigationChange = item.assets && item.assets.some(function(a) {
                        return a.change_status === 'investigation';
                    });
                    if (hasInvestigationChange) {
                        investigationChanges.push(item);
                    } else {
                        regularAssetSpecific.push(item);
                    }
                });
                assetSpecific = regularAssetSpecific;

                var allChanges = grouped.concat(assetSpecific);

                // Initialize review decisions and ticket numbers (include investigation changes)
                allChanges.concat(investigationChanges).forEach(function(item) {
                    if (!reviewDecisions[item.signature]) {
                        reviewDecisions[item.signature] = 'pending';
                    }
                    // Pre-populate ticket numbers from existing data (if not already set locally)
                    if (!investigationTickets[item.signature] && item.assets) {
                        var existingTicket = item.assets.find(function(a) { return a.ticket_number; });
                        if (existingTicket) {
                            investigationTickets[item.signature] = existingTicket.ticket_number;
                        }
                    }
                });

                // Filter changes by selected group
                var filteredChanges = allChanges;
                if (dashboardSelectedGroup !== 'all') {
                    filteredChanges = allChanges.filter(function(item) {
                        return item.assets && item.assets.some(function(a) {
                            return a.group_id === dashboardSelectedGroup;
                        });
                    });
                }

                // Get pending count for selected group
                var filteredPendingCount = dashboardSelectedGroup === 'all'
                    ? pendingChanges.length
                    : (stats.pending_by_group[dashboardSelectedGroup] || 0);

                var html = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold" style="font-family: 'Rajdhani', sans-serif; letter-spacing: 0.05em; color: #60a5fa;">‚ö° Dashboard</h2>
                        <button id="quick-start-btn" class="px-4 py-2 bg-green-700 hover:bg-green-800 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2">
                            <span>üìñ</span> Quick Start Guide
                        </button>
                    </div>
                `;

                // Check user permissions for group viewing
                var canViewAll = userCanViewAllGroups();

                // Group selector tabs
                html += '<div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">';

                // "All Assets" tab - only for admin/super users
                if (canViewAll) {
                    var selectedAllClass = dashboardSelectedGroup === 'all' ? 'ring-2 ring-blue-400 bg-gray-600' : 'bg-gray-700 hover:bg-gray-600';
                    html += `
                        <div class="group-tab cursor-pointer rounded-lg p-4 shadow-lg border-t-4 border-blue-500 transition-all ${selectedAllClass}" data-group="all">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-2xl font-bold text-blue-400">${stats.total_assets}</p>
                                    <p class="text-sm text-gray-400">All Assets</p>
                                </div>
                                ${pendingChanges.length > 0 ? '<span class="px-2 py-1 bg-amber-700 text-white text-xs rounded-full">' + pendingChanges.length + '</span>' : ''}
                            </div>
                            <button class="view-assets-btn mt-2 text-xs text-blue-400 hover:text-blue-300" data-filter="all">View Assets ‚Üí</button>
                        </div>
                    `;
                }

                for (var i = 0; i < groups.length; i++) {
                    var g = groups[i];
                    var gc = getGroupClasses(g.id);
                    var count = stats.assets_by_group[g.id] || 0;
                    var pending = stats.pending_by_group[g.id] || 0;

                    // Check if user can access this group
                    var canAccessGroup = canViewAll || (currentUser && currentUser.group_id === g.id);
                    var isSelected = dashboardSelectedGroup === g.id;

                    if (canAccessGroup) {
                        // User can access - show interactive tab
                        var selectedClass = isSelected ? 'ring-2 ring-offset-1 ring-offset-gray-800 ' + gc.ring + ' bg-gray-600' : 'bg-gray-700 hover:bg-gray-600';
                        html += `
                            <div class="group-tab cursor-pointer rounded-lg p-4 shadow-lg border-t-4 ${gc.border} transition-all ${selectedClass}" data-group="${g.id}">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-2xl font-bold ${gc.text}">${count}</p>
                                        <p class="text-sm text-gray-400">${escapeHtml(g.name)}</p>
                                    </div>
                                    ${pending > 0 ? '<span class="px-2 py-1 bg-amber-700 text-white text-xs rounded-full">' + pending + '</span>' : ''}
                                </div>
                                <button class="view-assets-btn mt-2 text-xs ${gc.text} hover:opacity-80" data-filter="${g.id}">View Assets ‚Üí</button>
                            </div>
                        `;
                    } else {
                        // User cannot access - show disabled/view-only tab
                        html += `
                            <div class="rounded-lg p-4 shadow-lg border-t-4 ${gc.border} bg-gray-800 opacity-50" title="You don't have access to this group">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-2xl font-bold text-gray-500">${count}</p>
                                        <p class="text-sm text-gray-500">${escapeHtml(g.name)}</p>
                                    </div>
                                </div>
                                <p class="mt-2 text-xs text-gray-600">üîí Restricted</p>
                            </div>
                        `;
                    }
                }

                html += '</div>';

                // New assets alert (after group tabs, before pending changes)
                if (newAssetsQueue.length > 0) {
                    html += `
                        <div class="bg-gray-700 border border-gray-600 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-200 font-medium">${newAssetsQueue.length} New Asset${newAssetsQueue.length > 1 ? 's' : ''} awaiting initial baseline review</p>
                                </div>
                                <button id="review-new-assets-btn" class="px-4 py-2 bg-gray-600 text-gray-100 rounded text-sm hover:bg-gray-500 font-medium border border-gray-500">
                                    Review & Promote
                                </button>
                            </div>
                        </div>
                    `;
                }

                // Filter investigation changes by selected group
                var filteredInvestigationChanges = investigationChanges;
                if (dashboardSelectedGroup !== 'all') {
                    filteredInvestigationChanges = investigationChanges.filter(function(item) {
                        return item.assets && item.assets.some(function(a) {
                            return a.group_id === dashboardSelectedGroup;
                        });
                    });
                }

                // Investigation Queue Section (before regular pending changes)
                var groupLabel = dashboardSelectedGroup === 'all' ? 'All Groups' : getGroupById(dashboardSelectedGroup).name;

                if (filteredInvestigationChanges.length > 0) {
                    // Group investigation changes by asset
                    var investigationByAsset = {};
                    filteredInvestigationChanges.forEach(function(item) {
                        var assetName = (item.assets && item.assets[0]) ? item.assets[0].asset_name : 'Unknown';
                        var assetId = (item.assets && item.assets[0]) ? item.assets[0].asset_id : 0;
                        var stateChangedAt = (item.assets && item.assets[0]) ? item.assets[0].state_changed_at : null;
                        var key = assetId + '|' + assetName;
                        if (!investigationByAsset[key]) {
                            investigationByAsset[key] = { assetName: assetName, assetId: assetId, stateChangedAt: stateChangedAt, changes: [] };
                        }
                        investigationByAsset[key].changes.push(item);
                    });

                    html += `
                        <div class="mb-6 bg-amber-900/30 border-2 border-amber-500 rounded-lg overflow-hidden">
                            <div class="bg-amber-800/50 px-6 py-4 border-b border-amber-600">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">üîç</span>
                                        <h3 class="text-xl font-bold text-amber-500">Investigation Queue</h3>
                                        <span class="bg-amber-800 text-white px-3 py-1 rounded text-sm font-semibold">${filteredInvestigationChanges.length} Change${filteredInvestigationChanges.length !== 1 ? 's' : ''} Require Resolution</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="inv-revert-all-btn" class="px-3 py-2 bg-amber-800 text-white rounded text-sm hover:bg-amber-700 font-medium">
                                            ‚Ü© Revert All
                                        </button>
                                        <button id="inv-finalize-btn" class="px-4 py-2 bg-green-700 text-white rounded text-sm hover:bg-green-800 font-semibold shadow-lg">
                                            ‚úì Finalize Investigation Changes
                                        </button>
                                    </div>
                                </div>
                                <p class="text-amber-200 text-sm border-l-4 border-amber-500 pl-3 ml-9">
                                    These changes are under active investigation. <strong>Approve or reject all changes</strong> for an asset to close its investigation and return to compliance.
                                </p>
                            </div>
                            <div class="p-4">
                    `;

                    // Render each asset in investigation
                    Object.keys(investigationByAsset).forEach(function(key) {
                        var assetGroup = investigationByAsset[key];
                        var totalChanges = assetGroup.changes.length;
                        var reviewedCount = assetGroup.changes.filter(function(c) {
                            var decision = reviewDecisions[c.signature];
                            return decision === 'approved' || decision === 'rejected';
                        }).length;
                        var progressPct = Math.round((reviewedCount / totalChanges) * 100);
                        var remaining = totalChanges - reviewedCount;

                        // Calculate days in investigation
                        var daysInInvestigation = '';
                        if (assetGroup.stateChangedAt) {
                            var startDate = new Date(assetGroup.stateChangedAt);
                            var now = new Date();
                            var days = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                            daysInInvestigation = days + ' day' + (days !== 1 ? 's' : '') + ' in investigation';
                        }

                        html += `
                            <div class="mb-4 rounded-lg overflow-hidden bg-amber-950/40 border border-amber-600/50">
                                <div class="bg-amber-800/40 px-4 py-3 flex items-center justify-between flex-wrap gap-3 border-b border-amber-600/40">
                                    <div class="flex items-center gap-3">
                                        <span class="text-amber-500 text-lg">üîç</span>
                                        <span class="font-bold text-amber-200">${escapeHtml(assetGroup.assetName)}</span>
                                        <span class="text-xs px-2 py-1 bg-amber-700 text-amber-100 rounded font-semibold">UNDER INVESTIGATION</span>
                                        ${daysInInvestigation ? '<span class="text-xs text-amber-500">' + daysInInvestigation + '</span>' : ''}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="text" class="inv-asset-ticket px-2 py-1 text-xs bg-gray-900 border border-amber-500/50 rounded w-28 text-gray-200 placeholder-gray-500 focus:border-amber-400 focus:outline-none"
                                               data-asset-id="${assetGroup.assetId}" placeholder="Ticket # for all">
                                        <button class="inv-apply-asset-ticket px-3 py-1.5 bg-amber-800 text-white rounded text-xs font-medium hover:bg-amber-700"
                                                data-asset-id="${assetGroup.assetId}">Apply to All</button>
                                    </div>
                                </div>
                                <div class="px-4 py-2 bg-amber-900/20 border-b border-amber-700/30">
                                    <div class="flex items-center gap-3 text-sm">
                                        <span class="text-amber-300">Progress:</span>
                                        <span class="text-amber-200 font-medium inv-progress-text">${reviewedCount} of ${totalChanges} reviewed</span>
                                        <div class="flex-1 max-w-xs bg-amber-950 rounded-full h-2 overflow-hidden">
                                            <div class="inv-progress-bar h-full ${progressPct === 100 ? 'bg-green-700' : 'bg-amber-700'}" style="width: ${progressPct}%"></div>
                                        </div>
                                        <span class="text-xs inv-remaining-text ${remaining === 0 ? 'text-green-500' : 'text-amber-500'}">
                                            ${remaining === 0 ? '‚úì Ready to finalize!' : remaining + ' remaining to close investigation'}
                                        </span>
                                    </div>
                                </div>
                                <div class="px-4 py-3 bg-amber-900/10 border-b border-amber-700/30">
                                    <label class="block text-xs font-semibold text-amber-400 mb-1">Investigation Notes</label>
                                    <textarea class="inv-notes-input w-full px-3 py-2 text-sm bg-gray-900 border border-amber-600/50 rounded text-gray-200 placeholder-gray-500 focus:border-amber-400 focus:outline-none resize-y"
                                              data-asset-id="${assetGroup.assetId}"
                                              rows="2"
                                              placeholder="Document investigation findings, root cause analysis, remediation steps...">${investigationNotes[assetGroup.assetId] || ''}</textarea>
                                    <p class="text-xs text-amber-500/70 mt-1">These notes will be included in the investigation closure report.</p>
                                </div>
                                <div class="p-4 space-y-3">
                        `;

                        // Render each change for this asset
                        assetGroup.changes.forEach(function(item) {
                            var decision = reviewDecisions[item.signature] || 'pending';
                            var statusBg = decision === 'approved' ? 'bg-green-800' : decision === 'rejected' ? 'bg-red-800' : 'bg-gray-600';

                            // Build change value display
                            var valueHtml = '';
                            if (item.change_type === 'array_modified' && (item.items_added || item.items_removed)) {
                                valueHtml = '<div class="space-y-2 my-2">';
                                if (item.items_added && item.items_added.length > 0) {
                                    valueHtml += '<div class="bg-gray-900 border border-gray-700 rounded p-2">';
                                    valueHtml += '<p class="text-xs font-semibold text-emerald-400 mb-1">+ Added (' + item.items_added.length + '):</p>';
                                    item.items_added.forEach(function(addedItem) {
                                        valueHtml += '<div class="font-mono text-xs text-emerald-300 py-0.5">' + escapeHtml(formatArrayItem(addedItem)) + '</div>';
                                    });
                                    valueHtml += '</div>';
                                }
                                if (item.items_removed && item.items_removed.length > 0) {
                                    valueHtml += '<div class="bg-gray-900 border border-gray-700 rounded p-2">';
                                    valueHtml += '<p class="text-xs font-semibold text-rose-400 mb-1">- Removed (' + item.items_removed.length + '):</p>';
                                    item.items_removed.forEach(function(removedItem) {
                                        valueHtml += '<div class="font-mono text-xs text-red-300 py-0.5">' + escapeHtml(formatArrayItem(removedItem)) + '</div>';
                                    });
                                    valueHtml += '</div>';
                                }
                                valueHtml += '</div>';
                            } else {
                                var oldVal = item.old_value ? (typeof item.old_value === 'string' ? item.old_value : JSON.stringify(item.old_value)) : '(none)';
                                var newVal = item.new_value ? (typeof item.new_value === 'string' ? item.new_value : JSON.stringify(item.new_value)) : '(none)';
                                valueHtml = '<div class="grid grid-cols-2 gap-2 my-2 text-xs">' +
                                    '<div class="bg-red-900/30 rounded p-2 border border-red-800"><span class="text-red-500 font-semibold">Old:</span> <code class="text-gray-300">' + escapeHtml(oldVal.substring(0, 100)) + (oldVal.length > 100 ? '...' : '') + '</code></div>' +
                                    '<div class="bg-green-900/30 rounded p-2 border border-green-800"><span class="text-green-500 font-semibold">New:</span> <code class="text-gray-300">' + escapeHtml(newVal.substring(0, 100)) + (newVal.length > 100 ? '...' : '') + '</code></div>' +
                                '</div>';
                            }

                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-3 border border-amber-700/30">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-mono text-sm font-medium text-gray-200">${escapeHtml(formatFieldPath(item.field_path))}</span>
                                        <div class="flex items-center gap-2">
                                            <span class="px-2 py-0.5 text-xs rounded ${statusBg}">${decision}</span>
                                        </div>
                                    </div>
                                    ${valueHtml}
                                    <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-700 flex-wrap">
                                        <input type="text" class="inv-ticket-input px-2 py-1.5 text-xs bg-gray-900 border border-gray-600 rounded w-28 text-gray-200 placeholder-gray-500 focus:border-amber-400 focus:outline-none"
                                               data-signature="${escapeHtml(item.signature)}" placeholder="Ticket #" value="${investigationTickets[item.signature] || ''}">
                                        <button class="inv-approve-btn px-4 py-1.5 rounded text-sm font-medium transition-all ${decision === 'approved' ? 'bg-green-800 text-white' : 'bg-gray-700 text-gray-300 hover:bg-green-600'}"
                                                data-signature="${escapeHtml(item.signature)}" data-change-ids="${item.change_ids.join(',')}">
                                            ‚úì Approve
                                        </button>
                                        ${decision !== 'pending' ? '<button class="inv-revert-btn px-3 py-1.5 rounded text-sm font-medium bg-amber-800 text-white hover:bg-amber-700" data-signature="' + escapeHtml(item.signature) + '">‚Ü© Revert</button>' : ''}
                                        ${investigationTickets[item.signature] ? '<span class="text-xs text-amber-400 italic">Ticket # was pre-filled during investigation creation</span>' : ''}
                                    </div>
                                </div>
                            `;
                        });

                        html += '</div></div>';
                    });

                    html += '</div></div>';
                }

                // Count reviewed investigation changes
                var reviewedInvestigationCount = filteredInvestigationChanges.filter(function(item) {
                    var decision = reviewDecisions[item.signature];
                    return decision === 'approved' || decision === 'rejected';
                }).length;

                // Pending changes section
                var approvedCount = stats.approved_changes || 0;
                var showFinalizeBtn = filteredChanges.length > 0 || approvedCount > 0 || reviewedInvestigationCount > 0;
                html += `
                    <div class="bg-gray-700 rounded-lg shadow-lg p-6 mb-6 border border-gray-600">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-100">
                                Pending Changes - ${escapeHtml(groupLabel)}
                                <span class="ml-2 px-2 py-1 bg-gray-600 text-gray-200 text-sm rounded">${filteredChanges.length}</span>
                                ${approvedCount > 0 ? '<span class="ml-2 px-2 py-1 bg-green-800 text-white text-sm rounded">' + approvedCount + ' approved</span>' : ''}
                                ${reviewedInvestigationCount > 0 ? '<span class="ml-2 px-2 py-1 bg-amber-800 text-white text-sm rounded">' + reviewedInvestigationCount + ' investigation reviewed</span>' : ''}
                            </h3>
                            ${showFinalizeBtn ? '<button id="finalize-all-btn" class="px-4 py-2 bg-green-700 text-white rounded text-sm hover:bg-green-800 font-medium">Finalize Reviewed Changes</button>' : ''}
                        </div>
                `;

                if (filteredChanges.length === 0) {
                    if (approvedCount > 0) {
                        html += `
                            <div class="text-center py-4 mb-4">
                                <p class="text-4xl mb-2 text-green-500">‚úì</p>
                                <p class="text-gray-400 mb-2">No pending changes for ${escapeHtml(groupLabel)}</p>
                            </div>
                            <div id="approved-changes-section">
                                <div class="flex items-center justify-between mb-3 border-b border-gray-600 pb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm font-semibold text-green-500">Approved Changes</span>
                                        <span class="px-2 py-0.5 bg-green-800 text-white text-xs rounded">${approvedCount}</span>
                                        <span class="text-xs text-gray-400">‚Äî ready to finalize (revertible for 24h)</span>
                                    </div>
                                    <button id="revert-all-btn" class="px-3 py-1 bg-amber-800 text-white rounded text-xs hover:bg-amber-700 font-medium">
                                        ‚Ü© Revert All
                                    </button>
                                </div>
                                <div id="approved-changes-list" class="space-y-2 max-h-[300px] overflow-y-auto">
                                    <p class="text-gray-500 text-sm py-2">Loading approved changes...</p>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="text-center py-8 text-gray-500">
                                <p class="text-4xl mb-2 text-green-500">‚úì</p>
                                <p>No pending changes for ${escapeHtml(groupLabel)}</p>
                            </div>
                        `;
                    }
                } else {
                    // Filter changes first so we can show the count
                    var filteredGrouped = grouped.filter(function(item) {
                        if (dashboardSelectedGroup === 'all') return true;
                        return item.assets && item.assets.some(function(a) { return a.group_id === dashboardSelectedGroup; });
                    });

                    var filteredAssetSpecific = assetSpecific.filter(function(item) {
                        if (dashboardSelectedGroup === 'all') return true;
                        return item.assets && item.assets.some(function(a) { return a.group_id === dashboardSelectedGroup; });
                    });

                    // Info banner about per-change timers (v4.0.0)
                    html += `
                        <div class="bg-blue-900/30 border border-blue-500 rounded p-3 mb-4">
                            <p class="text-sm text-blue-200"><strong>‚è∞ Per-Change Timer:</strong> Each change has a 30-day timer from detection. Review and resolve before individual timers expire.</p>
                        </div>
                    `;

                    if (filteredGrouped.length > 0) {
                        html += `
                            <div class="mb-6">
                                <div class="flex items-center gap-2 mb-3 border-b border-gray-600 pb-2">
                                    <span class="text-sm font-semibold text-white">Grouped Changes</span>
                                    <span class="px-2 py-0.5 bg-gray-600 text-gray-200 text-xs rounded">${filteredGrouped.length}</span>
                                    <span class="text-xs text-gray-400">‚Äî identical changes across multiple assets</span>
                                </div>
                                <div class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                        `;
                        filteredGrouped.forEach(function(item) {
                            html += renderDashboardChangeCard(item, true, dashboardSelectedGroup);
                        });
                        html += '</div></div>';
                    }

                    if (filteredAssetSpecific.length > 0) {
                        // Group by asset for dashboard view
                        var dashChangesByAsset = {};
                        filteredAssetSpecific.forEach(function(item) {
                            var assetName = (item.assets && item.assets[0]) ? item.assets[0].asset_name : 'Unknown';
                            var assetId = (item.assets && item.assets[0]) ? item.assets[0].asset_id : 0;
                            var key = assetId + '|' + assetName;
                            if (!dashChangesByAsset[key]) {
                                dashChangesByAsset[key] = { assetName: assetName, assetId: assetId, changes: [] };
                            }
                            dashChangesByAsset[key].changes.push(item);
                        });

                        html += `
                            <div>
                                <div class="flex items-center gap-2 mb-3 border-b border-gray-600 pb-2">
                                    <span class="text-sm font-semibold text-white">Asset-Specific Changes</span>
                                    <span class="px-2 py-0.5 bg-gray-600 text-gray-200 text-xs rounded">${filteredAssetSpecific.length}</span>
                                    <span class="text-xs text-gray-400">‚Äî unique changes to individual assets</span>
                                </div>
                                <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2">
                        `;

                        // Render each asset group (ASSET LEVEL - slate/neutral theme)
                        Object.keys(dashChangesByAsset).forEach(function(key) {
                            var assetGroup = dashChangesByAsset[key];
                            html += `
                                <div class="rounded-lg overflow-hidden bg-gray-800/50">
                                    <div class="bg-slate-700/60 px-3 py-2 flex items-center justify-between flex-wrap gap-2 border-b border-slate-600/50">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-semibold text-slate-400 uppercase tracking-wide">Asset</span>
                                            <span class="text-sm font-medium text-slate-200">${escapeHtml(assetGroup.assetName.split('.')[0])}</span>
                                            <span class="text-xs px-1.5 py-0.5 bg-slate-600 text-slate-300 rounded">${assetGroup.changes.length}</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" class="dash-asset-ticket px-2 py-1 text-xs bg-gray-900 border border-slate-500/50 rounded w-24 text-gray-200 placeholder-gray-500 focus:border-slate-400 focus:outline-none"
                                                   data-asset-id="${assetGroup.assetId}" placeholder="Ticket #">
                                            <button class="dash-apply-asset-ticket px-2 py-1 bg-slate-600 text-slate-200 rounded text-xs hover:bg-slate-500 font-medium"
                                                    data-asset-id="${assetGroup.assetId}">Apply to Asset</button>
                                        </div>
                                    </div>
                                    <div class="p-3 space-y-2">
                            `;
                            assetGroup.changes.forEach(function(item) {
                                html += renderDashboardChangeCard(item, false, dashboardSelectedGroup);
                            });
                            html += `
                                    </div>
                                </div>
                            `;
                        });

                        html += '</div></div>';
                    }

                    // Show approved changes section alongside pending if any approved
                    if (approvedCount > 0) {
                        html += `
                            <div id="approved-changes-section" class="mt-6">
                                <div class="flex items-center justify-between mb-3 border-b border-gray-600 pb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm font-semibold text-green-500">Approved Changes</span>
                                        <span class="px-2 py-0.5 bg-green-800 text-white text-xs rounded">${approvedCount}</span>
                                        <span class="text-xs text-gray-400">‚Äî ready to finalize (revertible for 24h)</span>
                                    </div>
                                    <button id="revert-all-btn" class="px-3 py-1 bg-amber-800 text-white rounded text-xs hover:bg-amber-700 font-medium">
                                        ‚Ü© Revert All
                                    </button>
                                </div>
                                <div id="approved-changes-list" class="space-y-2 max-h-[300px] overflow-y-auto">
                                    <p class="text-gray-500 text-sm py-2">Loading approved changes...</p>
                                </div>
                            </div>
                        `;
                    }
                }

                html += '</div>';

                // Upload section and Active Users (admin only) in a grid
                var isAdmin = currentUser && currentUser.role === 'admin';
                html += `<div class="grid grid-cols-1 ${isAdmin ? 'md:grid-cols-2' : ''} gap-4">`;

                // Upload section
                html += `
                    <div class="bg-gray-700 rounded-lg shadow-lg p-6 border border-gray-700">
                        <h3 class="text-lg font-semibold text-blue-400 mb-4">Upload Baseline Files</h3>
                        <div id="upload-area" class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-amber-700 cursor-pointer transition-all">
                            <p class="text-gray-400 mb-2">Drop JSON files here or click to upload</p>
                            <p class="text-xs text-yellow-400">üìÅ Supports multiple files</p>
                            <input type="file" multiple accept=".json" id="file-input" class="hidden">
                        </div>
                        <div id="upload-results" class="mt-4 hidden"></div>
                    </div>
                `;

                // Active Users section (admin only)
                if (isAdmin) {
                    html += `
                        <div class="bg-gray-700 rounded-lg shadow-lg p-6 border border-gray-700">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-blue-400">Active Sessions</h3>
                                <button id="refresh-active-users" class="text-gray-400 hover:text-blue-400 transition-colors" title="Refresh">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                </button>
                            </div>
                            <div id="active-users-list" class="space-y-2 max-h-[200px] overflow-y-auto">
                                <p class="text-gray-500 text-sm">Loading...</p>
                            </div>
                            <p class="text-xs text-gray-500 mt-3">Users with sessions valid in the last 8 hours</p>
                        </div>
                    `;
                }

                html += '</div>'; // Close grid

                container.innerHTML = html;

                // Start countdown timer for next scheduled check
                startCountdownTimer();

                // Group tab click handlers
                document.querySelectorAll('.group-tab').forEach(function(tab) {
                    tab.addEventListener('click', function(e) {
                        // Don't trigger if clicking the "View Assets" button
                        if (e.target.classList.contains('view-assets-btn')) return;
                        dashboardSelectedGroup = this.getAttribute('data-group');
                        render();
                    });
                });

                // View assets button handlers
                document.querySelectorAll('.view-assets-btn').forEach(function(btn) {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        var filter = this.getAttribute('data-filter');
                        filterGroup = filter === 'all' ? null : filter;
                        currentView = 'assets';
                        render();
                    });
                });

                // Review new assets button
                var reviewNewBtn = document.getElementById('review-new-assets-btn');
                if (reviewNewBtn) {
                    reviewNewBtn.addEventListener('click', function() {
                        if (newAssetsQueue.length > 0) {
                            selectedNewAsset = newAssetsQueue[0];
                            currentView = 'newAssetReview';
                            render();
                        }
                    });
                }

                // Change review button handlers
                setupDashboardChangeHandlers();

                // Quick Start Guide button
                var quickStartBtn = document.getElementById('quick-start-btn');
                if (quickStartBtn) {
                    quickStartBtn.addEventListener('click', function() {
                        showQuickStartGuide();
                    });
                }

                // Active Users (admin only)
                var activeUsersList = document.getElementById('active-users-list');
                if (activeUsersList) {
                    loadActiveUsers();
                    var refreshBtn = document.getElementById('refresh-active-users');
                    if (refreshBtn) {
                        refreshBtn.addEventListener('click', loadActiveUsers);
                    }
                }

                // Finalize button
                var finalizeBtn = document.getElementById('finalize-all-btn');
                if (finalizeBtn) {
                    finalizeBtn.addEventListener('click', async function() {
                        try {
                            // First, submit any local investigation decisions
                            var investigationSubmissions = [];
                            document.querySelectorAll('.inv-approve-btn').forEach(function(btn) {
                                var sig = btn.getAttribute('data-signature');
                                var decision = reviewDecisions[sig];
                                if (decision === 'approved' || decision === 'rejected') {
                                    var changeIds = btn.getAttribute('data-change-ids').split(',').map(Number);
                                    var ticket = investigationTickets[sig] || '';
                                    changeIds.forEach(function(id) {
                                        investigationSubmissions.push({ id: id, status: decision, ticket: ticket });
                                    });
                                }
                            });

                            // Submit investigation decisions to API
                            for (var i = 0; i < investigationSubmissions.length; i++) {
                                var sub = investigationSubmissions[i];
                                await api('/api/changes/' + sub.id + '/review', {
                                    method: 'PUT',
                                    body: { status: sub.status, ticket_number: sub.ticket }
                                });
                            }

                            // Now finalize all approved changes
                            var result = await api('/api/changes/finalize', { method: 'POST' });

                            if (result.finalized_assets.length > 0) {
                                // Clear local investigation data
                                investigationTickets = {};

                                // Generate report BEFORE re-rendering so we have the data
                                var report = generateBulkFinalizeReport(result);

                                // Re-render dashboard immediately to clear approved changes
                                await render();

                                // Now show the report modal on top of the updated dashboard
                                showReport('Baseline Promotion Summary', report, result.audit_log_id, 'promotion');

                                var reportModal = document.getElementById('report-modal');
                                var closeHandler = function() {
                                    reportModal.classList.add('hidden');
                                };
                                document.getElementById('report-close').onclick = closeHandler;
                                reportModal.onclick = function(e) {
                                    if (e.target === reportModal) closeHandler();
                                };
                            } else {
                                alert('No changes to finalize. Approve or reject changes first.');
                            }
                        } catch (err) {
                            alert('Error: ' + err.message);
                        }
                    });
                }

                // Load and display approved changes if section exists
                var approvedSection = document.getElementById('approved-changes-section');
                if (approvedSection) {
                    loadApprovedChanges();
                }

                // Revert All button
                var revertAllBtn = document.getElementById('revert-all-btn');
                if (revertAllBtn) {
                    revertAllBtn.addEventListener('click', async function() {
                        if (!confirm('Are you sure you want to revert all approved changes back to pending?')) {
                            return;
                        }
                        try {
                            var result = await api('/api/changes/revert-all', { method: 'POST' });
                            alert(result.message);
                            render();
                        } catch (err) {
                            alert('Error: ' + err.message);
                        }
                    });
                }

                setupUploadArea();

            } catch (err) {
                container.innerHTML = '<div class="bg-red-900/30 border border-red-600 text-red-300 p-4 rounded">' + escapeHtml(err.message) + '</div>';
            }
        }

        // Find the difference between two strings and return highlighted HTML
        function getStringDiff(oldStr, newStr) {
            if (typeof oldStr !== 'string' || typeof newStr !== 'string') {
                return null; // Can't diff non-strings
            }

            // Find common prefix
            var prefixLen = 0;
            var minLen = Math.min(oldStr.length, newStr.length);
            while (prefixLen < minLen && oldStr[prefixLen] === newStr[prefixLen]) {
                prefixLen++;
            }

            // Find common suffix (but don't overlap with prefix)
            var suffixLen = 0;
            while (suffixLen < (minLen - prefixLen) &&
                   oldStr[oldStr.length - 1 - suffixLen] === newStr[newStr.length - 1 - suffixLen]) {
                suffixLen++;
            }

            // Extract the different parts
            var oldDiff = oldStr.substring(prefixLen, oldStr.length - suffixLen);
            var newDiff = newStr.substring(prefixLen, newStr.length - suffixLen);

            // Get context (up to 20 chars before and after)
            var contextLen = 20;
            var prefixContext = oldStr.substring(Math.max(0, prefixLen - contextLen), prefixLen);
            var suffixContext = oldStr.substring(oldStr.length - suffixLen, Math.min(oldStr.length, oldStr.length - suffixLen + contextLen));

            // Add ellipsis if we trimmed
            var prefixEllipsis = prefixLen > contextLen ? '...' : '';
            var suffixEllipsis = (oldStr.length - suffixLen + contextLen) < oldStr.length ? '...' : '';

            return {
                prefixEllipsis: prefixEllipsis,
                prefixContext: prefixContext,
                oldDiff: oldDiff,
                newDiff: newDiff,
                suffixContext: suffixContext,
                suffixEllipsis: suffixEllipsis,
                hasSignificantDiff: oldDiff.length > 0 || newDiff.length > 0
            };
        }

        function renderDashboardChangeCard(item, isGrouped, selectedGroup) {
            var change = item;
            var status = reviewDecisions[item.signature] || 'pending';

            // Filter assets to show based on selected group
            var displayAssets = item.assets || [];
            if (selectedGroup !== 'all') {
                displayAssets = displayAssets.filter(function(a) { return a.group_id === selectedGroup; });
            }

            var assetsHtml = '';
            if (displayAssets.length > 0) {
                // Build full asset list for click popup
                var assetNamesJson = btoa(encodeURIComponent(JSON.stringify(displayAssets.map(function(a) { return a.asset_name; }))));

                if (displayAssets.length <= 3) {
                    assetsHtml = '<span class="text-xs text-gray-500">Assets: ' +
                        displayAssets.map(function(a) { return escapeHtml(a.asset_name.split('.')[0]); }).join(', ') + '</span>';
                } else {
                    assetsHtml = '<button class="show-assets-btn text-xs text-gray-400 hover:text-gray-200 underline decoration-dotted" data-assets="' + assetNamesJson + '">View ' + displayAssets.length + ' affected assets</button>';
                }
            }

            var changeDataObj = {
                field_path: change.field_path,
                change_type: change.change_type,
                old_value: change.old_value,
                new_value: change.new_value,
                items_added: change.items_added,
                items_removed: change.items_removed
            };
            var changeDataB64 = btoa(encodeURIComponent(JSON.stringify(changeDataObj)));
            var assetsDataB64 = btoa(encodeURIComponent(JSON.stringify(item.assets || [])));

            // Status indicator
            var statusBadge = '';
            if (status === 'approved') {
                statusBadge = '<span class="ml-2 px-2 py-1 text-xs rounded bg-green-800 text-green-200">‚úì Approved</span>';
            } else if (status === 'rejected') {
                statusBadge = '<span class="ml-2 px-2 py-1 text-xs rounded bg-red-800 text-red-200">‚úó Rejected</span>';
            } else if (status === 'investigation') {
                statusBadge = '<span class="ml-2 px-2 py-1 text-xs rounded bg-sky-700 text-sky-100">üîç Under Investigation</span>';
            }

            // Timer badge for per-change compliance deadline (v4.0.0)
            var timerBadge = '';
            if (change.compliance_due_date && status !== 'approved' && status !== 'rejected') {
                var dueDate = new Date(change.compliance_due_date);
                var today = new Date();
                today.setHours(0, 0, 0, 0);
                var daysRemaining = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                var timerClass = daysRemaining <= 0 ? 'bg-red-800 text-red-200' :
                                 daysRemaining <= 5 ? 'bg-orange-700 text-orange-200' :
                                 daysRemaining <= 10 ? 'bg-yellow-700 text-yellow-200' : 'bg-gray-600 text-gray-300';
                var timerText = daysRemaining <= 0 ? 'OVERDUE' : daysRemaining + 'd left';
                timerBadge = '<span class="ml-3 px-3 py-1.5 text-sm font-bold rounded ' + timerClass + '">‚è± ' + timerText + '</span>';
            }

            // Card border color based on change type - more muted
            var borderClass = change.change_type === 'added' ? 'border-l-4 border-l-emerald-600' :
                             change.change_type === 'removed' ? 'border-l-4 border-l-rose-600' : 'border-l-4 border-l-sky-600';

            var html = `
                <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 ${borderClass}">
                    <div class="flex justify-between items-start gap-4 mb-3">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center flex-wrap gap-2 mb-1">
                                <span class="font-mono text-sm font-bold text-gray-100">${escapeHtml(formatFieldPath(change.field_path))}</span>
                                <span class="text-xs px-2 py-0.5 rounded ${
                                    change.change_type === 'array_modified' ? 'bg-slate-700 text-slate-200' :
                                    change.change_type === 'added' ? 'bg-green-800 text-green-200' :
                                    change.change_type === 'removed' ? 'bg-red-900 text-red-200' : 'bg-blue-800 text-blue-200'
                                }">${change.change_type.replace('_', ' ')}</span>
                                ${statusBadge}${timerBadge}
                            </div>
                            ${assetsHtml}
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <input type="text" class="dash-ticket-input px-2 py-1 text-xs bg-gray-800 border border-gray-600/50 rounded w-24 text-gray-300 placeholder-gray-500 focus:border-gray-500 focus:outline-none"
                                   data-sig="${item.signature}" placeholder="Ticket #" title="Per-field ticket # (optional)">
                            <button class="dash-approve-btn px-3 py-1.5 text-xs font-medium rounded transition-colors ${status === 'approved' ? 'bg-green-800 text-white' : 'bg-gray-700 text-gray-300 hover:bg-green-800 hover:text-white border border-gray-600'}"
                                    data-sig="${item.signature}" data-change="${changeDataB64}" data-assets="${assetsDataB64}">Approve</button>
                            <button class="dash-investigate-btn px-3 py-1.5 text-xs font-medium rounded transition-colors ${status === 'investigation' ? 'bg-sky-700 text-white' : 'bg-gray-700 text-gray-300 hover:bg-sky-700 hover:text-white border border-gray-600'}"
                                    data-sig="${item.signature}" data-change="${changeDataB64}" data-assets="${assetsDataB64}">Investigate</button>
                        </div>
                    </div>
            `;

            // Value display - show only the changed portion for strings
            if (change.change_type === 'array_modified' && (change.items_added || change.items_removed)) {
                html += '<div class="space-y-2">';
                if (change.items_added && change.items_added.length > 0) {
                    html += '<div class="bg-gray-900 border border-gray-700 rounded p-2">';
                    html += '<p class="text-xs font-semibold text-emerald-400 mb-1">+ Added (' + change.items_added.length + '):</p>';
                    change.items_added.forEach(function(item) {
                        html += '<div class="font-mono text-xs text-emerald-300 py-0.5">' + escapeHtml(formatArrayItem(item)) + '</div>';
                    });
                    html += '</div>';
                }
                if (change.items_removed && change.items_removed.length > 0) {
                    html += '<div class="bg-gray-900 border border-gray-700 rounded p-2">';
                    html += '<p class="text-xs font-semibold text-rose-400 mb-1">- Removed (' + change.items_removed.length + '):</p>';
                    change.items_removed.forEach(function(item) {
                        html += '<div class="font-mono text-xs text-red-300 py-0.5">' + escapeHtml(formatArrayItem(item)) + '</div>';
                    });
                    html += '</div>';
                }
                html += '</div>';
            } else if (change.change_type === 'modified') {
                var oldStr = typeof change.old_value === 'string' ? change.old_value : JSON.stringify(change.old_value);
                var newStr = typeof change.new_value === 'string' ? change.new_value : JSON.stringify(change.new_value);

                // Try to get a smart diff for long strings
                var diff = getStringDiff(oldStr, newStr);

                if (diff && diff.hasSignificantDiff && oldStr.length > 40) {
                    // Show only the changed portion with context
                    html += '<div class="bg-gray-900 border border-gray-700 rounded p-3">';
                    html += '<p class="text-xs text-gray-400 mb-2">Changed portion:</p>';
                    html += '<div class="font-mono text-xs break-all">';
                    html += '<span class="text-gray-500">' + escapeHtml(diff.prefixEllipsis + diff.prefixContext) + '</span>';
                    html += '<span class="bg-red-900/50 text-red-300 px-1 rounded line-through">' + escapeHtml(diff.oldDiff) + '</span>';
                    html += '<span class="text-gray-400 mx-1">‚Üí</span>';
                    html += '<span class="bg-emerald-900/50 text-emerald-300 px-1 rounded">' + escapeHtml(diff.newDiff) + '</span>';
                    html += '<span class="text-gray-500">' + escapeHtml(diff.suffixContext + diff.suffixEllipsis) + '</span>';
                    html += '</div>';
                    html += '</div>';
                } else {
                    // Short values - show full old ‚Üí new
                    html += '<div class="bg-gray-900 border border-gray-700 rounded p-3">';
                    html += '<div class="font-mono text-xs break-all">';
                    html += '<span class="text-rose-400">' + escapeHtml(oldStr) + '</span>';
                    html += '<span class="text-gray-500 mx-2">‚Üí</span>';
                    html += '<span class="text-emerald-400">' + escapeHtml(newStr) + '</span>';
                    html += '</div>';
                    html += '</div>';
                }
            } else if (change.change_type === 'added') {
                var newStr = typeof change.new_value === 'string' ? change.new_value : JSON.stringify(change.new_value);
                html += '<div class="bg-gray-900 border border-gray-700 rounded p-3">';
                html += '<div class="font-mono text-xs text-emerald-400 break-all">+ ' + escapeHtml(newStr) + '</div>';
                html += '</div>';
            } else if (change.change_type === 'removed') {
                var oldStr = typeof change.old_value === 'string' ? change.old_value : JSON.stringify(change.old_value);
                html += '<div class="bg-gray-900 border border-gray-700 rounded p-3">';
                html += '<div class="font-mono text-xs text-rose-400 break-all line-through">- ' + escapeHtml(oldStr) + '</div>';
                html += '</div>';
            }

            html += '</div>';

            return html;
        }

        async function loadActiveUsers() {
            var listEl = document.getElementById('active-users-list');
            if (!listEl) return;

            try {
                var data = await api('/api/system/users/active');
                var users = data.active_users || [];

                if (users.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-sm">No active sessions</p>';
                    return;
                }

                var html = '';
                users.forEach(function(user) {
                    var roleColor = user.role === 'admin' ? 'text-amber-500' : 'text-blue-400';
                    var roleBadge = user.role === 'admin' ? 'Admin' : 'Expert';
                    var groupLabel = user.group ? ` (${user.group})` : '';

                    html += `
                        <div class="flex items-center justify-between py-2 px-3 bg-gray-800 rounded">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 bg-green-700 rounded-full animate-pulse"></span>
                                <span class="text-sm text-white font-medium">${user.username}</span>
                                <span class="text-xs ${roleColor}">${roleBadge}${groupLabel}</span>
                            </div>
                            <span class="text-xs text-gray-400">${user.time_ago}</span>
                        </div>
                    `;
                });

                listEl.innerHTML = html;
            } catch (err) {
                listEl.innerHTML = '<p class="text-red-500 text-sm">Failed to load</p>';
                console.error('Failed to load active users:', err);
            }
        }

        async function loadApprovedChanges() {
            var listEl = document.getElementById('approved-changes-list');
            if (!listEl) return;

            try {
                var data = await api('/api/changes/approved');
                var changes = data.approved_changes || [];
                var revertWindow = data.revert_window_hours || 24;

                if (changes.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 text-sm py-2">No approved changes to display.</p>';
                    return;
                }

                var html = '';
                changes.forEach(function(change) {
                    var approvedTime = change.status_changed_at ? new Date(change.status_changed_at).toLocaleString() : 'Unknown';
                    var oldVal = change.old_value ? JSON.stringify(change.old_value) : '‚Äî';
                    var newVal = change.new_value ? JSON.stringify(change.new_value) : '‚Äî';
                    if (oldVal.length > 50) oldVal = oldVal.substring(0, 47) + '...';
                    if (newVal.length > 50) newVal = newVal.substring(0, 47) + '...';

                    html += `
                        <div class="bg-green-900/20 border border-green-600 rounded p-3 flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-green-500 font-medium text-sm">${escapeHtml(change.asset_name)}</span>
                                    <span class="text-gray-500 text-xs">‚Ä¢</span>
                                    <span class="text-gray-400 text-xs">${escapeHtml(formatFieldPath(change.field_path))}</span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    <span class="text-red-500">${escapeHtml(oldVal)}</span>
                                    <span class="mx-1">‚Üí</span>
                                    <span class="text-green-500">${escapeHtml(newVal)}</span>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">
                                    ${change.ticket_number ? '<span class="text-blue-400">Ticket: ' + escapeHtml(change.ticket_number) + '</span> ‚Ä¢ ' : ''}Approved ${approvedTime} by ${escapeHtml(change.status_changed_by || 'unknown')}
                                </div>
                            </div>
                            <button class="revert-change-btn ml-3 px-3 py-1.5 bg-amber-800 text-white rounded text-xs hover:bg-amber-700 font-medium whitespace-nowrap"
                                    data-id="${change.id}">
                                ‚Ü© Revert
                            </button>
                        </div>
                    `;
                });

                listEl.innerHTML = html;

                // Attach revert handlers
                listEl.querySelectorAll('.revert-change-btn').forEach(function(btn) {
                    btn.addEventListener('click', async function() {
                        var changeId = this.getAttribute('data-id');
                        if (!confirm('Revert this approved change back to pending?')) return;
                        try {
                            var result = await api('/api/changes/' + changeId + '/revert', { method: 'PUT' });
                            alert(result.message);
                            render();
                        } catch (err) {
                            alert('Error: ' + err.message);
                        }
                    });
                });

            } catch (err) {
                listEl.innerHTML = '<p class="text-red-500 text-sm py-2">Error loading approved changes: ' + escapeHtml(err.message) + '</p>';
            }
        }

        function setupDashboardChangeHandlers() {
            function decodeData(b64) {
                return JSON.parse(decodeURIComponent(atob(b64)));
            }

            function getDashTicketForSignature(sig) {
                var input = document.querySelector('.dash-ticket-input[data-sig="' + sig + '"]');
                return input ? (input.value.trim() || null) : null;
            }

            document.querySelectorAll('.dash-approve-btn').forEach(function(btn) {
                btn.addEventListener('click', async function() {
                    var signature = this.getAttribute('data-sig');
                    var changeData = decodeData(this.getAttribute('data-change'));
                    var assets = decodeData(this.getAttribute('data-assets'));
                    var ticketNumber = getDashTicketForSignature(signature);
                    await reviewChange(signature, 'approved', changeData, assets, null, ticketNumber);
                });
            });

            document.querySelectorAll('.dash-reject-btn').forEach(function(btn) {
                btn.addEventListener('click', async function() {
                    var signature = this.getAttribute('data-sig');
                    var changeData = decodeData(this.getAttribute('data-change'));
                    var assets = decodeData(this.getAttribute('data-assets'));
                    var ticketNumber = getDashTicketForSignature(signature);
                    await reviewChange(signature, 'rejected', changeData, assets, null, ticketNumber);
                });
            });

            document.querySelectorAll('.dash-investigate-btn').forEach(function(btn) {
                btn.addEventListener('click', async function() {
                    var signature = this.getAttribute('data-sig');
                    var changeData = decodeData(this.getAttribute('data-change'));
                    var assets = decodeData(this.getAttribute('data-assets'));
                    var ticketNumber = getDashTicketForSignature(signature);
                    var notes = await showInvestigationModal();
                    if (notes !== null) {
                        await reviewChange(signature, 'investigation', changeData, assets, notes, ticketNumber);
                    }
                });
            });

            // Investigation Queue approve/reject buttons - LOCAL staging only, submitted on Finalize
            document.querySelectorAll('.inv-approve-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var signature = this.getAttribute('data-signature');
                    var ticketInput = document.querySelector('.inv-ticket-input[data-signature="' + signature + '"]');
                    var ticketNumber = ticketInput ? ticketInput.value.trim() : null;

                    if (!ticketNumber) {
                        alert('Please enter a ticket number before approving');
                        return;
                    }

                    // Store ticket and decision locally (not submitted until Finalize)
                    investigationTickets[signature] = ticketNumber;
                    reviewDecisions[signature] = 'approved';

                    // Update button styles without full re-render
                    var card = this.closest('.bg-gray-800\\/50');
                    if (card) {
                        var statusBadge = card.querySelector('.px-2.py-0\\.5.text-xs.rounded');
                        if (statusBadge) {
                            statusBadge.className = 'px-2 py-0.5 text-xs rounded bg-green-800';
                            statusBadge.textContent = 'approved';
                        }
                        this.className = this.className.replace('bg-gray-700', 'bg-green-800').replace('text-gray-300', 'text-white');
                        var rejectBtn = card.querySelector('.inv-reject-btn');
                        if (rejectBtn) {
                            rejectBtn.className = rejectBtn.className.replace('bg-red-800', 'bg-gray-700').replace('text-white', 'text-gray-300');
                        }
                    }
                    // Update progress bar
                    updateInvestigationProgress();
                });
            });

            document.querySelectorAll('.inv-reject-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var signature = this.getAttribute('data-signature');
                    var ticketInput = document.querySelector('.inv-ticket-input[data-signature="' + signature + '"]');
                    var ticketNumber = ticketInput ? ticketInput.value.trim() : null;

                    if (!ticketNumber) {
                        alert('Please enter a ticket number before rejecting');
                        return;
                    }

                    // Store ticket and decision locally (not submitted until Finalize)
                    investigationTickets[signature] = ticketNumber;
                    reviewDecisions[signature] = 'rejected';

                    // Update button styles without full re-render
                    var card = this.closest('.bg-gray-800\\/50');
                    if (card) {
                        var statusBadge = card.querySelector('.px-2.py-0\\.5.text-xs.rounded');
                        if (statusBadge) {
                            statusBadge.className = 'px-2 py-0.5 text-xs rounded bg-red-800';
                            statusBadge.textContent = 'rejected';
                        }
                        this.className = this.className.replace('bg-gray-700', 'bg-red-800').replace('text-gray-300', 'text-white');
                        var approveBtn = card.querySelector('.inv-approve-btn');
                        if (approveBtn) {
                            approveBtn.className = approveBtn.className.replace('bg-green-800', 'bg-gray-700').replace('text-white', 'text-gray-300');
                        }
                    }
                    // Update progress bar
                    updateInvestigationProgress();
                });
            });

            // Helper function to update investigation progress bars
            function updateInvestigationProgress() {
                document.querySelectorAll('.inv-progress-bar').forEach(function(bar) {
                    var container = bar.closest('.bg-amber-950\\/40');
                    if (container) {
                        var total = container.querySelectorAll('.inv-approve-btn').length;
                        var reviewed = 0;
                        container.querySelectorAll('.inv-approve-btn').forEach(function(btn) {
                            var sig = btn.getAttribute('data-signature');
                            if (reviewDecisions[sig] === 'approved' || reviewDecisions[sig] === 'rejected') {
                                reviewed++;
                            }
                        });
                        var pct = Math.round((reviewed / total) * 100);
                        bar.style.width = pct + '%';
                        bar.className = bar.className.replace('bg-amber-700', pct === 100 ? 'bg-green-700' : 'bg-amber-700').replace('bg-green-700', pct === 100 ? 'bg-green-700' : 'bg-amber-700');

                        var progressText = container.querySelector('.inv-progress-text');
                        if (progressText) {
                            progressText.textContent = reviewed + ' of ' + total + ' reviewed';
                        }
                        var remainingText = container.querySelector('.inv-remaining-text');
                        if (remainingText) {
                            var remaining = total - reviewed;
                            remainingText.textContent = remaining === 0 ? '‚úì Ready to finalize!' : remaining + ' remaining to close investigation';
                            remainingText.className = remainingText.className.replace('text-amber-500', remaining === 0 ? 'text-green-500' : 'text-amber-500').replace('text-green-500', remaining === 0 ? 'text-green-500' : 'text-amber-500');
                        }
                    }
                });
            }

            // Investigation Queue - Apply ticket to all changes for an asset
            document.querySelectorAll('.inv-apply-asset-ticket').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var assetId = this.getAttribute('data-asset-id');
                    var ticketInput = document.querySelector('.inv-asset-ticket[data-asset-id="' + assetId + '"]');
                    var ticketNumber = ticketInput ? ticketInput.value.trim() : '';
                    if (!ticketNumber) {
                        alert('Please enter a ticket number first');
                        return;
                    }
                    // Find the parent container and fill all per-change ticket inputs
                    var container = this.closest('.bg-amber-950\\/40');
                    if (container) {
                        container.querySelectorAll('.inv-ticket-input').forEach(function(input) {
                            input.value = ticketNumber;
                            // Also store in investigationTickets for persistence
                            var sig = input.getAttribute('data-signature');
                            if (sig) {
                                investigationTickets[sig] = ticketNumber;
                            }
                        });
                    }
                });
            });

            // Investigation Queue - Notes textarea (save as user types)
            document.querySelectorAll('.inv-notes-input').forEach(function(textarea) {
                textarea.addEventListener('input', function() {
                    var assetId = this.getAttribute('data-asset-id');
                    investigationNotes[assetId] = this.value;
                });
            });

            // Investigation Queue - Revert All button (clears all local decisions)
            var invRevertAllBtn = document.getElementById('inv-revert-all-btn');
            if (invRevertAllBtn) {
                invRevertAllBtn.addEventListener('click', function() {
                    // Clear all investigation decisions
                    document.querySelectorAll('.inv-approve-btn').forEach(function(btn) {
                        var sig = btn.getAttribute('data-signature');
                        delete reviewDecisions[sig];
                    });
                    investigationTickets = {};
                    investigationNotes = {};
                    render();
                });
            }

            // Investigation Queue - Finalize button (submits all local decisions and finalizes)
            var invFinalizeBtn = document.getElementById('inv-finalize-btn');
            if (invFinalizeBtn) {
                invFinalizeBtn.addEventListener('click', async function() {
                    // Check if any changes have been reviewed
                    var hasReviewed = false;
                    document.querySelectorAll('.inv-approve-btn').forEach(function(btn) {
                        var sig = btn.getAttribute('data-signature');
                        if (reviewDecisions[sig] === 'approved' || reviewDecisions[sig] === 'rejected') {
                            hasReviewed = true;
                        }
                    });

                    if (!hasReviewed) {
                        alert('Please approve or reject at least one change before finalizing.');
                        return;
                    }

                    try {
                        // Submit all local investigation decisions
                        var submissions = [];
                        document.querySelectorAll('.inv-approve-btn').forEach(function(btn) {
                            var sig = btn.getAttribute('data-signature');
                            var decision = reviewDecisions[sig];
                            if (decision === 'approved' || decision === 'rejected') {
                                var changeIds = btn.getAttribute('data-change-ids').split(',').map(Number);
                                var ticket = investigationTickets[sig] || '';
                                changeIds.forEach(function(id) {
                                    submissions.push({ id: id, status: decision, ticket: ticket });
                                });
                            }
                        });

                        // Submit to API
                        for (var i = 0; i < submissions.length; i++) {
                            var sub = submissions[i];
                            await api('/api/changes/' + sub.id + '/review', {
                                method: 'PUT',
                                body: { status: sub.status, ticket_number: sub.ticket }
                            });
                        }

                        // Collect investigation notes by asset ID
                        var notesPayload = {};
                        document.querySelectorAll('.inv-notes-input').forEach(function(textarea) {
                            var assetId = textarea.getAttribute('data-asset-id');
                            var notes = textarea.value.trim();
                            if (notes) {
                                notesPayload[assetId] = notes;
                            }
                        });

                        // Now finalize with investigation notes
                        var result = await api('/api/changes/finalize', {
                            method: 'POST',
                            body: { investigation_notes: notesPayload }
                        });

                        // Clear local data
                        investigationTickets = {};
                        investigationNotes = {};

                        if (result.finalized_assets.length > 0) {
                            var report = generateBulkFinalizeReport(result);
                            await render();
                            showReport('Investigation Closure Summary', report, result.audit_log_id);
                            var reportModal = document.getElementById('report-modal');
                            document.getElementById('report-close').onclick = function() {
                                reportModal.classList.add('hidden');
                            };
                            reportModal.onclick = function(e) {
                                if (e.target === reportModal) reportModal.classList.add('hidden');
                            };
                        } else {
                            alert('Changes submitted. No assets ready to finalize yet.');
                            render();
                        }
                    } catch (err) {
                        alert('Error: ' + err.message);
                    }
                });
            }

            // Investigation Queue - Revert to clear local decision
            document.querySelectorAll('.inv-revert-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var signature = this.getAttribute('data-signature');

                    // Clear local decision
                    delete reviewDecisions[signature];

                    // Update UI
                    var card = this.closest('.bg-gray-800\\/50');
                    if (card) {
                        var statusBadge = card.querySelector('.px-2.py-0\\.5.text-xs.rounded');
                        if (statusBadge) {
                            statusBadge.className = 'px-2 py-0.5 text-xs rounded bg-gray-600';
                            statusBadge.textContent = 'pending';
                        }
                        var approveBtn = card.querySelector('.inv-approve-btn');
                        var rejectBtn = card.querySelector('.inv-reject-btn');
                        if (approveBtn) {
                            approveBtn.className = approveBtn.className.replace('bg-green-800', 'bg-gray-700').replace('text-white', 'text-gray-300');
                        }
                        if (rejectBtn) {
                            rejectBtn.className = rejectBtn.className.replace('bg-red-800', 'bg-gray-700').replace('text-white', 'text-gray-300');
                        }
                        // Remove revert button
                        this.remove();
                    }
                    // Update progress bar
                    updateInvestigationProgress();
                });
            });

            // Apply ticket # to specific asset's changes on dashboard
            document.querySelectorAll('.dash-apply-asset-ticket').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var assetId = this.getAttribute('data-asset-id');
                    var ticketInput = document.querySelector('.dash-asset-ticket[data-asset-id="' + assetId + '"]');
                    var ticket = ticketInput ? ticketInput.value.trim() : '';
                    if (!ticket) {
                        alert('Please enter a ticket # first');
                        return;
                    }
                    // Save asset-level ticket to persist across renders
                    ticketValues['dash_asset_' + assetId] = ticket;
                    // Find the asset container and apply to all ticket inputs within it
                    var container = this.closest('.border.border-gray-600.rounded-lg');
                    if (container) {
                        container.querySelectorAll('.dash-ticket-input').forEach(function(input) {
                            input.value = ticket;
                            // Also save each field's ticket value
                            var sig = input.getAttribute('data-sig');
                            if (sig) {
                                ticketValues['dash_field_' + sig] = ticket;
                            }
                        });
                    }
                });
            });

            // Show affected assets popup
            document.querySelectorAll('.show-assets-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var assetNames = decodeData(this.getAttribute('data-assets'));
                    showAffectedAssetsPopup(assetNames);
                });
            });
        }

        function showAffectedAssetsPopup(assetNames) {
            var modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-xl border border-gray-600 max-w-lg w-full mx-4 max-h-[80vh] flex flex-col">
                    <div class="flex justify-between items-center p-4 border-b border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-100">Affected Assets (${assetNames.length})</h3>
                        <button class="close-modal text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <div class="p-4 overflow-y-auto flex-1">
                        <ul class="space-y-1">
                            ${assetNames.map(function(name) {
                                return '<li class="text-sm text-gray-300 font-mono py-1 px-2 bg-gray-900 rounded">' + escapeHtml(name) + '</li>';
                            }).join('')}
                        </ul>
                    </div>
                    <div class="p-4 border-t border-gray-700">
                        <button class="close-modal w-full px-4 py-2 bg-gray-700 text-gray-200 rounded hover:bg-gray-600">Close</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            modal.querySelectorAll('.close-modal').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    modal.remove();
                });
            });

            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function setupUploadArea() {
            var uploadArea = document.getElementById('upload-area');
            var fileInput = document.getElementById('file-input');
            
            if (!uploadArea || !fileInput) return;
            
            uploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('drop-active');
            });
            
            uploadArea.addEventListener('dragleave', function() {
                uploadArea.classList.remove('drop-active');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('drop-active');
                handleFileUpload(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files);
                }
            });
        }

        async function handleFileUpload(files) {
            var resultsDiv = document.getElementById('upload-results');
            resultsDiv.innerHTML = '<p class="text-gray-400">Uploading...</p>';
            resultsDiv.classList.remove('hidden');
            
            try {
                var result = await apiUpload('/api/assets/upload', files);
                
                var html = '<div class="space-y-2">';
                html += '<p class="font-medium text-green-700">‚úÖ Upload Complete</p>';
                html += '<p class="text-sm">Files processed: ' + result.files_processed + '</p>';
                html += '<p class="text-sm">New assets: ' + result.new_assets + '</p>';
                html += '<p class="text-sm">Updated assets: ' + result.updated_assets + '</p>';
                
                if (result.errors.length > 0) {
                    html += '<div class="mt-2 p-2 bg-red-900/30 rounded text-sm text-red-400">';
                    html += '<p class="font-medium">Errors:</p>';
                    result.errors.forEach(function(err) {
                        html += '<p>‚Ä¢ ' + escapeHtml(err) + '</p>';
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                resultsDiv.innerHTML = html;
                
                setTimeout(function() {
                    render();
                }, 2000);
                
            } catch (err) {
                resultsDiv.innerHTML = '<p class="text-red-400">‚ùå Upload failed: ' + escapeHtml(err.message) + '</p>';
            }
        }

        // ============================================================
        // NEW ASSET REVIEW VIEW
        // ============================================================

        async function renderNewAssetReview(container) {
            if (!selectedNewAsset) {
                currentView = 'dashboard';
                render();
                return;
            }
            
            try {
                var asset = await api('/api/assets/' + selectedNewAsset.id);
                var config = asset.current_config || {};
                var entries = flattenObject(config);
                
                var queueInfo = newAssetsQueue.length > 1 ? ' (1 of ' + newAssetsQueue.length + ')' : '';
                
                var html = `
                    <div class="max-w-screen-xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-white">New Asset: ${escapeHtml(asset.asset_name)}${queueInfo}</h2>
                                <p class="text-sm text-gray-400">Review configuration before promoting to initial baseline</p>
                            </div>
                            <button id="back-btn" class="px-4 py-2 bg-gray-600 text-gray-200 rounded hover:bg-gray-6000">‚Üê Back</button>
                        </div>

                        <div class="bg-green-900/30 border border-green-600 rounded-lg p-4 mb-6">
                            <p class="text-green-300">
                                <span class="font-semibold">üìã Initial Baseline Review</span><br>
                                <span class="text-sm">This asset has no baseline yet. Review the configuration below and assign to a group to establish the initial baseline.</span>
                            </p>
                        </div>

                        <div class="bg-gray-700 rounded-lg shadow-md p-6 mb-6 border border-gray-700">
                            <h3 class="text-lg font-semibold mb-4 text-white">Configuration Variables (${entries.length})</h3>
                            <div class="max-h-96 overflow-y-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-700 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-sm font-medium text-gray-300">Path</th>
                                            <th class="px-4 py-2 text-left text-sm font-medium text-gray-300">Value</th>
                                        </tr>
                                    </thead>
                                    <tbody class="text-gray-300">
                `;
                
                entries.forEach(function(entry) {
                    html += `
                        <tr class="border-t diff-added">
                            <td class="px-4 py-2 font-mono text-sm">${escapeHtml(entry.path)}</td>
                            <td class="px-4 py-2 font-mono text-sm">${escapeHtml(formatValue(entry.value))}</td>
                        </tr>
                    `;
                });
                
                html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <button id="promote-btn" class="w-full px-6 py-4 bg-green-800 text-white text-lg font-semibold rounded-lg hover:bg-green-600">
                            ‚úÖ Assign Group & Promote to Initial Baseline
                        </button>
                    </div>
                `;
                
                container.innerHTML = html;
                
                document.getElementById('back-btn').addEventListener('click', function() {
                    selectedNewAsset = null;
                    currentView = 'dashboard';
                    render();
                });
                
                document.getElementById('promote-btn').addEventListener('click', async function() {
                    var result = await showGroupModal(asset.asset_name, asset.id);

                    if (result && result.groupId) {
                        var groupName = getGroupById(result.groupId).name;
                        var report = generateInitialBaselineReport(asset, config, groupName, result.ticketNumber);
                        showReport('Initial Baseline Promotion Report', report);
                        
                        newAssetsQueue = newAssetsQueue.filter(function(a) { return a.id !== asset.id; });
                        
                        if (newAssetsQueue.length > 0) {
                            selectedNewAsset = newAssetsQueue[0];
                        } else {
                            selectedNewAsset = null;
                            currentView = 'dashboard';
                        }
                        
                        document.getElementById('report-modal').addEventListener('click', function handler(e) {
                            if (e.target.id === 'report-close' || e.target.id === 'report-modal') {
                                render();
                                document.getElementById('report-modal').removeEventListener('click', handler);
                            }
                        });
                    }
                });
                
            } catch (err) {
                container.innerHTML = '<div class="bg-red-900/30 border border-red-600 text-red-300 p-4 rounded">' + escapeHtml(err.message) + '</div>';
            }
        }

        // ============================================================
        // ASSETS VIEW
        // ============================================================

        async function renderAssets(container) {
            container.innerHTML = '<div class="text-center py-12"><p class="text-gray-400">Loading assets...</p></div>';

            try {
                var assets = await api('/api/assets');

                // Count by status for tabs
                var activeCount = assets.filter(function(a) { return a.current_state !== 'retired'; }).length;
                var retiredCount = assets.filter(function(a) { return a.current_state === 'retired'; }).length;

                // Apply status filter first
                var statusFiltered = assets;
                if (assetStatusFilter === 'active') {
                    statusFiltered = assets.filter(function(a) { return a.current_state !== 'retired'; });
                } else if (assetStatusFilter === 'retired') {
                    statusFiltered = assets.filter(function(a) { return a.current_state === 'retired'; });
                }

                // Separate unassigned and filter by group
                var unassigned = statusFiltered.filter(function(a) { return !a.group_id; });
                var assigned = statusFiltered.filter(function(a) { return a.group_id; });

                // Apply group filter
                var filteredAssets = filterGroup ? assigned.filter(function(a) { return a.group_id === filterGroup; }) : assigned;

                // Apply search filter
                if (assetSearchTerm) {
                    var searchLower = assetSearchTerm.toLowerCase();
                    filteredAssets = filteredAssets.filter(function(a) {
                        return a.asset_name.toLowerCase().includes(searchLower) ||
                               (a.fqdn && a.fqdn.toLowerCase().includes(searchLower));
                    });
                }

                // Sort assets
                filteredAssets.sort(function(a, b) {
                    var aVal, bVal;
                    switch (assetSortBy) {
                        case 'baseline_promoted_at':
                            aVal = a.baseline_promoted_at ? new Date(a.baseline_promoted_at).getTime() : 0;
                            bVal = b.baseline_promoted_at ? new Date(b.baseline_promoted_at).getTime() : 0;
                            break;
                        case 'current_state':
                            aVal = a.current_state.toLowerCase();
                            bVal = b.current_state.toLowerCase();
                            break;
                        case 'group_id':
                            aVal = a.group_id ? getGroupById(a.group_id).name.toLowerCase() : 'zzz';
                            bVal = b.group_id ? getGroupById(b.group_id).name.toLowerCase() : 'zzz';
                            break;
                        case 'pending_change_count':
                            aVal = a.pending_change_count || 0;
                            bVal = b.pending_change_count || 0;
                            break;
                        default:
                            aVal = a.asset_name.toLowerCase();
                            bVal = b.asset_name.toLowerCase();
                    }
                    if (aVal < bVal) return assetSortOrder === 'asc' ? -1 : 1;
                    if (aVal > bVal) return assetSortOrder === 'asc' ? 1 : -1;
                    return 0;
                });

                // Build team filter options
                var teamOptions = '<option value="">All Teams</option>';
                groups.forEach(function(g) {
                    var selected = filterGroup === g.id ? 'selected' : '';
                    var count = assigned.filter(function(a) { return a.group_id === g.id; }).length;
                    teamOptions += '<option value="' + g.id + '" ' + selected + '>' + escapeHtml(g.name) + ' (' + count + ')</option>';
                });

                // Sort indicator helper
                function sortIcon(col) {
                    if (assetSortBy !== col) return '<span class="text-gray-500">‚áÖ</span>';
                    return assetSortOrder === 'asc' ? '<span class="text-bbt-gold">‚Üë</span>' : '<span class="text-bbt-gold">‚Üì</span>';
                }

                var html = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-100">Assets</h2>
                        <div class="flex items-center gap-4">
                            <input type="text" id="asset-search" placeholder="Search assets..."
                                   value="${escapeHtml(assetSearchTerm)}"
                                   class="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm w-64 focus:border-bbt-gold focus:outline-none">
                            <select id="team-filter" class="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm">
                                ${teamOptions}
                            </select>
                        </div>
                    </div>

                    <!-- Status Tabs -->
                    <div class="flex gap-2 mb-6 border-b border-gray-700 pb-3">
                        <button class="asset-status-tab px-4 py-2 rounded-t text-sm font-medium transition-colors ${assetStatusFilter === 'active' ? 'bg-gray-700 text-white border-b-2 border-green-500' : 'text-gray-400 hover:text-gray-200'}" data-status="active">
                            Active <span class="ml-1 px-2 py-0.5 rounded text-xs ${assetStatusFilter === 'active' ? 'bg-green-900 text-green-300' : 'bg-gray-700 text-gray-400'}">${activeCount}</span>
                        </button>
                        <button class="asset-status-tab px-4 py-2 rounded-t text-sm font-medium transition-colors ${assetStatusFilter === 'retired' ? 'bg-gray-700 text-white border-b-2 border-gray-500' : 'text-gray-400 hover:text-gray-200'}" data-status="retired">
                            Retired <span class="ml-1 px-2 py-0.5 rounded text-xs ${assetStatusFilter === 'retired' ? 'bg-gray-600 text-gray-300' : 'bg-gray-700 text-gray-400'}">${retiredCount}</span>
                        </button>
                        <button class="asset-status-tab px-4 py-2 rounded-t text-sm font-medium transition-colors ${assetStatusFilter === 'all' ? 'bg-gray-700 text-white border-b-2 border-blue-500' : 'text-gray-400 hover:text-gray-200'}" data-status="all">
                            All <span class="ml-1 px-2 py-0.5 rounded text-xs ${assetStatusFilter === 'all' ? 'bg-blue-900 text-blue-300' : 'bg-gray-700 text-gray-400'}">${assets.length}</span>
                        </button>
                    </div>
                `;

                html += `
                    <div id="upload-area" class="border-2 border-dashed border-gray-600 rounded-lg p-4 text-center hover:border-bbt-gold cursor-pointer mb-6">
                        <p class="text-gray-400">Drop JSON files here or click to upload</p>
                        <input type="file" multiple accept=".json" id="file-input" class="hidden">
                    </div>
                    <div id="upload-results" class="mb-6 hidden"></div>
                `;

                // Unassigned assets banner
                if (unassigned.length > 0 && !filterGroup) {
                    html += `
                        <div class="bg-yellow-900/30 border border-amber-700 rounded-lg p-4 mb-6">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-lg font-semibold text-yellow-400">‚ö†Ô∏è New Assets Awaiting Review (${unassigned.length})</h3>
                                <button id="review-queue-btn" class="px-4 py-2 bg-green-800 text-white rounded hover:bg-green-600">Review & Promote</button>
                            </div>
                            <p class="text-sm text-yellow-200 mb-3">Assign these new assets to a team and promote their initial baseline.</p>
                            <div class="flex flex-wrap gap-2">
                    `;
                    unassigned.forEach(function(asset) {
                        html += '<span class="px-3 py-1 bg-green-900/50 text-green-300 rounded-full text-sm">' + escapeHtml(asset.asset_name) + '</span>';
                    });
                    html += '</div></div>';
                }

                if (filteredAssets.length === 0) {
                    html += '<div class="text-center py-12 bg-gray-700 rounded-lg shadow border border-gray-700"><p class="text-gray-400">No assets found.</p></div>';
                } else {
                    html += `
                        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="asset-sort-col px-4 py-3 text-left text-sm font-semibold text-gray-300 cursor-pointer hover:bg-gray-600" data-sort="asset_name">
                                            Asset Name ${sortIcon('asset_name')}
                                        </th>
                                        <th class="asset-sort-col px-4 py-3 text-left text-sm font-semibold text-gray-300 cursor-pointer hover:bg-gray-600" data-sort="baseline_promoted_at">
                                            Last Baseline Promotion ${sortIcon('baseline_promoted_at')}
                                        </th>
                                        <th class="asset-sort-col px-4 py-3 text-left text-sm font-semibold text-gray-300 cursor-pointer hover:bg-gray-600" data-sort="latest_ticket">
                                            Latest Ticket ${sortIcon('latest_ticket')}
                                        </th>
                                        <th class="asset-sort-col px-4 py-3 text-left text-sm font-semibold text-gray-300 cursor-pointer hover:bg-gray-600" data-sort="current_state">
                                            Status ${sortIcon('current_state')}
                                        </th>
                                        <th class="asset-sort-col px-4 py-3 text-left text-sm font-semibold text-gray-300 cursor-pointer hover:bg-gray-600" data-sort="group_id">
                                            Team ${sortIcon('group_id')}
                                        </th>
                                        <th class="asset-sort-col px-4 py-3 text-center text-sm font-semibold text-gray-300 cursor-pointer hover:bg-gray-600" data-sort="pending_change_count">
                                            Pending ${sortIcon('pending_change_count')}
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-700">
                    `;

                    filteredAssets.forEach(function(asset) {
                        var gc = asset.group_id ? getGroupClasses(asset.group_id) : { bg: 'bg-gray-600', text: 'text-gray-300' };
                        var g = asset.group_id ? getGroupById(asset.group_id) : { name: 'Unassigned' };
                        var isRetired = asset.current_state === 'retired';
                        var stateClass = 'text-gray-300';
                        if (asset.current_state === 'compliant') stateClass = 'text-green-500';
                        else if (asset.current_state === 'investigation') stateClass = 'text-yellow-400';
                        else if (asset.current_state === 'failed') stateClass = 'text-red-500';
                        else if (isRetired) stateClass = 'text-gray-500';

                        var rowClass = isRetired ? 'asset-row hover:bg-gray-700 cursor-pointer transition-colors opacity-60' : 'asset-row hover:bg-gray-700 cursor-pointer transition-colors';

                        html += `
                            <tr class="${rowClass}" data-id="${asset.id}">
                                <td class="px-4 py-3">
                                    <span class="font-medium ${isRetired ? 'text-gray-400' : 'text-white'}">${escapeHtml(asset.asset_name)}</span>
                                </td>
                                <td class="px-4 py-3 ${isRetired ? 'text-gray-500' : 'text-gray-300'} text-sm">${asset.baseline_promoted_at ? new Date(asset.baseline_promoted_at).toLocaleDateString() : '‚Äî'}</td>
                                <td class="px-4 py-3 text-sm">${asset.latest_ticket ? '<span class="text-blue-300">' + escapeHtml(asset.latest_ticket) + '</span>' : '<span class="text-gray-500">‚Äî</span>'}</td>
                                <td class="px-4 py-3">
                                    <span class="${stateClass} font-medium">${isRetired ? 'RETIRED' : asset.current_state.toUpperCase()}</span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs rounded ${gc.bg} ${gc.text}">${escapeHtml(g.name)}</span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    ${isRetired ? '<span class="text-gray-500">‚Äî</span>' : (asset.pending_change_count > 0 ? '<span class="px-2 py-1 bg-orange-900/50 text-orange-300 rounded text-sm">' + asset.pending_change_count + '</span>' : '<span class="text-gray-500">‚Äî</span>')}
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table></div>';
                }

                container.innerHTML = html;

                // Team filter handler
                document.getElementById('team-filter').addEventListener('change', function() {
                    filterGroup = this.value || null;
                    render();
                });

                // Search input handler with debounce
                var searchInput = document.getElementById('asset-search');
                var searchTimeout = null;
                searchInput.addEventListener('input', function() {
                    var self = this;
                    assetSearchTerm = self.value;
                    if (searchTimeout) clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() {
                        var cursorPos = self.selectionStart;
                        render();
                        setTimeout(function() {
                            var newInput = document.getElementById('asset-search');
                            if (newInput) {
                                newInput.focus();
                                newInput.setSelectionRange(cursorPos, cursorPos);
                            }
                        }, 10);
                    }, 600);
                });
                // Also handle Enter key for immediate search
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        if (searchTimeout) clearTimeout(searchTimeout);
                        assetSearchTerm = this.value;
                        render();
                    }
                });

                // Sort column handlers
                document.querySelectorAll('.asset-sort-col').forEach(function(col) {
                    col.addEventListener('click', function() {
                        var sortCol = this.getAttribute('data-sort');
                        if (assetSortBy === sortCol) {
                            assetSortOrder = assetSortOrder === 'asc' ? 'desc' : 'asc';
                        } else {
                            assetSortBy = sortCol;
                            assetSortOrder = 'asc';
                        }
                        render();
                    });
                });

                // Status tab handlers
                document.querySelectorAll('.asset-status-tab').forEach(function(tab) {
                    tab.addEventListener('click', function() {
                        assetStatusFilter = this.getAttribute('data-status');
                        render();
                    });
                });

                // Review queue button
                var reviewQueueBtn = document.getElementById('review-queue-btn');
                if (reviewQueueBtn) {
                    reviewQueueBtn.addEventListener('click', function() {
                        newAssetsQueue = unassigned;
                        if (newAssetsQueue.length > 0) {
                            selectedNewAsset = newAssetsQueue[0];
                            currentView = 'newAssetReview';
                            render();
                        }
                    });
                }

                setupUploadArea();

                // Row click handlers
                document.querySelectorAll('.asset-row').forEach(function(row) {
                    row.addEventListener('click', async function() {
                        var assetId = this.getAttribute('data-id');
                        selectedAsset = await api('/api/assets/' + assetId);
                        currentView = 'assetDetail';
                        render();
                    });
                });

            } catch (err) {
                container.innerHTML = '<div class="bg-red-900/30 border border-red-600 text-red-300 p-4 rounded">' + escapeHtml(err.message) + '</div>';
            }
        }

        // ============================================================
        // ASSET DETAIL VIEW
        // ============================================================

        async function renderAssetDetail(container) {
            if (!selectedAsset) {
                currentView = 'assets';
                render();
                return;
            }

            var asset = selectedAsset;
            var gc = asset.group_id ? getGroupClasses(asset.group_id) : { border: 'border-gray-300', bg: 'bg-gray-700', text: 'text-gray-100' };
            var g = asset.group_id ? getGroupById(asset.group_id) : { name: 'Unassigned' };

            // Fetch effective baseline with field statuses
            var effectiveBaseline = null;
            try {
                effectiveBaseline = await api('/api/assets/' + asset.id + '/effective-baseline');
            } catch (err) {
                console.error('Failed to fetch effective baseline:', err);
            }

            var hasPendingChanges = effectiveBaseline && effectiveBaseline.pending_changes && effectiveBaseline.pending_changes.length > 0;
            var fieldStatuses = effectiveBaseline ? effectiveBaseline.field_statuses : {};

            var html = `
                <div class="max-w-screen-xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white">${escapeHtml(asset.asset_name)}</h2>
                            <span class="px-2 py-1 text-xs rounded ${gc.bg} ${gc.text}">${escapeHtml(g.name)}</span>
                        </div>
                        <button id="back-btn" class="px-4 py-2 bg-gray-600 text-gray-200 rounded hover:bg-gray-6000">‚Üê Back</button>
                    </div>

                    <div class="bg-gray-700 rounded-lg shadow-md p-6 mb-6 border border-gray-700">
                        <h3 class="text-lg font-semibold mb-4 text-white">Asset Information</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                            <div><span class="font-medium text-gray-400">Last Baseline Promotion:</span> ${effectiveBaseline && effectiveBaseline.baseline_promoted_at ? new Date(effectiveBaseline.baseline_promoted_at).toLocaleDateString() : 'None'}</div>
                            <div><span class="font-medium text-gray-400">Version:</span> ${escapeHtml(asset.version || 'N/A')}</div>
                            <div><span class="font-medium text-gray-400">State:</span> <span class="status-badge status-${asset.current_state}">${asset.current_state}</span></div>
                            <div><span class="font-medium text-gray-400">Days in State:</span> ${asset.days_in_current_state}</div>
                        </div>
                    </div>

                    <!-- Effective Baseline Section -->
                    <div class="bg-gray-700 rounded-lg shadow-md p-6 mb-6 border border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-white">Effective Baseline</h3>
                                <p class="text-sm text-gray-400">This is the computed baseline after all approved/rejected decisions</p>
                            </div>
                            <div class="flex items-center gap-3">
                                ${effectiveBaseline && effectiveBaseline.ticket_number ? `<span class="px-3 py-1 bg-blue-900/50 text-blue-300 rounded text-sm border border-blue-700/50"><span class="text-blue-400/70">Ticket:</span> ${escapeHtml(effectiveBaseline.ticket_number)}</span>` : ''}
                                ${hasPendingChanges ? '<span class="px-3 py-1 bg-blue-900 text-blue-300 rounded-full text-sm border border-blue-600">Pending Changes</span>' : '<span class="px-3 py-1 bg-green-900 text-green-300 rounded-full text-sm border border-green-600">Up to Date</span>'}
                            </div>
                        </div>

                        <!-- Field Status Legend -->
                        ${Object.keys(fieldStatuses).length > 0 ? `
                        <div class="mb-4 p-3 bg-gray-700 rounded-lg">
                            <p class="text-xs font-medium text-gray-400 mb-2">Field Status Legend:</p>
                            <div class="flex flex-wrap gap-3 text-xs text-gray-300">
                                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-green-700"></span> Approved</span>
                                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-red-700"></span> Rejected</span>
                                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-amber-900/300"></span> Investigation</span>
                                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-blue-700"></span> Pending</span>
                            </div>
                        </div>
                        ` : ''}

                        <div id="effective-baseline-view" class="border border-gray-600 rounded-lg overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-700">
                                    <tr>
                                        <th class="text-left p-3 font-medium text-gray-300">Field</th>
                                        <th class="text-left p-3 font-medium text-gray-300">Value</th>
                                        <th class="text-left p-3 font-medium w-24 text-gray-300">Status</th>
                                        <th class="text-left p-3 font-medium text-gray-300">Ticket #</th>
                                    </tr>
                                </thead>
                                <tbody id="baseline-fields-tbody" class="text-gray-300">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pending Changes Section -->
                    ${hasPendingChanges ? `
                    <div class="bg-blue-900/20 border border-blue-700 rounded-lg shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4 text-blue-300">Pending Changes (${effectiveBaseline.pending_changes.length})</h3>
                        <div class="mb-4">
                            <p class="text-sm text-blue-300/80"><strong>‚è∞ Per-Change Timer:</strong> Each change has a 30-day timer from detection. Review and resolve before individual timers expire.</p>
                        </div>
                        <div class="space-y-3">
                            ${effectiveBaseline.pending_changes.map(function(c) {
                                var enhanced = enhanceChangeWithArrayDiff(c);
                                var statusColor = enhanced.status === 'investigation' ? 'bg-yellow-900 text-amber-400 border border-amber-700' : 'bg-blue-900 text-blue-300 border border-blue-600';

                                var valueHtml = '';
                                if (enhanced.change_type === 'array_modified' && (enhanced.items_added || enhanced.items_removed)) {
                                    // Show array diff view
                                    valueHtml = '<div class="space-y-2">';
                                    if (enhanced.items_added && enhanced.items_added.length > 0) {
                                        valueHtml += '<div class="p-2 bg-green-900/30 rounded border border-green-800">';
                                        valueHtml += '<p class="text-xs font-semibold text-emerald-400 mb-1">+ Added (' + enhanced.items_added.length + '):</p>';
                                        enhanced.items_added.forEach(function(item) {
                                            valueHtml += '<div class="font-mono text-xs text-emerald-300 py-0.5">' + escapeHtml(formatArrayItem(item)) + '</div>';
                                        });
                                        valueHtml += '</div>';
                                    }
                                    if (enhanced.items_removed && enhanced.items_removed.length > 0) {
                                        valueHtml += '<div class="p-2 bg-red-900/30 rounded border border-red-800">';
                                        valueHtml += '<p class="text-xs font-semibold text-rose-400 mb-1">- Removed (' + enhanced.items_removed.length + '):</p>';
                                        enhanced.items_removed.forEach(function(item) {
                                            valueHtml += '<div class="font-mono text-xs text-red-300 py-0.5">' + escapeHtml(formatArrayItem(item)) + '</div>';
                                        });
                                        valueHtml += '</div>';
                                    }
                                    valueHtml += '</div>';
                                } else {
                                    // Show standard current ‚Üí proposed view
                                    var oldVal = enhanced.old_value !== null && enhanced.old_value !== undefined ? JSON.stringify(enhanced.old_value) : '(none)';
                                    var newVal = enhanced.new_value !== null && enhanced.new_value !== undefined ? JSON.stringify(enhanced.new_value) : '(none)';
                                    valueHtml = '<div class="grid grid-cols-2 gap-4 text-xs">';
                                    valueHtml += '<div class="p-2 bg-red-900/30 rounded border border-red-800"><strong class="text-red-500">Current:</strong> <code class="text-gray-300">' + escapeHtml(oldVal) + '</code></div>';
                                    valueHtml += '<div class="p-2 bg-green-900/30 rounded border border-green-800"><strong class="text-green-500">Proposed:</strong> <code class="text-gray-300">' + escapeHtml(newVal) + '</code></div>';
                                    valueHtml += '</div>';
                                }

                                return `
                                <div class="p-3 bg-gray-700 rounded border border-gray-600">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-mono text-sm font-medium text-gray-200">${escapeHtml(formatFieldPath(enhanced.field_path))}</span>
                                        <span class="px-2 py-1 text-xs rounded ${statusColor}">${enhanced.status}</span>
                                    </div>
                                    ${valueHtml}
                                </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="mt-4">
                            <button id="go-to-review-btn" class="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-600">Go to Review</button>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Raw Config Editor (Collapsible) -->
                    <div class="bg-gray-700 rounded-lg shadow-md p-6 mb-6 border border-gray-700">
                        <button id="toggle-raw-config" class="flex justify-between items-center w-full text-left">
                            <h3 class="text-lg font-semibold text-white">Raw Configuration Editor</h3>
                            <span id="toggle-icon" class="text-gray-400">‚ñº</span>
                        </button>
                        <div id="raw-config-section" class="hidden mt-4">
                            <!-- Info Banner -->
                            <div class="bg-blue-900/40 border border-blue-600 rounded-lg p-4 mb-4">
                                <h4 class="font-semibold text-blue-300 mb-2">üìù Propose Baseline Change</h4>
                                <div class="text-sm text-blue-200/90 space-y-2">
                                    <p><strong>Purpose:</strong> Use this editor to propose changes to the asset's baseline configuration. This is useful for corrections, manual updates, or data migrations.</p>
                                    <p><strong>How it works:</strong></p>
                                    <ul class="list-disc list-inside ml-2 text-blue-200/80">
                                        <li>Edits made here are <strong>proposed changes</strong> that follow the normal review process</li>
                                        <li>Your changes will appear in the Review queue for approval or rejection</li>
                                        <li>The baseline is only updated once changes are approved</li>
                                        <li>All submissions are logged in the audit trail with your username</li>
                                    </ul>
                                    <p><strong>Who should use this:</strong> Baseline experts who need to propose configuration changes outside of the automated file ingestion process.</p>
                                </div>
                            </div>
                            <textarea id="config-textarea" class="w-full h-64 p-4 font-mono text-sm border rounded-lg bg-gray-800 text-gray-200 border-gray-600" spellcheck="false">${escapeHtml(JSON.stringify(effectiveBaseline ? effectiveBaseline.current_baseline : asset.current_config || {}, null, 2))}</textarea>
                            <div class="flex justify-end gap-3 mt-4">
                                <button id="save-config-btn" class="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-600 font-medium">Submit for Review</button>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Log Section (Collapsible) -->
                    <div class="bg-gray-700 rounded-lg shadow-md p-6 mb-6 border border-gray-700">
                        <button id="toggle-audit-log" class="flex justify-between items-center w-full text-left">
                            <h3 class="text-lg font-semibold text-white">üìã Audit Log</h3>
                            <span id="audit-toggle-icon" class="text-gray-400">‚ñº</span>
                        </button>
                        <div id="audit-log-section" class="hidden mt-4">
                            <p class="text-sm text-gray-400 mb-4">History of all actions taken on this asset</p>
                            <div id="audit-log-content" class="space-y-2">
                                <p class="text-gray-500 text-sm">Loading audit logs...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Retirement Info (if retired) -->
                    ${asset.current_state === 'retired' ? `
                    <div class="bg-gray-600 border border-gray-500 rounded-lg p-4 mb-6">
                        <h4 class="font-semibold text-gray-300 mb-2">üóÑÔ∏è Asset Retired</h4>
                        <div class="text-sm text-gray-400 space-y-1">
                            <p><strong>Retired:</strong> ${asset.retired_at ? new Date(asset.retired_at).toLocaleDateString() : 'Unknown'}</p>
                            <p><strong>By:</strong> ${escapeHtml(asset.retired_by || 'Unknown')}</p>
                            <p><strong>Ticket:</strong> ${escapeHtml(asset.retirement_ticket || 'N/A')}</p>
                        </div>
                    </div>
                    ` : ''}

                    <div class="flex justify-between">
                        <button id="delete-asset-btn" class="px-6 py-3 bg-red-800 text-white font-semibold rounded-lg hover:bg-red-600">Delete Asset</button>
                        <div class="flex gap-2">
                            <button id="rename-asset-btn" class="px-6 py-3 bg-blue-700 text-white font-semibold rounded-lg hover:bg-blue-600">Rename Asset</button>
                            ${asset.current_state === 'retired' ?
                                '<button id="unretire-asset-btn" class="px-6 py-3 bg-green-800 text-white font-semibold rounded-lg hover:bg-green-600">Restore Asset</button>' :
                                '<button id="retire-asset-btn" class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-500">Retire Asset</button>'
                            }
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // Start countdown timer for next scheduled check (if pending changes section exists)
            startCountdownTimer();

            // Populate effective baseline table
            var tbody = document.getElementById('baseline-fields-tbody');
            var baselineConfig = effectiveBaseline ? effectiveBaseline.current_baseline : asset.current_config || {};
            var flatConfig = flattenObject(baselineConfig);
            var fieldTickets = effectiveBaseline ? (effectiveBaseline.field_tickets || {}) : {};
            var baselineTicket = effectiveBaseline ? effectiveBaseline.ticket_number : null;

            flatConfig.forEach(function(entry) {
                var status = fieldStatuses[entry.path] || 'baseline';
                var statusBadge = '';
                switch(status) {
                    case 'approved':
                        statusBadge = '<span class="px-2 py-1 text-xs rounded bg-green-900/50 text-green-300">Approved</span>';
                        break;
                    case 'rejected':
                        statusBadge = '<span class="px-2 py-1 text-xs rounded bg-red-900/50 text-red-300">Rejected</span>';
                        break;
                    case 'investigation':
                        statusBadge = '<span class="px-2 py-1 text-xs rounded bg-amber-900/50 text-amber-300">Investigation</span>';
                        break;
                    case 'pending':
                        statusBadge = '<span class="px-2 py-1 text-xs rounded bg-blue-900/50 text-blue-800">Pending</span>';
                        break;
                    default:
                        statusBadge = '<span class="px-2 py-1 text-xs rounded bg-gray-700 text-gray-400">Baseline</span>';
                }

                // Get ticket # for this field (from change, or fall back to baseline ticket)
                var fieldTicket = fieldTickets[entry.path] || baselineTicket || '';
                var ticketDisplay = fieldTicket
                    ? '<span class="text-xs text-blue-300">' + escapeHtml(fieldTicket) + '</span>'
                    : '<span class="text-gray-500">‚Äî</span>';

                var row = document.createElement('tr');
                row.className = 'border-t hover:bg-gray-600';
                var isTruncated = isValueTruncated(entry.value);
                var fullValue = getFullValue(entry.value);
                var displayValue = formatValue(entry.value);

                if (isTruncated) {
                    row.innerHTML = `
                        <td class="p-3 font-mono text-xs">${escapeHtml(entry.path)}</td>
                        <td class="p-3">
                            <code class="text-xs bg-gray-700 px-1 rounded cursor-pointer hover:bg-gray-600 baseline-value-cell"
                                  title="${escapeAttr(fullValue)}"
                                  data-full-value="${escapeAttr(fullValue)}"
                                  data-field="${escapeAttr(entry.path)}">${escapeHtml(displayValue)} <span class="text-blue-400 text-xs">[click to expand]</span></code>
                        </td>
                        <td class="p-3">${statusBadge}</td>
                        <td class="p-3">${ticketDisplay}</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td class="p-3 font-mono text-xs">${escapeHtml(entry.path)}</td>
                        <td class="p-3"><code class="text-xs bg-gray-700 px-1 rounded">${escapeHtml(displayValue)}</code></td>
                        <td class="p-3">${statusBadge}</td>
                        <td class="p-3">${ticketDisplay}</td>
                    `;
                }
                tbody.appendChild(row);
            });

            // Add click handlers for expandable values
            document.querySelectorAll('.baseline-value-cell').forEach(function(cell) {
                cell.addEventListener('click', function() {
                    var fullValue = this.getAttribute('data-full-value');
                    var fieldName = this.getAttribute('data-field');
                    showValueModal(fieldName, fullValue);
                });
            });

            // Event handlers
            document.getElementById('back-btn').addEventListener('click', function() {
                selectedAsset = null;
                currentView = 'assets';
                render();
            });

            document.getElementById('toggle-raw-config').addEventListener('click', function() {
                var section = document.getElementById('raw-config-section');
                var icon = document.getElementById('toggle-icon');
                if (section.classList.contains('hidden')) {
                    section.classList.remove('hidden');
                    icon.textContent = '‚ñ≤';
                } else {
                    section.classList.add('hidden');
                    icon.textContent = '‚ñº';
                }
            });

            // Audit Log toggle and load
            var auditLogsLoaded = false;
            document.getElementById('toggle-audit-log').addEventListener('click', async function() {
                var section = document.getElementById('audit-log-section');
                var icon = document.getElementById('audit-toggle-icon');
                if (section.classList.contains('hidden')) {
                    section.classList.remove('hidden');
                    icon.textContent = '‚ñ≤';

                    // Load audit logs if not already loaded
                    if (!auditLogsLoaded) {
                        try {
                            var logs = await api('/api/assets/' + asset.id + '/audit-logs');
                            var content = document.getElementById('audit-log-content');

                            if (logs.length === 0) {
                                content.innerHTML = '<p class="text-gray-500 text-sm italic">No audit log entries for this asset.</p>';
                            } else {
                                content.innerHTML = logs.map(function(log) {
                                    var actionClass = log.action === 'manual_config_edit' ? 'bg-amber-900/40 border-amber-600' :
                                                     log.action === 'delete_asset' ? 'bg-red-900/40 border-red-600' :
                                                     log.action === 'approve' || log.action === 'promote_initial_baseline' ? 'bg-green-900/40 border-green-600' :
                                                     log.action === 'reject' ? 'bg-red-900/40 border-red-600' :
                                                     'bg-gray-800 border-gray-600';

                                    var detailsHtml = '';
                                    if (log.details && log.action === 'manual_config_edit') {
                                        detailsHtml = '<div class="mt-2 text-xs text-gray-400">' +
                                            '<p>Fields changed: ' + (log.details.fields_changed || 0) + '</p>';
                                        if (log.details.changes && log.details.changes.length > 0) {
                                            detailsHtml += '<div class="mt-1 max-h-32 overflow-y-auto">';
                                            log.details.changes.forEach(function(change) {
                                                detailsHtml += '<div class="py-1 border-t border-gray-700">' +
                                                    '<span class="font-mono text-blue-400">' + escapeHtml(change.field) + '</span>: ' +
                                                    '<span class="text-red-500">' + escapeHtml(JSON.stringify(change.old_value)) + '</span> ‚Üí ' +
                                                    '<span class="text-green-500">' + escapeHtml(JSON.stringify(change.new_value)) + '</span>' +
                                                '</div>';
                                            });
                                            detailsHtml += '</div>';
                                        }
                                        detailsHtml += '</div>';
                                    }

                                    var adminBadge = log.is_admin_only ?
                                        '<span class="px-2 py-0.5 text-xs rounded bg-slate-800 text-slate-300 border border-slate-600 ml-2">Admin Action</span>' : '';

                                    var reportButton = log.report_id ?
                                        '<button class="audit-view-report-btn px-2 py-1 text-xs rounded bg-blue-700 text-white hover:bg-blue-600 ml-2" data-report-id="' + log.report_id + '">View Report</button>' : '';

                                    return '<div class="p-3 rounded border ' + actionClass + '">' +
                                        '<div class="flex justify-between items-start">' +
                                            '<div class="flex items-center flex-wrap gap-1">' +
                                                '<span class="font-semibold text-gray-200">' + escapeHtml(log.action_detail || log.action) + '</span>' +
                                                adminBadge +
                                                reportButton +
                                            '</div>' +
                                            '<span class="text-xs text-gray-500">' + new Date(log.timestamp).toLocaleString() + '</span>' +
                                        '</div>' +
                                        '<p class="text-sm text-gray-400 mt-1">By: ' + escapeHtml(log.username || 'system') + '</p>' +
                                        detailsHtml +
                                    '</div>';
                                }).join('');
                            }

                            // Add click handlers for report buttons
                            document.querySelectorAll('.audit-view-report-btn').forEach(function(btn) {
                                btn.addEventListener('click', async function(e) {
                                    e.stopPropagation();
                                    var reportId = this.getAttribute('data-report-id');
                                    try {
                                        var report = await api('/api/reports/' + reportId);
                                        // Show report in modal
                                        var modal = document.getElementById('report-modal');
                                        document.getElementById('report-content').textContent = report.report_content;
                                        modal.classList.remove('hidden');
                                        document.getElementById('report-close').onclick = function() {
                                            modal.classList.add('hidden');
                                        };
                                        document.getElementById('report-download').onclick = function() {
                                            var blob = new Blob([report.report_content], { type: 'text/plain' });
                                            var url = URL.createObjectURL(blob);
                                            var a = document.createElement('a');
                                            a.href = url;
                                            a.download = 'report_' + reportId + '.txt';
                                            a.click();
                                            URL.revokeObjectURL(url);
                                        };
                                        document.getElementById('report-copy').onclick = function() {
                                            navigator.clipboard.writeText(report.report_content).then(function() {
                                                alert('Report copied to clipboard!');
                                            });
                                        };
                                    } catch (err) {
                                        alert('Error loading report: ' + err.message);
                                    }
                                });
                            });

                            auditLogsLoaded = true;
                        } catch (err) {
                            document.getElementById('audit-log-content').innerHTML =
                                '<p class="text-red-500 text-sm">Error loading audit logs: ' + escapeHtml(err.message) + '</p>';
                        }
                    }
                } else {
                    section.classList.add('hidden');
                    icon.textContent = '‚ñº';
                }
            });

            if (document.getElementById('go-to-review-btn')) {
                document.getElementById('go-to-review-btn').addEventListener('click', function() {
                    currentView = 'review';
                    render();
                });
            }

            document.getElementById('save-config-btn').addEventListener('click', async function() {
                try {
                    // Validate JSON first
                    var config = JSON.parse(document.getElementById('config-textarea').value);

                    // Confirmation dialog
                    var confirmed = await showConfirmDialog(
                        'Propose Baseline Change',
                        'You are proposing a change to the baseline for "' + asset.asset_name + '".\n\n' +
                        'Your changes will be submitted through the normal review process and must be approved before the baseline is updated.\n\n' +
                        'This action will be permanently recorded in the audit log with your username.\n\n' +
                        'Continue?'
                    );

                    if (!confirmed) {
                        return;
                    }

                    var result = await api('/api/assets/' + asset.id + '/config', {
                        method: 'PUT',
                        body: config
                    });

                    if (result.changes_created > 0) {
                        alert('Changes submitted for review!\n\n' + result.changes_created + ' change(s) created.\n\nGo to the Review page to approve or reject the changes.');
                    } else {
                        alert(result.message);
                    }
                    selectedAsset = await api('/api/assets/' + asset.id);
                    render();
                } catch (err) {
                    if (err instanceof SyntaxError) {
                        alert('Invalid JSON: ' + err.message);
                    } else {
                        alert('Error: ' + err.message);
                    }
                }
            });

            document.getElementById('delete-asset-btn').addEventListener('click', async function() {
                var password = await showDeleteConfirmDialog(asset.asset_name);
                if (password) {
                    try {
                        var result = await api('/api/assets/' + asset.id + '/delete', {
                            method: 'POST',
                            body: { password: password }
                        });

                        selectedAsset = null;
                        currentView = 'assets';
                        render();
                    } catch (err) {
                        alert('Error: ' + err.message);
                    }
                }
            });

            // Rename button handler
            var renameBtn = document.getElementById('rename-asset-btn');
            if (renameBtn) {
                renameBtn.addEventListener('click', async function() {
                    // First show warning about the rename process
                    var proceed = await showConfirmDialog(
                        'Rename Asset - Important Notice',
                        'Renaming an asset changes its FQDN, which is part of the baseline record.\n\n' +
                        '‚ö†Ô∏è This action:\n' +
                        '‚Ä¢ Creates a pending change requiring approval\n' +
                        '‚Ä¢ Will be tracked in audit logs\n' +
                        '‚Ä¢ Does not take effect until approved\n\n' +
                        'Do you want to proceed with the rename request?'
                    );
                    if (!proceed) return;

                    var newName = await showPromptDialog(
                        'Rename Asset',
                        'Enter the new name (FQDN) for "' + asset.asset_name + '":',
                        'e.g., server01.newdomain.local'
                    );
                    if (newName && newName.trim()) {
                        try {
                            var result = await api('/api/assets/' + asset.id + '/rename?new_name=' + encodeURIComponent(newName.trim()), { method: 'POST' });
                            if (result.status === 'pending_approval') {
                                alert('Rename request submitted for approval.\n\n' +
                                      'Current name: ' + asset.asset_name + '\n' +
                                      'Requested name: ' + newName.trim() + '\n\n' +
                                      'The rename will take effect after an administrator approves the change.');
                            } else {
                                alert(result.message || 'Rename request submitted.');
                            }
                            selectedAsset = await api('/api/assets/' + asset.id);
                            render();
                        } catch (err) {
                            alert('Error: ' + err.message);
                        }
                    }
                });
            }

            // Retire button handler
            var retireBtn = document.getElementById('retire-asset-btn');
            if (retireBtn) {
                retireBtn.addEventListener('click', async function() {
                    var ticket = await showPromptDialog(
                        'Retire Asset',
                        'Enter the retirement ticket number for "' + asset.asset_name + '":',
                        'e.g., CHG-12345'
                    );
                    if (ticket && ticket.trim()) {
                        try {
                            await api('/api/assets/' + asset.id + '/retire?retirement_ticket=' + encodeURIComponent(ticket.trim()), { method: 'POST' });
                            selectedAsset = await api('/api/assets/' + asset.id);
                            render();
                        } catch (err) {
                            alert('Error: ' + err.message);
                        }
                    }
                });
            }

            // Unretire button handler
            var unretireBtn = document.getElementById('unretire-asset-btn');
            if (unretireBtn) {
                unretireBtn.addEventListener('click', async function() {
                    var confirmed = await showConfirmDialog('Restore Asset', 'Are you sure you want to restore "' + asset.asset_name + '" from retirement? It will be included in scheduled checks again.');
                    if (confirmed) {
                        try {
                            await api('/api/assets/' + asset.id + '/unretire', { method: 'POST' });
                            selectedAsset = await api('/api/assets/' + asset.id);
                            render();
                        } catch (err) {
                            alert('Error: ' + err.message);
                        }
                    }
                });
            }
        }

        function formatValue(value) {
            if (value === null) return '-';
            if (value === undefined) return 'undefined';
            if (typeof value === 'string') return value.length > 80 ? value.substring(0, 80) + '...' : value;
            if (Array.isArray(value)) {
                var str = JSON.stringify(value);
                return str.length > 80 ? str.substring(0, 80) + '...' : str;
            }
            if (typeof value === 'object') {
                var str = JSON.stringify(value);
                return str.length > 80 ? str.substring(0, 80) + '...' : str;
            }
            return String(value);
        }

        function getFullValue(value) {
            if (value === null) return '-';
            if (value === undefined) return 'undefined';
            if (typeof value === 'object') return JSON.stringify(value, null, 2);
            return String(value);
        }

        function isValueTruncated(value) {
            if (value === null || value === undefined) return false;
            if (typeof value === 'string') return value.length > 80;
            if (typeof value === 'object') return JSON.stringify(value).length > 80;
            return false;
        }

        // ============================================================
        // REVIEW VIEW - WITH SMART ARRAY DIFF
        // ============================================================

        async function renderReview(container) {
            container.innerHTML = '<div class="text-center py-12"><p class="text-gray-400">Loading changes...</p></div>';

            try {
                var data = await api('/api/changes/grouped');
                var grouped = data.grouped_changes || [];
                var assetSpecific = data.asset_specific_changes || [];
                
                // Enhance all changes with smart array diff
                grouped = grouped.map(enhanceChangeWithArrayDiff);
                assetSpecific = assetSpecific.map(enhanceChangeWithArrayDiff);

                // Separate investigation changes from regular pending changes
                // Use CHANGE STATUS (not asset state) to determine queue placement
                var investigationChanges = [];
                var regularChanges = [];
                assetSpecific.forEach(function(item) {
                    // Check if ANY of the changes in this group have investigation status
                    var hasInvestigationChange = item.assets && item.assets.some(function(a) {
                        return a.change_status === 'investigation';
                    });
                    if (hasInvestigationChange) {
                        investigationChanges.push(item);
                    } else {
                        regularChanges.push(item);
                    }
                });
                assetSpecific = regularChanges;

                // Initialize decisions
                var allChanges = grouped.concat(assetSpecific).concat(investigationChanges);
                allChanges.forEach(function(item) {
                    if (!reviewDecisions[item.signature]) {
                        reviewDecisions[item.signature] = 'pending';
                    }
                });
                
                var html = `
                    <div class="max-w-screen-xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-100">Review Changes</h2>
                            <button id="back-btn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">‚Üê Back</button>
                        </div>
                        
                        <div class="bg-blue-900/30 border border-tva-blue border-opacity-30 rounded-lg p-4 mb-6">
                            <p class="text-sm text-tva-blue">
                                <span class="font-semibold">Reviewing as:</span> ${escapeHtml(currentUser.full_name)}
                                ${currentUser.group_id ? ' (' + escapeHtml(getGroupById(currentUser.group_id).name) + ')' : ''}
                            </p>
                        </div>
                `;
                
                if (grouped.length === 0 && assetSpecific.length === 0 && investigationChanges.length === 0) {
                    html += '<div class="bg-gray-700 rounded-lg shadow-md p-6 text-center text-gray-400 border border-gray-700">No pending changes to review.</div>';
                } else {
                    // Info banner about per-change timers (v4.0.0)
                    html += `
                        <div class="bg-blue-900/30 border border-blue-600 rounded-lg p-4 mb-6">
                            <p class="text-sm text-blue-200"><strong>‚è∞ Per-Change Timer:</strong> Each change has a 30-day timer from detection. Review and resolve before individual timers expire.</p>
                        </div>
                    `;

                    // Investigation Queue Section - distinct amber styling
                    if (investigationChanges.length > 0) {
                        // Group investigation changes by asset
                        var investigationByAsset = {};
                        investigationChanges.forEach(function(item) {
                            var assetName = (item.assets && item.assets[0]) ? item.assets[0].asset_name : 'Unknown';
                            var assetId = (item.assets && item.assets[0]) ? item.assets[0].asset_id : 0;
                            var stateChangedAt = (item.assets && item.assets[0]) ? item.assets[0].state_changed_at : null;
                            var key = assetId + '|' + assetName;
                            if (!investigationByAsset[key]) {
                                investigationByAsset[key] = { assetName: assetName, assetId: assetId, stateChangedAt: stateChangedAt, changes: [] };
                            }
                            investigationByAsset[key].changes.push(item);
                        });

                        html += `
                            <div class="mb-8 bg-amber-900/30 border-2 border-amber-500 rounded-lg overflow-hidden">
                                <div class="bg-amber-800/50 px-6 py-4 border-b border-amber-600">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-2xl">üîç</span>
                                        <h3 class="text-xl font-bold text-amber-500">Investigation Queue</h3>
                                        <span class="bg-amber-800 text-white px-3 py-1 rounded text-sm font-semibold">${investigationChanges.length} Change${investigationChanges.length !== 1 ? 's' : ''} Require Resolution</span>
                                    </div>
                                    <p class="text-amber-200 text-sm border-l-4 border-amber-500 pl-3 ml-9">
                                        These changes are under active investigation. <strong>Approve or reject all changes</strong> for an asset to close its investigation and return the asset to compliance.
                                    </p>
                                </div>
                                <div class="p-4">
                        `;

                        // Render each asset in investigation
                        Object.keys(investigationByAsset).forEach(function(key) {
                            var assetGroup = investigationByAsset[key];
                            var totalChanges = assetGroup.changes.length;
                            var reviewedCount = assetGroup.changes.filter(function(c) {
                                var decision = reviewDecisions[c.signature];
                                return decision === 'approved' || decision === 'rejected';
                            }).length;
                            var progressPct = Math.round((reviewedCount / totalChanges) * 100);
                            var remaining = totalChanges - reviewedCount;

                            // Calculate days in investigation
                            var daysInInvestigation = '';
                            if (assetGroup.stateChangedAt) {
                                var startDate = new Date(assetGroup.stateChangedAt);
                                var now = new Date();
                                var days = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                                daysInInvestigation = days + ' day' + (days !== 1 ? 's' : '') + ' in investigation';
                            }

                            html += `
                                <div class="mb-4 rounded-lg overflow-hidden bg-amber-950/40 border border-amber-600/50">
                                    <div class="bg-amber-800/40 px-4 py-3 flex items-center justify-between flex-wrap gap-3 border-b border-amber-600/40">
                                        <div class="flex items-center gap-3">
                                            <span class="text-amber-500 text-lg">üîç</span>
                                            <span class="font-bold text-amber-200">${escapeHtml(assetGroup.assetName)}</span>
                                            <span class="text-xs px-2 py-1 bg-amber-700 text-amber-100 rounded font-semibold">UNDER INVESTIGATION</span>
                                            ${daysInInvestigation ? '<span class="text-xs text-amber-500">' + daysInInvestigation + '</span>' : ''}
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" class="asset-ticket-input px-2 py-1 text-xs bg-gray-900 border border-amber-500/50 rounded w-28 text-gray-200 placeholder-gray-500 focus:border-amber-400 focus:outline-none"
                                                   data-asset-id="${assetGroup.assetId}" placeholder="Ticket #">
                                            <button class="apply-asset-ticket-btn px-3 py-1.5 bg-amber-800 text-white rounded text-xs font-medium hover:bg-amber-700"
                                                    data-asset-id="${assetGroup.assetId}">Apply to Asset</button>
                                        </div>
                                    </div>
                                    <div class="px-4 py-2 bg-amber-900/20 border-b border-amber-700/30">
                                        <div class="flex items-center gap-3 text-sm">
                                            <span class="text-amber-300">Progress:</span>
                                            <span class="text-amber-200 font-medium">${reviewedCount} of ${totalChanges} reviewed</span>
                                            <div class="flex-1 max-w-xs bg-amber-950 rounded-full h-2 overflow-hidden">
                                                <div class="h-full ${progressPct === 100 ? 'bg-green-700' : 'bg-amber-700'}" style="width: ${progressPct}%"></div>
                                            </div>
                                            <span class="text-xs ${remaining === 0 ? 'text-green-500' : 'text-amber-500'}">
                                                ${remaining === 0 ? '‚úì Ready to finalize!' : remaining + ' remaining to close investigation'}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="p-4 space-y-3">
                            `;
                            assetGroup.changes.forEach(function(item) {
                                html += renderChangeCard(item, false, true); // third param indicates investigation context
                            });
                            html += `
                                    </div>
                                </div>
                            `;
                        });

                        html += `
                                </div>
                            </div>
                        `;
                    }

                    if (grouped.length > 0) {
                        html += `
                            <div class="bg-gray-700 rounded-lg shadow-md p-6 mb-6 border border-gray-700">
                                <h3 class="text-lg font-semibold mb-4 text-slate-400">üîó Grouped Changes (${grouped.length})</h3>
                                <p class="text-sm text-gray-400 mb-4">These identical changes appear across multiple assets and can be approved together.</p>
                        `;

                        grouped.forEach(function(item) {
                            html += renderChangeCard(item, true);
                        });

                        html += '</div>';
                    }

                    if (assetSpecific.length > 0) {
                        // Group asset-specific changes by asset
                        var changesByAsset = {};
                        assetSpecific.forEach(function(item) {
                            var assetName = (item.assets && item.assets[0]) ? item.assets[0].asset_name : 'Unknown';
                            var assetId = (item.assets && item.assets[0]) ? item.assets[0].asset_id : 0;
                            var key = assetId + '|' + assetName;
                            if (!changesByAsset[key]) {
                                changesByAsset[key] = { assetName: assetName, assetId: assetId, changes: [] };
                            }
                            changesByAsset[key].changes.push(item);
                        });

                        html += `
                            <div class="bg-gray-700 rounded-lg shadow-md p-6 mb-6 border border-gray-700">
                                <h3 class="text-lg font-semibold mb-4 text-blue-400">üìã Asset-Specific Changes (${assetSpecific.length})</h3>
                        `;

                        // Render each asset group (ASSET LEVEL - slate/neutral theme)
                        Object.keys(changesByAsset).forEach(function(key) {
                            var assetGroup = changesByAsset[key];
                            html += `
                                <div class="mb-6 rounded-lg overflow-hidden bg-gray-800/30">
                                    <div class="bg-slate-700/50 px-4 py-3 flex items-center justify-between flex-wrap gap-3 border-b border-slate-600/40">
                                        <div class="flex items-center gap-3">
                                            <span class="text-xs font-semibold text-slate-400 uppercase tracking-wide">Asset</span>
                                            <span class="font-semibold text-slate-200">${escapeHtml(assetGroup.assetName)}</span>
                                            <span class="text-xs px-2 py-0.5 bg-slate-600 text-slate-300 rounded">${assetGroup.changes.length} change${assetGroup.changes.length !== 1 ? 's' : ''}</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="text" class="asset-ticket-input px-2 py-1 text-xs bg-gray-900 border border-slate-500/50 rounded w-28 text-gray-200 placeholder-gray-500 focus:border-slate-400 focus:outline-none"
                                                   data-asset-id="${assetGroup.assetId}" placeholder="Ticket #">
                                            <button class="apply-asset-ticket-btn px-3 py-1.5 bg-slate-600 text-slate-200 rounded text-xs font-medium hover:bg-slate-500"
                                                    data-asset-id="${assetGroup.assetId}">Apply to Asset</button>
                                        </div>
                                    </div>
                                    <div class="p-4 space-y-3">
                            `;
                            assetGroup.changes.forEach(function(item) {
                                html += renderChangeCard(item, false);
                            });
                            html += `
                                    </div>
                                </div>
                            `;
                        });

                        html += '</div>';
                    }
                    
                    html += `
                        <button id="finalize-btn" class="w-full px-6 py-4 bg-green-800 text-white text-lg font-semibold rounded-lg hover:bg-green-600">
                            ‚úÖ Finalize All Reviewed Changes
                        </button>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
                
                document.getElementById('back-btn').addEventListener('click', function() {
                    currentView = 'dashboard';
                    render();
                });
                
                // Helper to decode base64 data attributes
                function decodeData(b64) {
                    return JSON.parse(decodeURIComponent(atob(b64)));
                }
                
                function getTicketForSignature(sig) {
                    var input = document.querySelector('.ticket-input[data-sig="' + sig + '"]');
                    return input ? (input.value.trim() || null) : null;
                }

                document.querySelectorAll('.approve-btn').forEach(function(btn) {
                    btn.addEventListener('click', async function() {
                        var signature = this.getAttribute('data-sig');
                        var changeData = decodeData(this.getAttribute('data-change'));
                        var assets = decodeData(this.getAttribute('data-assets'));
                        var ticketNumber = getTicketForSignature(signature);

                        await reviewChange(signature, 'approved', changeData, assets, null, ticketNumber);
                    });
                });

                document.querySelectorAll('.reject-btn').forEach(function(btn) {
                    btn.addEventListener('click', async function() {
                        var signature = this.getAttribute('data-sig');
                        var changeData = decodeData(this.getAttribute('data-change'));
                        var assets = decodeData(this.getAttribute('data-assets'));
                        var ticketNumber = getTicketForSignature(signature);

                        await reviewChange(signature, 'rejected', changeData, assets, null, ticketNumber);
                    });
                });

                document.querySelectorAll('.investigate-btn').forEach(function(btn) {
                    btn.addEventListener('click', async function() {
                        var signature = this.getAttribute('data-sig');
                        var changeData = decodeData(this.getAttribute('data-change'));
                        var assets = decodeData(this.getAttribute('data-assets'));
                        var ticketNumber = getTicketForSignature(signature);

                        var notes = await showInvestigationModal();
                        if (notes !== null) {
                            await reviewChange(signature, 'investigation', changeData, assets, notes, ticketNumber);
                        }
                    });
                });

                // Apply ticket # to specific asset's changes
                document.querySelectorAll('.apply-asset-ticket-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var assetId = this.getAttribute('data-asset-id');
                        var ticketInput = document.querySelector('.asset-ticket-input[data-asset-id="' + assetId + '"]');
                        var ticket = ticketInput ? ticketInput.value.trim() : '';
                        if (!ticket) {
                            alert('Please enter a ticket # first');
                            return;
                        }
                        // Save asset-level ticket to persist across renders
                        ticketValues['asset_' + assetId] = ticket;
                        // Find all ticket inputs within the same asset group container
                        var container = this.closest('.mb-6');
                        if (container) {
                            container.querySelectorAll('.ticket-input').forEach(function(input) {
                                input.value = ticket;
                                // Also save each field's ticket value
                                var sig = input.getAttribute('data-sig');
                                if (sig) {
                                    ticketValues['field_' + sig] = ticket;
                                }
                            });
                        }
                    });
                });

                var finalizeBtn = document.getElementById('finalize-btn');
                if (finalizeBtn) {
                    finalizeBtn.addEventListener('click', async function() {
                        try {
                            var result = await api('/api/changes/finalize', { method: 'POST' });
                            
                            if (result.finalized_assets.length > 0) {
                                var report = generateBulkFinalizeReport(result);
                                showReport('Baseline Promotion Summary', report, result.audit_log_id, 'promotion');
                                
                                // Navigate to dashboard when report is closed
                                var reportModal = document.getElementById('report-modal');
                                var closeHandler = function() {
                                    reportModal.classList.add('hidden');
                                    currentView = 'dashboard';
                                    render();
                                };
                                document.getElementById('report-close').onclick = closeHandler;
                                // Also navigate on clicking outside the modal content
                                reportModal.onclick = function(e) {
                                    if (e.target === reportModal) {
                                        closeHandler();
                                    }
                                };
                            } else {
                                alert('No changes to finalize. Review and approve changes first.');
                                // Still refresh to show current state
                                render();
                            }
                        } catch (err) {
                            alert('Error: ' + err.message);
                        }
                    });
                }
                
            } catch (err) {
                container.innerHTML = '<div class="bg-red-900/30 border border-red-600 text-red-300 p-4 rounded">' + escapeHtml(err.message) + '</div>';
            }
        }

        function renderChangeCard(item, isGrouped, isInvestigation) {
            var change = item;
            var status = reviewDecisions[item.signature] || 'pending';
            var bgClass = change.change_type === 'added' ? 'diff-added' :
                         change.change_type === 'removed' ? 'diff-removed' : 'diff-modified';

            // Add investigation-specific styling
            var cardBorderClass = isInvestigation ? 'border-amber-500/50' : 'border-gray-300';
            var investigationBadge = isInvestigation ?
                '<span class="ml-2 text-xs px-2 py-0.5 bg-amber-800 text-white rounded font-medium">Required for Compliance</span>' : '';
            // Timer badge for per-change compliance deadline (v4.0.0)
            var timerBadge2 = '';
            if (change.compliance_due_date && status !== 'approved' && status !== 'rejected') {
                var dueDate2 = new Date(change.compliance_due_date);
                var today2 = new Date();
                today2.setHours(0, 0, 0, 0);
                var daysRemaining2 = Math.ceil((dueDate2 - today2) / (1000 * 60 * 60 * 24));
                var timerClass2 = daysRemaining2 <= 0 ? 'bg-red-800 text-red-200' :
                                 daysRemaining2 <= 5 ? 'bg-orange-700 text-orange-200' :
                                 daysRemaining2 <= 10 ? 'bg-yellow-700 text-yellow-200' : 'bg-gray-600 text-gray-300';
                var timerText2 = daysRemaining2 <= 0 ? 'OVERDUE' : daysRemaining2 + 'd left';
                timerBadge2 = '<span class="ml-3 px-3 py-1.5 text-sm font-bold rounded ' + timerClass2 + '">‚è± ' + timerText2 + '</span>';
            }

            var assetsHtml = '';
            var assetsData = item.assets || [];

            if (isGrouped && assetsData.length > 0) {
                assetsHtml = '<p class="text-sm text-gray-400 mb-2">Affects: ' +
                    assetsData.map(function(a) { return escapeHtml(a.asset_name); }).join(', ') + '</p>';
            } else if (assetsData.length === 1) {
                var gc = getGroupClasses(assetsData[0].group_id);
                assetsHtml = '<p class="text-sm text-gray-400 mb-2">Asset: <span class="font-medium">' +
                    escapeHtml(assetsData[0].asset_name) + '</span></p>';
            }
            
            var changeDataObj = {
                field_path: change.field_path,
                change_type: change.change_type,
                old_value: change.old_value,
                new_value: change.new_value,
                items_added: change.items_added,
                items_removed: change.items_removed
            };
            // Use btoa for safe encoding in HTML attributes
            var changeDataB64 = btoa(encodeURIComponent(JSON.stringify(changeDataObj)));
            var assetsDataB64 = btoa(encodeURIComponent(JSON.stringify(assetsData)));
            
            var html = `
                <div class="p-4 rounded-lg mb-3 ${bgClass} border ${cardBorderClass}">
                    ${assetsHtml}
                    <div class="flex justify-between">
                        <div class="flex-1 overflow-hidden">
                            <p class="font-mono text-sm font-bold text-gray-100 mb-1">${escapeHtml(formatFieldPath(change.field_path))}${investigationBadge}${timerBadge2}</p>
                            <p class="text-xs font-semibold uppercase mb-3 px-2 py-1 inline-block rounded
                                ${change.change_type === 'array_modified' ? 'bg-slate-700 text-slate-200' :
                                  change.change_type === 'added' ? 'bg-green-900/50 text-green-300' :
                                  change.change_type === 'removed' ? 'bg-red-900/50 text-red-300' : 'bg-amber-900/50 text-amber-300'}">
                                ${change.change_type.replace('_', ' ')}
                            </p>
            `;
            
            // SMART DISPLAY: Show only added/removed items for array changes
            if (change.change_type === 'array_modified' && (change.items_added || change.items_removed)) {
                if (change.items_removed && change.items_removed.length > 0) {
                    html += `
                        <div class="mb-3">
                            <p class="text-sm font-bold text-red-400 mb-2">‚ûñ REMOVED (${change.items_removed.length}):</p>
                            <div class="max-h-48 overflow-y-auto bg-red-900/30 rounded p-2">
                    `;
                    change.items_removed.forEach(function(item) {
                        html += '<div class="array-item array-item-removed">' + escapeHtml(formatArrayItem(item)) + '</div>';
                    });
                    html += '</div></div>';
                }
                
                if (change.items_added && change.items_added.length > 0) {
                    html += `
                        <div class="mb-3">
                            <p class="text-sm font-bold text-green-700 mb-2">‚ûï ADDED (${change.items_added.length}):</p>
                            <div class="max-h-48 overflow-y-auto bg-green-900/30 rounded p-2">
                    `;
                    change.items_added.forEach(function(item) {
                        html += '<div class="array-item array-item-added">' + escapeHtml(formatArrayItem(item)) + '</div>';
                    });
                    html += '</div></div>';
                }
            } else {
                // Non-array change - show old/new values
                if (change.old_value !== null && change.old_value !== undefined) {
                    html += `
                        <div class="mb-2">
                            <span class="text-xs font-bold text-red-400 block mb-1">OLD VALUE:</span>
                            <div class="font-mono text-sm bg-red-900/30 p-3 rounded border border-red-200 break-all">${escapeHtml(JSON.stringify(change.old_value))}</div>
                        </div>
                    `;
                }
                if (change.new_value !== null && change.new_value !== undefined) {
                    html += `
                        <div class="mb-2">
                            <span class="text-xs font-bold text-green-700 block mb-1">NEW VALUE:</span>
                            <div class="font-mono text-sm bg-green-900/30 p-3 rounded border border-green-200 break-all">${escapeHtml(JSON.stringify(change.new_value))}</div>
                        </div>
                    `;
                }
            }
            
            html += `
                        </div>
                        <div class="flex flex-col items-center gap-2 ml-4 flex-shrink-0">
                            <span class="status-badge status-${status}">${status}</span>
                            <div class="mb-2">
                                <input type="text" class="ticket-input px-2 py-1 text-xs bg-gray-50 border border-gray-200 rounded w-28 text-gray-700 placeholder-gray-400 focus:border-gray-400 focus:outline-none"
                                       data-sig="${escapeHtml(change.signature)}"
                                       placeholder="Ticket #"
                                       title="Per-field ticket # (optional)">
                            </div>
                            <div class="flex flex-col gap-1">
                                <button class="approve-btn px-3 py-2 rounded font-bold text-sm ${status === 'approved' ? 'bg-green-800 text-white' : 'bg-green-900/50 text-green-700 hover:bg-green-200'}"
                                        data-sig="${escapeHtml(change.signature)}"
                                        data-change="${changeDataB64}"
                                        data-assets="${assetsDataB64}">‚úì Approve</button>
                                <button class="investigate-btn px-3 py-2 rounded font-bold text-sm ${status === 'investigation' ? 'bg-blue-700 text-white' : 'bg-blue-900/50 text-blue-300 hover:bg-blue-800'}"
                                        data-sig="${escapeHtml(change.signature)}"
                                        data-change="${changeDataB64}"
                                        data-assets="${assetsDataB64}">üîç Investigate</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function saveTicketValues() {
            // Save per-field ticket inputs
            document.querySelectorAll('.ticket-input').forEach(function(input) {
                var sig = input.getAttribute('data-sig');
                if (sig && input.value.trim()) {
                    ticketValues['field_' + sig] = input.value.trim();
                }
            });
            // Save per-asset ticket inputs
            document.querySelectorAll('.asset-ticket-input').forEach(function(input) {
                var assetId = input.getAttribute('data-asset-id');
                if (assetId && input.value.trim()) {
                    ticketValues['asset_' + assetId] = input.value.trim();
                }
            });
            // Dashboard per-asset inputs
            document.querySelectorAll('.dash-asset-ticket').forEach(function(input) {
                var assetId = input.getAttribute('data-asset-id');
                if (assetId && input.value.trim()) {
                    ticketValues['dash_asset_' + assetId] = input.value.trim();
                }
            });
            // Dashboard per-field inputs
            document.querySelectorAll('.dash-ticket-input').forEach(function(input) {
                var sig = input.getAttribute('data-sig');
                if (sig && input.value.trim()) {
                    ticketValues['dash_field_' + sig] = input.value.trim();
                }
            });
        }

        function restoreTicketValues() {
            // Restore per-field ticket inputs (Changes page)
            document.querySelectorAll('.ticket-input').forEach(function(input) {
                var sig = input.getAttribute('data-sig');
                if (sig && ticketValues['field_' + sig]) {
                    input.value = ticketValues['field_' + sig];
                }
            });
            // Restore per-asset ticket inputs (Changes page)
            document.querySelectorAll('.asset-ticket-input').forEach(function(input) {
                var assetId = input.getAttribute('data-asset-id');
                if (assetId && ticketValues['asset_' + assetId]) {
                    input.value = ticketValues['asset_' + assetId];
                }
            });
            // Dashboard per-asset inputs
            document.querySelectorAll('.dash-asset-ticket').forEach(function(input) {
                var assetId = input.getAttribute('data-asset-id');
                if (assetId && ticketValues['dash_asset_' + assetId]) {
                    input.value = ticketValues['dash_asset_' + assetId];
                }
            });
            // Dashboard per-field inputs
            document.querySelectorAll('.dash-ticket-input').forEach(function(input) {
                var sig = input.getAttribute('data-sig');
                if (sig && ticketValues['dash_field_' + sig]) {
                    input.value = ticketValues['dash_field_' + sig];
                }
            });
        }

        async function reviewChange(signature, status, changeData, assets, notes, ticketNumber) {
            // Validate ticket number is provided
            if (!ticketNumber || !ticketNumber.trim()) {
                alert('Ticket number is required for all change reviews.\n\nPlease enter a ticket number before approving, rejecting, or investigating changes.');
                return;
            }

            try {
                // Save ticket values BEFORE the API call
                saveTicketValues();

                await api('/api/changes/bulk-review', {
                    method: 'POST',
                    body: {
                        signature: signature,
                        status: status,
                        resolution_notes: notes || null,
                        ticket_number: ticketNumber || null
                    }
                });

                reviewDecisions[signature] = status;

                // Enhance for report
                var enhanced = enhanceChangeWithArrayDiff(changeData);
                var report = generateChangeReviewReport(enhanced, assets, status, notes, ticketNumber);
                showReport(status.charAt(0).toUpperCase() + status.slice(1) + ' Report', report);

                // Re-render and restore ticket values after render completes
                setTimeout(function() {
                    render();
                    // Wait longer for async render to complete before restoring
                    setTimeout(restoreTicketValues, 800);
                }, 300);

            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // ============================================================
        // MANUAL COMPARE VIEW
        // ============================================================

        var compareBeforeFile = null;
        var compareAfterFile = null;

        function renderManualCompare(container) {
            var canCompare = compareBeforeFile && compareAfterFile;
            
            container.innerHTML = `
                <div class="min-h-screen" style="background: linear-gradient(180deg, #1a1f2e 0%, #1f2937 100%);">
                    <div class="shadow-lg" style="background: linear-gradient(90deg, #1e3a5f 0%, #1e40af 100%);">
                        <div class="container mx-auto px-4">
                            <div class="flex justify-between items-center h-16">
                                <div class="flex items-center gap-4">
                                    <div>
                                        <h1 class="text-lg font-bold text-white">Fiducia</h1>
                                        <p class="text-xs text-slate-300">Infrastructure Baseline Management</p>
                                    </div>
                                    <div class="border-l border-slate-500 pl-4">
                                        <p class="text-sm text-white">Manual Comparison</p>
                                        <p class="text-xs text-amber-300">No login required</p>
                                    </div>
                                </div>
                                <button id="back-btn" class="px-4 py-2 bg-amber-700 text-slate-900 font-semibold rounded hover:bg-amber-600">‚Üê Back</button>
                            </div>
                        </div>
                    </div>

                    <div class="container mx-auto px-4 py-8 max-w-screen-xl">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-700 border-2 border-blue-700 rounded-lg shadow-lg p-6">
                                <h3 class="text-lg font-semibold mb-4 text-blue-300">1. Before File</h3>
                                <div id="before-area" class="border-2 border-dashed rounded-lg p-6 text-center cursor-pointer ${compareBeforeFile ? 'border-green-500 bg-green-900/30' : 'border-slate-300 hover:border-blue-500'}">
                                    ${compareBeforeFile ?
                                        '<p class="text-green-700 font-medium">' + escapeHtml(compareBeforeFile.name) + '</p><button id="clear-before" class="mt-2 text-red-600 text-sm hover:underline">Clear</button>' :
                                        '<p class="text-slate-500">Drop JSON file here or click</p><input type="file" accept=".json" id="before-input" class="hidden">'}
                                </div>
                            </div>

                            <div class="bg-gray-700 border-2 border-blue-700 rounded-lg shadow-lg p-6">
                                <h3 class="text-lg font-semibold mb-4 text-blue-300">2. After File</h3>
                                <div id="after-area" class="border-2 border-dashed rounded-lg p-6 text-center cursor-pointer ${compareAfterFile ? 'border-green-500 bg-green-900/30' : 'border-slate-300 hover:border-blue-500'}">
                                    ${compareAfterFile ?
                                        '<p class="text-green-700 font-medium">' + escapeHtml(compareAfterFile.name) + '</p><button id="clear-after" class="mt-2 text-red-600 text-sm hover:underline">Clear</button>' :
                                        '<p class="text-slate-500">Drop JSON file here or click</p><input type="file" accept=".json" id="after-input" class="hidden">'}
                                </div>
                            </div>
                        </div>

                        <button id="compare-btn" class="w-full py-4 text-lg font-semibold rounded-lg ${canCompare ? 'bg-blue-800 text-white hover:bg-blue-600' : 'bg-slate-300 text-slate-500 cursor-not-allowed'}" ${canCompare ? '' : 'disabled'}>
                            ${canCompare ? 'üîç Compare Files' : 'Upload both files to compare'}
                        </button>

                        <!-- Visual Diff Results Container -->
                        <div id="compare-results" class="mt-6 hidden"></div>
                    </div>
                </div>
            `;
            
            document.getElementById('back-btn').addEventListener('click', function() {
                compareBeforeFile = null;
                compareAfterFile = null;
                currentView = previousView || 'compliance';  // Go back to where we came from
                render();
            });
            
            if (!compareBeforeFile) {
                setupCompareUpload('before-area', 'before-input', 'before');
            } else {
                document.getElementById('clear-before').addEventListener('click', function(e) {
                    e.stopPropagation();
                    compareBeforeFile = null;
                    render();
                });
            }
            
            if (!compareAfterFile) {
                setupCompareUpload('after-area', 'after-input', 'after');
            } else {
                document.getElementById('clear-after').addEventListener('click', function(e) {
                    e.stopPropagation();
                    compareAfterFile = null;
                    render();
                });
            }
            
            if (canCompare) {
                document.getElementById('compare-btn').addEventListener('click', doManualCompare);
            }
        }

        function setupCompareUpload(areaId, inputId, type) {
            var area = document.getElementById(areaId);
            var input = document.getElementById(inputId);
            
            area.addEventListener('click', function() { input.click(); });
            area.addEventListener('dragover', function(e) { e.preventDefault(); area.classList.add('drop-active'); });
            area.addEventListener('dragleave', function() { area.classList.remove('drop-active'); });
            area.addEventListener('drop', function(e) {
                e.preventDefault();
                area.classList.remove('drop-active');
                if (e.dataTransfer.files.length > 0) loadCompareFile(e.dataTransfer.files[0], type);
            });
            input.addEventListener('change', function(e) {
                if (e.target.files.length > 0) loadCompareFile(e.target.files[0], type);
            });
        }

        function loadCompareFile(file, type) {
            if (!file.name.endsWith('.json')) {
                alert('Please select a JSON file');
                return;
            }
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var content = JSON.parse(e.target.result);
                    if (type === 'before') {
                        compareBeforeFile = { name: file.name, content: content };
                    } else {
                        compareAfterFile = { name: file.name, content: content };
                    }
                    render();
                } catch (err) {
                    alert('Error parsing JSON: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        var lastCompareResult = null;

        async function doManualCompare() {
            var resultsDiv = document.getElementById('compare-results');
            resultsDiv.innerHTML = '<p class="text-gray-400 text-center py-4">Comparing...</p>';
            resultsDiv.classList.remove('hidden');

            try {
                var result = await api('/api/compare', {
                    method: 'POST',
                    body: {
                        old_config: compareBeforeFile.content,
                        new_config: compareAfterFile.content
                    }
                });

                // Enhance changes with smart array diff
                result.changes = result.changes.map(enhanceChangeWithArrayDiff);
                lastCompareResult = result;

                // Build visual diff display
                var html = '';

                if (result.is_identical) {
                    html = `
                        <div class="bg-green-900/50 border border-green-400 rounded-lg p-6 text-center">
                            <p class="text-2xl text-green-700 font-bold mb-2">‚úÖ No Differences Found</p>
                            <p class="text-green-600">The two files are identical.</p>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="bg-amber-900/30 border border-yellow-400 rounded-lg p-4 mb-4">
                            <p class="text-lg font-bold text-amber-300">‚ö†Ô∏è ${result.change_count} Difference(s) Found</p>
                        </div>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                    `;

                    result.changes.forEach(function(change, i) {
                        var bgClass = change.change_type === 'added' ? 'diff-added' :
                                     change.change_type === 'removed' ? 'diff-removed' : 'diff-modified';
                        var typeClass = change.change_type === 'added' ? 'bg-green-900/50 text-green-300' :
                                       change.change_type === 'removed' ? 'bg-red-900/50 text-red-300' :
                                       change.change_type === 'array_modified' ? 'bg-slate-700 text-slate-200' : 'bg-amber-900/50 text-amber-300';

                        html += '<div class="p-4 rounded-lg ' + bgClass + ' border border-gray-300">';
                        html += '<p class="font-mono text-sm font-bold text-gray-100 mb-1">' + escapeHtml(change.path) + '</p>';
                        html += '<p class="text-xs font-semibold uppercase mb-3 px-2 py-1 inline-block rounded ' + typeClass + '">' + change.change_type.replace('_', ' ') + '</p>';

                        if (change.change_type === 'array_modified' && (change.items_added || change.items_removed)) {
                            if (change.items_removed && change.items_removed.length > 0) {
                                html += '<div class="mb-3"><p class="text-sm font-bold text-red-400 mb-2">‚ûñ REMOVED (' + change.items_removed.length + '):</p>';
                                html += '<div class="max-h-32 overflow-y-auto bg-red-900/30 rounded p-2">';
                                change.items_removed.forEach(function(item) {
                                    html += '<div class="text-sm font-mono text-red-300 py-1 border-b border-red-200">- ' + escapeHtml(formatArrayItem(item)) + '</div>';
                                });
                                html += '</div></div>';
                            }
                            if (change.items_added && change.items_added.length > 0) {
                                html += '<div class="mb-3"><p class="text-sm font-bold text-green-700 mb-2">‚ûï ADDED (' + change.items_added.length + '):</p>';
                                html += '<div class="max-h-32 overflow-y-auto bg-green-900/30 rounded p-2">';
                                change.items_added.forEach(function(item) {
                                    html += '<div class="text-sm font-mono text-green-300 py-1 border-b border-green-200">+ ' + escapeHtml(formatArrayItem(item)) + '</div>';
                                });
                                html += '</div></div>';
                            }
                        } else {
                            if (change.old_value !== null && change.old_value !== undefined) {
                                html += '<div class="mb-2"><span class="text-sm font-semibold text-red-400">Old:</span> <span class="font-mono text-sm bg-red-900/30 px-2 py-1 rounded">' + escapeHtml(JSON.stringify(change.old_value)) + '</span></div>';
                            }
                            if (change.new_value !== null && change.new_value !== undefined) {
                                html += '<div><span class="text-sm font-semibold text-green-700">New:</span> <span class="font-mono text-sm bg-green-900/30 px-2 py-1 rounded">' + escapeHtml(JSON.stringify(change.new_value)) + '</span></div>';
                            }
                        }

                        html += '</div>';
                    });

                    html += '</div>';
                }

                // Add Generate Report button
                html += `
                    <button id="generate-report-btn" class="w-full mt-4 py-3 bg-bbt-gold text-black font-semibold rounded-lg hover:bg-amber-600">
                        üìÑ Generate Text Report
                    </button>
                `;

                resultsDiv.innerHTML = html;

                // Add event listener for report button
                document.getElementById('generate-report-btn').addEventListener('click', function() {
                    var report = generateManualCompareReport(lastCompareResult);
                    showReport('Manual Comparison Report', report);
                });

            } catch (err) {
                resultsDiv.innerHTML = '<div class="bg-red-900/50 border border-red-400 text-red-400 p-4 rounded">Comparison failed: ' + escapeHtml(err.message) + '</div>';
            }
        }

        function generateManualCompareReport(result) {
            var lines = [
                generateReportHeader('MANUAL FILE COMPARISON'),
                'Before:       ' + compareBeforeFile.name,
                'After:        ' + compareAfterFile.name,
                ''
            ];
            
            if (result.is_identical) {
                lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                lines.push('RESULT: NO DIFFERENCES FOUND');
                lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                lines.push('');
                lines.push('The two files are identical.');
            } else {
                lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                lines.push('RESULT: ' + result.change_count + ' DIFFERENCE(S) FOUND');
                lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                lines.push('');
                
                result.changes.forEach(function(change, i) {
                    lines.push('Change #' + (i + 1));
                    lines.push('  Field:       ' + change.path);
                    lines.push('  Type:        ' + change.change_type.toUpperCase().replace('_', ' '));
                    
                    if (change.change_type === 'array_modified' && (change.items_added || change.items_removed)) {
                        if (change.items_removed && change.items_removed.length > 0) {
                            lines.push('  ‚ûñ Removed (' + change.items_removed.length + '):');
                            change.items_removed.forEach(function(item) {
                                lines.push('    - ' + formatArrayItem(item));
                            });
                        }
                        if (change.items_added && change.items_added.length > 0) {
                            lines.push('  ‚ûï Added (' + change.items_added.length + '):');
                            change.items_added.forEach(function(item) {
                                lines.push('    + ' + formatArrayItem(item));
                            });
                        }
                    } else {
                        if (change.old_value !== null) lines.push('  Old Value:   ' + JSON.stringify(change.old_value));
                        if (change.new_value !== null) lines.push('  New Value:   ' + JSON.stringify(change.new_value));
                    }
                    
                    lines.push('');
                });
            }
            
            lines.push(generateReportFooter());
            return lines.join('\n');
        }

        // ============================================================
        // SETTINGS VIEW (Admin Only)
        // ============================================================

        async function renderSettings(container) {
            container.innerHTML = '<div class="text-center py-12"><p class="text-gray-300">Loading settings...</p></div>';

            try {
                // Load current settings
                var settings = {};
                try {
                    settings = await api('/api/system/settings');
                } catch (e) {
                    // Settings may be empty initially
                }

                var watchFolderPath = settings.watch_folder_path ? settings.watch_folder_path.value : '';
                var scanInterval = settings.scan_interval_minutes ? settings.scan_interval_minutes.value : '5';

                // Load database info
                var dbInfo = {};
                try {
                    dbInfo = await api('/api/system/database');
                } catch (e) {
                    dbInfo = { type: 'unknown', status: 'error', error: e.message };
                }

                container.innerHTML = `
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-2" style="font-family: 'Rajdhani', sans-serif; letter-spacing: 0.05em; color: #60a5fa;">
                            Settings
                        </h2>
                        <p class="text-gray-300 text-sm">System configuration (Admin only)</p>
                    </div>

                    <div class="bg-gray-700 rounded-lg shadow-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center cursor-pointer" onclick="toggleSection('watchfolder')">
                            <span class="text-amber-500 mr-2">üìÅ</span>
                            Watch Folder Configuration
                            <svg id="watchfolder-chevron" class="w-5 h-5 ml-auto text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </h3>
                        <div id="watchfolder-content">
                            <p class="text-sm text-gray-300 mb-4">
                                Configure a folder path for the system to periodically scan for new baseline JSON files.
                                The system will check this folder every 5 minutes for new files.
                            </p>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Watch Folder Path</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="watch-folder-path"
                                               class="flex-1 px-4 py-2 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-gray-200"
                                               placeholder="/path/to/watch/folder"
                                               value="${escapeHtml(watchFolderPath)}">
                                        <button id="save-watch-folder-btn"
                                                class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                            Save
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-300 mt-1">Enter the full absolute path to the folder to watch</p>
                                </div>

                                <div class="flex items-center gap-4 pt-4 border-t border-gray-600">
                                    <button id="scan-now-btn"
                                            class="px-4 py-2 bg-green-800 text-white rounded-lg hover:bg-green-600 transition-colors"
                                            ${!watchFolderPath ? 'disabled' : ''}>
                                        Scan Now
                                    </button>
                                    <span id="scan-status" class="text-sm text-gray-300"></span>
                                </div>
                            </div>

                            <div id="scan-results" class="bg-gray-800 rounded-lg p-4 border border-gray-600 mt-4 hidden">
                                <h4 class="text-md font-semibold text-white mb-2">Last Scan Results</h4>
                                <div id="scan-results-content" class="text-gray-300"></div>
                            </div>
                        </div>
                    </div>

                    <!-- LDAP Configuration -->
                    <div class="bg-gray-700 rounded-lg shadow-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center cursor-pointer" onclick="toggleSection('ldap')">
                            <span class="text-blue-400 mr-2">üîê</span>
                            LDAP Authentication
                            <svg id="ldap-chevron" class="w-5 h-5 ml-auto text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </h3>
                        <div id="ldap-content">
                            <p class="text-sm text-gray-300 mb-4">
                                Configure LDAP/Active Directory authentication. Users will be authenticated against LDAP first,
                                with credentials cached for offline access. LDAP group membership determines user roles.
                            </p>

                            <div class="space-y-4">
                                <!-- Enable LDAP -->
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="ldap-enabled" class="w-5 h-5 text-blue-600 rounded bg-gray-700 border-gray-600"
                                       ${settings.ldap_enabled && settings.ldap_enabled.value === 'true' ? 'checked' : ''}>
                                <label class="text-sm font-medium text-gray-300">Enable LDAP Authentication</label>
                            </div>

                            <div id="ldap-config-fields" class="${settings.ldap_enabled && settings.ldap_enabled.value === 'true' ? '' : 'opacity-50'}">
                                <!-- Server Settings -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">LDAP Server</label>
                                        <input type="text" id="ldap-server"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="ldap.example.com"
                                               value="${escapeHtml(settings.ldap_server ? settings.ldap_server.value || '' : '')}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Port</label>
                                        <input type="text" id="ldap-port"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="389"
                                               value="${escapeHtml(settings.ldap_port ? settings.ldap_port.value || '389' : '389')}">
                                    </div>
                                    <div class="flex items-end gap-3 pb-2">
                                        <input type="checkbox" id="ldap-use-ssl" class="w-5 h-5 text-blue-600 rounded bg-gray-700 border-gray-600"
                                               ${settings.ldap_use_ssl && settings.ldap_use_ssl.value === 'true' ? 'checked' : ''}>
                                        <label class="text-sm font-medium text-gray-300">Use SSL/TLS</label>
                                    </div>
                                </div>

                                <!-- Bind Credentials -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Bind DN (Service Account)</label>
                                        <input type="text" id="ldap-bind-dn"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="CN=svc_ldap,OU=Service Accounts,DC=example,DC=com"
                                               value="${escapeHtml(settings.ldap_bind_dn ? settings.ldap_bind_dn.value || '' : '')}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Bind Password</label>
                                        <input type="password" id="ldap-bind-password"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                               value="${settings.ldap_bind_password ? '********' : ''}">
                                    </div>
                                </div>

                                <!-- Search Base DNs -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">User Base DN</label>
                                        <input type="text" id="ldap-user-base-dn"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="OU=Users,DC=example,DC=com"
                                               value="${escapeHtml(settings.ldap_user_base_dn ? settings.ldap_user_base_dn.value || '' : '')}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Group Base DN</label>
                                        <input type="text" id="ldap-group-base-dn"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="OU=Groups,DC=example,DC=com"
                                               value="${escapeHtml(settings.ldap_group_base_dn ? settings.ldap_group_base_dn.value || '' : '')}">
                                    </div>
                                </div>

                                <!-- Filters -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">User Filter</label>
                                        <input type="text" id="ldap-user-filter"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="(sAMAccountName={username})"
                                               value="${escapeHtml(settings.ldap_user_filter ? settings.ldap_user_filter.value || '(sAMAccountName={username})' : '(sAMAccountName={username})')}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Group Filter</label>
                                        <input type="text" id="ldap-group-filter"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="(&(objectClass=group)(member={user_dn}))"
                                               value="${escapeHtml(settings.ldap_group_filter ? settings.ldap_group_filter.value || '(&(objectClass=group)(member={user_dn}))' : '(&(objectClass=group)(member={user_dn}))')}">
                                    </div>
                                </div>

                                <!-- Group Mapping -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Admin Groups (comma-separated)</label>
                                    <input type="text" id="ldap-admin-groups"
                                           class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                           placeholder="IT-Admins, Domain Admins"
                                           value="${escapeHtml(settings.ldap_admin_groups ? settings.ldap_admin_groups.value || '' : '')}">
                                    <p class="text-xs text-gray-300 mt-1">Users in these groups get admin role</p>
                                </div>

                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Group Mapping (JSON)</label>
                                    <textarea id="ldap-group-mapping"
                                              class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm font-mono bg-gray-700 text-gray-200"
                                              rows="4"
                                              placeholder='{"Server-Team": "server", "Network-Team": "network", "Telecom-Team": "telecom", "Desktop-Team": "desktop"}'>${escapeHtml(settings.ldap_group_mapping ? settings.ldap_group_mapping.value || '{}' : '{}')}</textarea>
                                    <p class="text-xs text-gray-300 mt-1">Maps LDAP group names to app groups (server, network, telecom, desktop)</p>
                                </div>

                                <!-- Cache Settings -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Offline Cache Duration (hours)</label>
                                    <input type="number" id="ldap-cache-hours"
                                           class="w-32 px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                           placeholder="168"
                                           value="${escapeHtml(settings.ldap_cache_hours ? settings.ldap_cache_hours.value || '168' : '168')}">
                                    <p class="text-xs text-gray-300 mt-1">Cached credentials expire after this many hours (default: 168 = 7 days)</p>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex items-center gap-4 pt-4 border-t border-gray-600">
                                <button id="save-ldap-btn"
                                        class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    Save LDAP Settings
                                </button>
                                <button id="test-ldap-btn"
                                        class="px-4 py-2 bg-green-800 text-white rounded-lg hover:bg-green-600 transition-colors">
                                    Test Connection
                                </button>
                                <span id="ldap-status" class="text-sm text-gray-300"></span>
                            </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="bg-gray-700 rounded-lg shadow-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center cursor-pointer" onclick="toggleSection('users')">
                            <span class="text-slate-400 mr-2">üë•</span>
                            User Management
                            <svg id="users-chevron" class="w-5 h-5 ml-auto text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </h3>
                        <div id="users-content">
                            <p class="text-sm text-gray-300 mb-4">
                            Create and manage local user accounts. Users can be assigned as Admins (full access) or
                            Baseline Experts (can review changes for their assigned team). LDAP users are managed through
                            Active Directory - password resets here only affect local/cached credentials.
                        </p>

                        <div class="space-y-4">
                            <!-- Create New User Form -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600">
                                <h4 class="text-sm font-semibold text-gray-200 mb-3">Create New User</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Username</label>
                                        <input type="text" id="new-user-username"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="jsmith">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Full Name</label>
                                        <input type="text" id="new-user-fullname"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="John Smith">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Password</label>
                                        <input type="password" id="new-user-password"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Role</label>
                                        <select id="new-user-role"
                                                class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200">
                                            <option value="baseline_expert">Baseline Expert</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button id="create-user-btn"
                                            class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500 transition-colors text-sm">
                                        Create User
                                    </button>
                                    <span id="create-user-status" class="text-sm"></span>
                                </div>
                            </div>

                            <!-- User List -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-sm font-semibold text-gray-200">Existing Users</h4>
                                    <button id="refresh-users-btn" class="text-xs text-blue-400 hover:underline">Refresh</button>
                                </div>
                                <div id="users-list" class="space-y-2">
                                    <p class="text-sm text-gray-400">Loading users...</p>
                                </div>
                            </div>

                            <!-- Password Reset -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600">
                                <h4 class="text-sm font-semibold text-gray-200 mb-3">Reset User Password</h4>
                                <p class="text-xs text-gray-400 mb-3">
                                    Reset the local password for any user. For LDAP users, this sets a fallback password
                                    used only when LDAP is unavailable.
                                </p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Username</label>
                                        <select id="reset-user-select"
                                                class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200">
                                            <option value="">Select user...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">New Password</label>
                                        <input type="password" id="reset-user-password"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <div class="flex items-end">
                                        <button id="reset-password-btn"
                                                class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-700 transition-colors text-sm">
                                            Reset Password
                                        </button>
                                    </div>
                                </div>
                                <span id="reset-password-status" class="text-sm"></span>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Email Notifications -->
                    <div class="bg-gray-700 rounded-lg shadow-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center cursor-pointer" onclick="toggleSection('email')">
                            <span class="text-blue-400 mr-2">üìß</span>
                            Email Notifications
                            <svg id="email-chevron" class="w-5 h-5 ml-auto text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </h3>
                        <div id="email-content">
                            <p class="text-sm text-gray-300 mb-4">
                                Configure SMTP email settings to receive compliance alerts. Notifications are sent when assets
                                approach their compliance deadline, when deadlines are exceeded, and as weekly summary reports.
                            </p>

                            <div class="space-y-4">
                            <!-- SMTP Configuration -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600">
                                <h4 class="text-sm font-semibold text-gray-200 mb-3">SMTP Server Configuration</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                    <div class="lg:col-span-2">
                                        <label class="block text-xs font-medium text-gray-300 mb-1">SMTP Server</label>
                                        <input type="text" id="smtp-server"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="mail.example.com">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Port</label>
                                        <input type="number" id="smtp-port"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="587" value="587">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Security</label>
                                        <select id="smtp-security"
                                                class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200">
                                            <option value="tls">STARTTLS (Port 587)</option>
                                            <option value="ssl">SSL/TLS (Port 465)</option>
                                            <option value="none">None (Port 25)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Username</label>
                                        <input type="text" id="smtp-username"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="user@example.com">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Password</label>
                                        <input type="password" id="smtp-password"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">From Address</label>
                                        <input type="email" id="smtp-from-address"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="noreply@example.com">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">From Name</label>
                                        <input type="text" id="smtp-from-name"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="Fiducia" value="Fiducia">
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="smtp-enabled" class="w-4 h-4 rounded border-gray-600 bg-gray-700">
                                        <span class="text-sm text-gray-300">Enable Email Notifications</span>
                                    </label>
                                    <button id="save-smtp-btn"
                                            class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                        Save SMTP Settings
                                    </button>
                                    <button id="test-smtp-btn"
                                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition-colors text-sm">
                                        Test Connection
                                    </button>
                                    <span id="smtp-status" class="text-sm text-gray-300"></span>
                                </div>
                            </div>

                            <!-- Test Email -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600">
                                <h4 class="text-sm font-semibold text-gray-200 mb-3">Send Test Email</h4>
                                <div class="flex items-center gap-4">
                                    <input type="email" id="test-email-address"
                                           class="flex-grow px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                           placeholder="recipient@example.com">
                                    <button id="send-test-email-btn"
                                            class="px-4 py-2 bg-green-800 text-white rounded-lg hover:bg-green-600 transition-colors text-sm">
                                        Send Test Email
                                    </button>
                                    <span id="test-email-status" class="text-sm text-gray-300"></span>
                                </div>
                            </div>

                            <!-- Alert Recipients -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600">
                                <h4 class="text-sm font-semibold text-gray-200 mb-3">Alert Recipients</h4>
                                <p class="text-xs text-gray-400 mb-3">
                                    Enter comma-separated email addresses for each group. Both groups receive all alerts.
                                </p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Compliance Team Emails</label>
                                        <input type="text" id="alert-emails-compliance"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="compliance@example.com, team@example.com">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Manager Emails</label>
                                        <input type="text" id="alert-emails-managers"
                                               class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               placeholder="manager@example.com, director@example.com">
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button id="save-alert-recipients-btn"
                                            class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                        Save Recipients
                                    </button>
                                    <span id="alert-recipients-status" class="text-sm"></span>
                                </div>
                            </div>

                            <!-- Alert Types -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600">
                                <h4 class="text-sm font-semibold text-gray-200 mb-3">Alert Types</h4>
                                <div class="space-y-3">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" id="alert-approaching-enabled" checked class="w-4 h-4 rounded border-gray-600 bg-gray-700">
                                        <div>
                                            <span class="text-sm text-gray-200">Approaching Deadline Alerts</span>
                                            <p class="text-xs text-gray-400">Sent when assets enter warning threshold (default: 5 days remaining)</p>
                                        </div>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" id="alert-failed-enabled" checked class="w-4 h-4 rounded border-gray-600 bg-gray-700">
                                        <div>
                                            <span class="text-sm text-gray-200">Failed/Overdue Alerts</span>
                                            <p class="text-xs text-gray-400">Sent immediately when assets exceed the 30-day compliance window</p>
                                        </div>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" id="alert-weekly-enabled" checked class="w-4 h-4 rounded border-gray-600 bg-gray-700">
                                        <div>
                                            <span class="text-sm text-gray-200">Weekly Investigation Report</span>
                                            <p class="text-xs text-gray-400">Summary of all compliance status sent on schedule below</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Weekly Report Schedule -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600">
                                <h4 class="text-sm font-semibold text-gray-200 mb-3">Weekly Report Schedule</h4>
                                <div class="flex items-center gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Day</label>
                                        <select id="alert-weekly-day"
                                                class="px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200">
                                            <option value="0">Monday</option>
                                            <option value="1">Tuesday</option>
                                            <option value="2">Wednesday</option>
                                            <option value="3">Thursday</option>
                                            <option value="4">Friday</option>
                                            <option value="5">Saturday</option>
                                            <option value="6">Sunday</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-300 mb-1">Time</label>
                                        <input type="time" id="alert-weekly-time"
                                               class="px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                               value="08:00">
                                    </div>
                                    <div class="flex items-end gap-4">
                                        <button id="save-alert-settings-btn"
                                                class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                            Save Alert Settings
                                        </button>
                                        <span id="alert-settings-status" class="text-sm"></span>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>

                    <!-- Syslog Configuration -->
                    <div class="bg-gray-700 rounded-lg shadow-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center cursor-pointer" onclick="toggleSection('syslog')">
                            <span class="text-slate-400 mr-2">üì°</span>
                            Syslog Forwarding
                            <svg id="syslog-chevron" class="w-5 h-5 ml-auto text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </h3>
                        <div id="syslog-content">
                            <p class="text-sm text-gray-300 mb-4">
                                Forward audit events to a remote syslog server using RFC 5424 format. Supports UDP, TCP, and TLS protocols.
                                Enable or disable specific event types to control what gets forwarded.
                            </p>

                            <div class="space-y-4">
                                <!-- Enable Syslog -->
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="syslog-enabled" class="w-5 h-5 text-blue-600 rounded bg-gray-700 border-gray-600">
                                    <label class="text-sm font-medium text-gray-300">Enable Syslog Forwarding</label>
                                </div>

                                <div id="syslog-config-fields" class="opacity-50">
                                    <!-- Server Settings -->
                                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-600 mb-4">
                                        <h4 class="text-sm font-semibold text-gray-200 mb-3">Server Configuration</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                            <div class="md:col-span-2">
                                                <label class="block text-xs font-medium text-gray-300 mb-1">Syslog Server</label>
                                                <input type="text" id="syslog-server"
                                                       class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                                       placeholder="syslog.example.com">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-300 mb-1">Port</label>
                                                <input type="number" id="syslog-port"
                                                       class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                                       placeholder="514" value="514">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-300 mb-1">Protocol</label>
                                                <select id="syslog-protocol"
                                                        class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200">
                                                    <option value="udp">UDP (Port 514)</option>
                                                    <option value="tcp">TCP (Port 514)</option>
                                                    <option value="tls">TLS (Port 6514)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-300 mb-1">Facility</label>
                                                <select id="syslog-facility"
                                                        class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200">
                                                    <option value="16">LOCAL0 (16) - Default</option>
                                                    <option value="17">LOCAL1 (17)</option>
                                                    <option value="18">LOCAL2 (18)</option>
                                                    <option value="19">LOCAL3 (19)</option>
                                                    <option value="20">LOCAL4 (20)</option>
                                                    <option value="21">LOCAL5 (21)</option>
                                                    <option value="22">LOCAL6 (22)</option>
                                                    <option value="23">LOCAL7 (23)</option>
                                                    <option value="4">AUTH (4)</option>
                                                    <option value="10">AUTHPRIV (10)</option>
                                                </select>
                                            </div>
                                            <div id="syslog-tls-options" class="hidden">
                                                <label class="block text-xs font-medium text-gray-300 mb-1">TLS Options</label>
                                                <div class="flex items-center gap-4">
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" id="syslog-tls-verify" checked class="w-4 h-4 rounded border-gray-600 bg-gray-700">
                                                        <span class="text-sm text-gray-300">Verify Certificate</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Event Configuration -->
                                    <div class="p-4 bg-gray-800 rounded-lg border border-gray-600 mb-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="text-sm font-semibold text-gray-200">Event Types to Forward</h4>
                                            <div class="flex gap-2">
                                                <button id="syslog-select-all" class="text-xs px-2 py-1 bg-gray-600 text-gray-200 rounded hover:bg-gray-500">Select All</button>
                                                <button id="syslog-select-none" class="text-xs px-2 py-1 bg-gray-600 text-gray-200 rounded hover:bg-gray-500">Select None</button>
                                            </div>
                                        </div>
                                        <div id="syslog-events-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                            <!-- Events populated by JavaScript -->
                                            <p class="text-gray-400 text-sm col-span-full">Loading event types...</p>
                                        </div>
                                    </div>

                                    <!-- Actions -->
                                    <div class="flex items-center gap-4">
                                        <button id="save-syslog-btn"
                                                class="px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500 transition-colors text-sm">
                                            Save Syslog Settings
                                        </button>
                                        <button id="test-syslog-btn"
                                                class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500 transition-colors text-sm">
                                            Test Connection
                                        </button>
                                        <span id="syslog-status" class="text-sm text-gray-300"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CIP-010 Compliance Check Schedule -->
                    <div class="bg-gray-700 rounded-lg shadow-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center cursor-pointer" onclick="toggleSection('compliance')">
                            <span class="text-green-500 mr-2">üìã</span>
                            CIP-010 Compliance Check Schedule
                            <svg id="compliance-chevron" class="w-5 h-5 ml-auto text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </h3>
                        <div id="compliance-content">
                            <p class="text-sm text-gray-300 mb-4">
                                Configure automated baseline compliance checks. On scheduled days, the system compares each asset's
                                latest record against its approved baseline. If changes are detected, an investigation is automatically opened.
                                This is your CIP-010 baseline monitoring function.
                            </p>

                            <div class="space-y-4">
                            <!-- Enable Auto-Check -->
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="compliance-check-enabled" class="w-5 h-5 text-blue-600 rounded bg-gray-700 border-gray-600"
                                       ${settings.compliance_check_enabled && settings.compliance_check_enabled.value === 'true' ? 'checked' : 'checked'}>
                                <label class="text-sm font-medium text-gray-300">Enable Automated Compliance Checks</label>
                            </div>

                            <!-- Schedule Configuration -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600 mb-4">
                                <h4 class="text-sm font-semibold text-gray-200 mb-3">Schedule Configuration</h4>

                                <!-- Schedule Type Selection -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Schedule Type</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="schedule-type" id="schedule-type-day" value="day_of_month"
                                                   class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600"
                                                   ${(settings.compliance_check_type && settings.compliance_check_type.value === 'weekday_pattern') ? '' : 'checked'}>
                                            <span class="text-sm text-gray-300">Day of Month</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="schedule-type" id="schedule-type-weekday" value="weekday_pattern"
                                                   class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600"
                                                   ${(settings.compliance_check_type && settings.compliance_check_type.value === 'weekday_pattern') ? 'checked' : ''}>
                                            <span class="text-sm text-gray-300">Weekday Pattern (e.g., 1st & 3rd Tuesday)</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Day of Month Options -->
                                <div id="day-of-month-options" class="${(settings.compliance_check_type && settings.compliance_check_type.value === 'weekday_pattern') ? 'hidden' : ''}">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-1">Check Days (comma-separated)</label>
                                            <input type="text" id="compliance-check-days"
                                                   class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                                   placeholder="1,15"
                                                   value="${escapeHtml(settings.compliance_check_days ? settings.compliance_check_days.value || '1,15' : '1,15')}">
                                            <p class="text-xs text-gray-400 mt-1">Days of month to run checks (e.g., 1,15 for 1st and 15th)</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-1">Check Time</label>
                                            <div class="flex gap-2">
                                                <input type="number" id="compliance-check-hour"
                                                       class="w-20 px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                                       min="0" max="23" placeholder="2"
                                                       value="${escapeHtml(settings.compliance_check_hour ? settings.compliance_check_hour.value || '2' : '2')}">
                                                <span class="py-2 text-gray-300">:</span>
                                                <input type="number" id="compliance-check-minute"
                                                       class="w-20 px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                                       min="0" max="59" placeholder="0"
                                                       value="${escapeHtml(settings.compliance_check_minute ? settings.compliance_check_minute.value || '0' : '0')}">
                                            </div>
                                            <p class="text-xs text-gray-400 mt-1">Time to run checks (24-hour format)</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Weekday Pattern Options -->
                                <div id="weekday-pattern-options" class="${(settings.compliance_check_type && settings.compliance_check_type.value === 'weekday_pattern') ? '' : 'hidden'}">
                                    <p class="text-xs text-gray-400 mb-3">Configure which weekdays of the month to run compliance checks (e.g., 1st and 3rd Tuesday).</p>

                                    <div id="weekday-patterns-container" class="space-y-3">
                                        <!-- Pattern rows will be added here -->
                                    </div>

                                    <button type="button" id="add-weekday-pattern" class="mt-3 px-3 py-1 text-sm bg-gray-600 text-gray-200 rounded hover:bg-gray-500">
                                        + Add Pattern
                                    </button>

                                    <div class="mt-4">
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Check Time</label>
                                        <div class="flex gap-2">
                                            <input type="number" id="compliance-check-hour-weekday"
                                                   class="w-20 px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                                   min="0" max="23" placeholder="2"
                                                   value="${escapeHtml(settings.compliance_check_hour ? settings.compliance_check_hour.value || '2' : '2')}">
                                            <span class="py-2 text-gray-300">:</span>
                                            <input type="number" id="compliance-check-minute-weekday"
                                                   class="w-20 px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                                   min="0" max="59" placeholder="0"
                                                   value="${escapeHtml(settings.compliance_check_minute ? settings.compliance_check_minute.value || '0' : '0')}">
                                        </div>
                                        <p class="text-xs text-gray-400 mt-1">Time to run checks (24-hour format)</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Investigation Behavior Settings -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600 mt-4">
                                <h4 class="text-sm font-semibold text-gray-200 mb-3">Investigation Behavior</h4>
                                <div class="space-y-3">
                                    <div class="flex items-start gap-3">
                                        <input type="checkbox" id="require-resolution-notes" class="w-5 h-5 mt-0.5 text-blue-600 rounded bg-gray-700 border-gray-600"
                                               ${settings.require_resolution_notes && settings.require_resolution_notes.value === 'true' ? 'checked' : ''}>
                                        <div>
                                            <label class="text-sm font-medium text-gray-300">Require Resolution Notes</label>
                                            <p class="text-xs text-gray-400">Users must provide notes when approving or rejecting changes. Improves audit trail.</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <input type="checkbox" id="auto-pnci-on-failure" class="w-5 h-5 mt-0.5 text-blue-600 rounded bg-gray-700 border-gray-600"
                                               ${settings.auto_pnci_on_failure && settings.auto_pnci_on_failure.value === 'true' ? 'checked' : ''}>
                                        <div>
                                            <label class="text-sm font-medium text-gray-300">Auto-Generate PNCI Report on Failure</label>
                                            <p class="text-xs text-gray-400">Automatically create a PNCI report when an asset moves to FAILED status.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Deadline Extension Settings -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600 mt-4">
                                <h4 class="text-sm font-semibold text-gray-200 mb-3">Deadline Management</h4>
                                <div class="space-y-3">
                                    <div class="flex items-start gap-3">
                                        <input type="checkbox" id="allow-deadline-extension" class="w-5 h-5 mt-0.5 text-blue-600 rounded bg-gray-700 border-gray-600"
                                               ${settings.allow_deadline_extension && settings.allow_deadline_extension.value === 'true' ? 'checked' : ''}>
                                        <div>
                                            <label class="text-sm font-medium text-gray-300">Allow Deadline Extensions</label>
                                            <p class="text-xs text-gray-400">Permit authorized users to extend compliance deadlines with justification.</p>
                                        </div>
                                    </div>
                                    <div class="ml-8 ${settings.allow_deadline_extension && settings.allow_deadline_extension.value === 'true' ? '' : 'opacity-50'}">
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Maximum Extension</label>
                                        <div class="flex items-center gap-2">
                                            <input type="number" id="max-extension-days"
                                                   class="w-20 px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                                   min="1" max="90"
                                                   value="${escapeHtml(settings.max_extension_days ? settings.max_extension_days.value || '15' : '15')}"
                                                   ${settings.allow_deadline_extension && settings.allow_deadline_extension.value === 'true' ? '' : 'disabled'}>
                                            <span class="text-sm text-gray-400">days</span>
                                        </div>
                                        <p class="text-xs text-gray-400 mt-1">Maximum days that can be added to a compliance deadline</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Dashboard & Reporting Settings -->
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-600 mt-4">
                                <h4 class="text-sm font-semibold text-gray-200 mb-3">Dashboard & Reporting</h4>
                                <div class="space-y-3">
                                    <div class="flex items-start gap-3">
                                        <input type="checkbox" id="show-compliance-percentage" class="w-5 h-5 mt-0.5 text-blue-600 rounded bg-gray-700 border-gray-600"
                                               ${settings.show_compliance_percentage && settings.show_compliance_percentage.value === 'true' ? 'checked' : 'checked'}>
                                        <div>
                                            <label class="text-sm font-medium text-gray-300">Show Compliance Percentage</label>
                                            <p class="text-xs text-gray-400">Display overall compliance percentage on the dashboard.</p>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Historical Data Retention</label>
                                        <div class="flex items-center gap-2">
                                            <input type="number" id="historical-retention-days"
                                                   class="w-24 px-3 py-2 border border-gray-600 rounded-lg text-sm bg-gray-700 text-gray-200"
                                                   min="30" max="3650"
                                                   value="${escapeHtml(settings.historical_retention_days ? settings.historical_retention_days.value || '365' : '365')}">
                                            <span class="text-sm text-gray-400">days</span>
                                        </div>
                                        <p class="text-xs text-gray-400 mt-1">Number of days to retain historical compliance data for reporting</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Investigation Behavior Info -->
                            <div class="p-4 bg-amber-900/30 rounded-lg border border-amber-600 mt-4">
                                <h4 class="text-sm font-semibold text-amber-500 mb-2">How Investigations Work</h4>
                                <p class="text-xs text-amber-300/80 mb-2">
                                    When changes are detected during a scheduled check:
                                </p>
                                <ul class="text-xs text-amber-300/80 list-disc list-inside space-y-1">
                                    <li>An investigation is automatically opened for the asset</li>
                                    <li>The compliance deadline is set based on your Compliance Window setting</li>
                                    <li>Status colors update based on your threshold settings</li>
                                    <li>Asset moves to FAILED if not resolved before deadline</li>
                                </ul>
                            </div>

                            <!-- Actions -->
                            <div class="flex items-center gap-4 pt-4 border-t border-gray-600 mt-4">
                                <button id="save-compliance-btn"
                                        class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                    Save All Settings
                                </button>
                                <button id="run-compliance-now-btn"
                                        class="px-4 py-2 bg-green-800 text-white rounded-lg hover:bg-green-600 transition-colors">
                                    Run Check Now
                                </button>
                                <span id="compliance-status" class="text-sm text-gray-300"></span>
                            </div>

                            <!-- Last Check Results -->
                            <div id="last-compliance-check" class="mt-4 p-4 bg-gray-800 rounded-lg border border-gray-600 hidden">
                                <h4 class="text-sm font-semibold text-gray-200 mb-2">Last Compliance Check</h4>
                                <div id="last-compliance-content"></div>
                            </div>
                            </div>
                        </div>
                    </div>

                    <!-- Database Configuration -->
                    <div class="bg-gray-700 rounded-lg shadow-lg p-6 mb-6 border border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-200 mb-4 flex items-center cursor-pointer" onclick="toggleSection('database')">
                            <span class="text-indigo-500 mr-2">üóÑÔ∏è</span>
                            Database Configuration
                            <svg id="database-chevron" class="w-5 h-5 ml-auto text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </h3>
                        <div id="database-content">
                            <!-- Current Status -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                                <p class="text-xs text-gray-300 uppercase tracking-wide mb-1">Database Type</p>
                                <p class="text-lg font-semibold text-gray-200">${dbInfo.type ? dbInfo.type.toUpperCase() : 'Unknown'}</p>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                                <p class="text-xs text-gray-300 uppercase tracking-wide mb-1">Status</p>
                                <p class="text-lg font-semibold ${dbInfo.status === 'connected' ? 'text-green-600' : 'text-red-600'}">
                                    ${dbInfo.status === 'connected' ? '‚úì Connected' : '‚úó ' + (dbInfo.error || 'Error')}
                                </p>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                                <p class="text-xs text-gray-300 uppercase tracking-wide mb-1">Version</p>
                                <p class="text-lg font-semibold text-gray-200">${escapeHtml(dbInfo.version || 'N/A')}</p>
                            </div>
                        </div>

                        ${dbInfo.type !== 'sqlite' ? `
                        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                                <p class="text-xs text-gray-300 uppercase tracking-wide mb-1">Pool Size</p>
                                <p class="text-sm font-medium text-gray-200">${dbInfo.pool_size}</p>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-4 border border-gray-600">
                                <p class="text-xs text-gray-300 uppercase tracking-wide mb-1">Max Overflow</p>
                                <p class="text-sm font-medium text-gray-200">${dbInfo.max_overflow}</p>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Why CLI Only -->
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg mb-4">
                            <p class="text-sm font-semibold text-amber-800 mb-2">Why is this CLI-only?</p>
                            <p class="text-sm text-amber-700">
                                Database configuration cannot be changed from this UI due to a bootstrap problem:
                                settings are stored <em>in</em> the database, so switching databases would lose access
                                to those settings. The connection must be configured before the application starts.
                            </p>
                        </div>

                        <!-- How to Change -->
                        <div class="p-4 bg-gray-700 border border-slate-300 rounded-lg">
                            <p class="text-sm font-semibold text-slate-800 mb-3">To Change Database Backend (CLI):</p>
                            <div class="space-y-3 text-sm font-mono">
                                <div>
                                    <p class="text-xs text-gray-300 mb-1"># 1. Install the database driver</p>
                                    <code class="block bg-slate-800 text-green-500 p-2 rounded text-xs">
                                        pip install psycopg2-binary  # PostgreSQL<br>
                                        pip install pymysql          # MySQL<br>
                                        pip install pyodbc           # SQL Server
                                    </code>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-300 mb-1"># 2. Edit the systemd service file</p>
                                    <code class="block bg-slate-800 text-green-500 p-2 rounded text-xs">
                                        sudo systemctl edit boobytrap --force
                                    </code>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-300 mb-1"># 3. Add the DATABASE_URL environment variable</p>
                                    <code class="block bg-slate-800 text-green-500 p-2 rounded text-xs overflow-x-auto">
                                        [Service]<br>
                                        Environment="DATABASE_URL=postgresql://user:pass@host:5432/dbname"
                                    </code>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-300 mb-1"># 4. Reload and restart</p>
                                    <code class="block bg-slate-800 text-green-500 p-2 rounded text-xs">
                                        sudo systemctl daemon-reload && sudo systemctl restart boobytrap
                                    </code>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500 mt-3">
                                <strong>Supported URLs:</strong><br>
                                PostgreSQL: <code>postgresql://user:pass@host:5432/db</code><br>
                                MySQL: <code>mysql+pymysql://user:pass@host:3306/db</code><br>
                                SQL Server: <code>mssql+pyodbc://user:pass@host/db?driver=ODBC+Driver+17+for+SQL+Server</code>
                            </p>
                        </div>
                        </div>
                    </div>
                `;

                // Save watch folder button
                document.getElementById('save-watch-folder-btn').addEventListener('click', async function() {
                    var folderPath = document.getElementById('watch-folder-path').value.trim();
                    var statusEl = document.getElementById('scan-status');

                    try {
                        statusEl.textContent = 'Saving...';
                        statusEl.className = 'text-sm text-gray-300';

                        await api('/api/system/settings/watch_folder_path?value=' + encodeURIComponent(folderPath), {
                            method: 'PUT'
                        });

                        statusEl.textContent = 'Watch folder saved successfully!';
                        statusEl.className = 'text-sm text-green-600';

                        // Enable scan button
                        document.getElementById('scan-now-btn').disabled = !folderPath;

                        setTimeout(function() {
                            statusEl.textContent = '';
                        }, 3000);

                    } catch (err) {
                        statusEl.textContent = 'Error: ' + err.message;
                        statusEl.className = 'text-sm text-red-600';
                    }
                });

                // Scan now button
                document.getElementById('scan-now-btn').addEventListener('click', async function() {
                    var statusEl = document.getElementById('scan-status');
                    var resultsDiv = document.getElementById('scan-results');
                    var resultsContent = document.getElementById('scan-results-content');

                    try {
                        statusEl.textContent = 'Scanning folder...';
                        statusEl.className = 'text-sm text-blue-600';

                        var result = await api('/api/system/settings/watch-folder/scan', {
                            method: 'POST'
                        });

                        statusEl.textContent = 'Scan completed!';
                        statusEl.className = 'text-sm text-green-600';

                        // Display results
                        var r = result.result;
                        resultsContent.innerHTML = `
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div class="text-center p-3 bg-gray-700 rounded-lg">
                                    <p class="text-2xl font-bold text-gray-200">${r.files_found}</p>
                                    <p class="text-xs text-gray-300">Files Found</p>
                                </div>
                                <div class="text-center p-3 bg-blue-900/50 rounded-lg">
                                    <p class="text-2xl font-bold text-blue-300">${r.files_processed}</p>
                                    <p class="text-xs text-gray-300">Processed</p>
                                </div>
                                <div class="text-center p-3 bg-green-900/50 rounded-lg">
                                    <p class="text-2xl font-bold text-green-300">${r.new_assets}</p>
                                    <p class="text-xs text-gray-300">New Assets</p>
                                </div>
                                <div class="text-center p-3 bg-amber-900/50 rounded-lg">
                                    <p class="text-2xl font-bold text-amber-300">${r.updated_assets}</p>
                                    <p class="text-xs text-gray-300">Updated</p>
                                </div>
                            </div>
                            ${r.errors.length > 0 ? `
                                <div class="mt-4 p-3 bg-red-900/30 rounded-lg border border-red-200">
                                    <p class="text-sm font-medium text-red-400 mb-2">Errors:</p>
                                    <ul class="text-sm text-red-600 list-disc list-inside">
                                        ${r.errors.map(e => '<li>' + escapeHtml(e) + '</li>').join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            <p class="text-xs text-gray-300 mt-4">Scanned at: ${r.scan_time}</p>
                        `;
                        resultsDiv.classList.remove('hidden');

                    } catch (err) {
                        statusEl.textContent = 'Scan failed: ' + err.message;
                        statusEl.className = 'text-sm text-red-600';
                    }
                });

                // LDAP enable checkbox toggle
                document.getElementById('ldap-enabled').addEventListener('change', function() {
                    var configFields = document.getElementById('ldap-config-fields');
                    configFields.className = this.checked ? '' : 'opacity-50';
                });

                // Save LDAP settings button
                document.getElementById('save-ldap-btn').addEventListener('click', async function() {
                    var statusEl = document.getElementById('ldap-status');

                    try {
                        statusEl.textContent = 'Saving LDAP settings...';
                        statusEl.className = 'text-sm text-gray-300';

                        // Collect all LDAP settings
                        var ldapSettings = {
                            'ldap_enabled': document.getElementById('ldap-enabled').checked ? 'true' : 'false',
                            'ldap_server': document.getElementById('ldap-server').value.trim(),
                            'ldap_port': document.getElementById('ldap-port').value.trim() || '389',
                            'ldap_use_ssl': document.getElementById('ldap-use-ssl').checked ? 'true' : 'false',
                            'ldap_bind_dn': document.getElementById('ldap-bind-dn').value.trim(),
                            'ldap_user_base_dn': document.getElementById('ldap-user-base-dn').value.trim(),
                            'ldap_group_base_dn': document.getElementById('ldap-group-base-dn').value.trim(),
                            'ldap_user_filter': document.getElementById('ldap-user-filter').value.trim() || '(sAMAccountName={username})',
                            'ldap_group_filter': document.getElementById('ldap-group-filter').value.trim() || '(&(objectClass=group)(member={user_dn}))',
                            'ldap_admin_groups': document.getElementById('ldap-admin-groups').value.trim(),
                            'ldap_group_mapping': document.getElementById('ldap-group-mapping').value.trim() || '{}',
                            'ldap_cache_hours': document.getElementById('ldap-cache-hours').value.trim() || '168'
                        };

                        // Handle password - only save if changed
                        var passwordField = document.getElementById('ldap-bind-password');
                        if (passwordField.value && passwordField.value !== '********') {
                            ldapSettings['ldap_bind_password'] = passwordField.value;
                        }

                        // Validate JSON for group mapping
                        try {
                            JSON.parse(ldapSettings['ldap_group_mapping']);
                        } catch (e) {
                            throw new Error('Invalid JSON in Group Mapping field');
                        }

                        // Save each setting
                        for (var key in ldapSettings) {
                            await api('/api/system/settings/' + key + '?value=' + encodeURIComponent(ldapSettings[key]), {
                                method: 'PUT'
                            });
                        }

                        statusEl.textContent = 'LDAP settings saved successfully!';
                        statusEl.className = 'text-sm text-green-600';

                        setTimeout(function() {
                            statusEl.textContent = '';
                        }, 3000);

                    } catch (err) {
                        statusEl.textContent = 'Error: ' + err.message;
                        statusEl.className = 'text-sm text-red-600';
                    }
                });

                // Test LDAP connection button
                document.getElementById('test-ldap-btn').addEventListener('click', async function() {
                    var statusEl = document.getElementById('ldap-status');

                    try {
                        statusEl.textContent = 'Testing LDAP connection...';
                        statusEl.className = 'text-sm text-blue-600';

                        var result = await api('/api/system/settings/ldap/test', {
                            method: 'POST'
                        });

                        statusEl.textContent = 'Connection successful! Server: ' + result.server_info.server;
                        statusEl.className = 'text-sm text-green-600';

                    } catch (err) {
                        statusEl.textContent = 'Connection failed: ' + err.message;
                        statusEl.className = 'text-sm text-red-600';
                    }
                });

                // ============================================================
                // EMAIL NOTIFICATIONS
                // ============================================================

                // Function to load SMTP settings
                async function loadSmtpSettings() {
                    try {
                        var smtpData = await api('/api/system/settings/smtp');
                        document.getElementById('smtp-enabled').checked = smtpData.smtp_enabled || false;
                        document.getElementById('smtp-server').value = smtpData.smtp_server || '';
                        document.getElementById('smtp-port').value = smtpData.smtp_port || '587';
                        // Convert TLS/SSL booleans to select value
                        var securityValue = 'tls';
                        if (smtpData.smtp_use_ssl) {
                            securityValue = 'ssl';
                        } else if (!smtpData.smtp_use_tls) {
                            securityValue = 'none';
                        }
                        document.getElementById('smtp-security').value = securityValue;
                        document.getElementById('smtp-username').value = smtpData.smtp_username || '';
                        document.getElementById('smtp-password').value = ''; // Don't populate password
                        document.getElementById('smtp-from-address').value = smtpData.smtp_from_address || '';
                        document.getElementById('smtp-from-name').value = smtpData.smtp_from_name || 'Fiducia';
                    } catch (err) {
                        console.error('Error loading SMTP settings:', err);
                    }
                }

                // Function to load email alert settings
                async function loadEmailAlertSettings() {
                    try {
                        var alertData = await api('/api/system/settings/email-alerts');
                        document.getElementById('alert-emails-compliance').value = alertData.emails_compliance || '';
                        document.getElementById('alert-emails-managers').value = alertData.emails_managers || '';
                        document.getElementById('alert-approaching-enabled').checked = alertData.approaching_enabled !== false;
                        document.getElementById('alert-failed-enabled').checked = alertData.failed_enabled !== false;
                        document.getElementById('alert-weekly-enabled').checked = alertData.weekly_enabled !== false;
                        document.getElementById('alert-weekly-day').value = alertData.weekly_day || '0';
                        document.getElementById('alert-weekly-time').value = alertData.weekly_time || '08:00';
                    } catch (err) {
                        console.error('Error loading email alert settings:', err);
                    }
                }

                // Save SMTP settings
                document.getElementById('save-smtp-btn').addEventListener('click', async function() {
                    var statusEl = document.getElementById('smtp-status');

                    try {
                        statusEl.textContent = 'Saving SMTP settings...';
                        statusEl.className = 'text-sm text-blue-600';

                        // Convert security select to TLS/SSL booleans
                        var securityValue = document.getElementById('smtp-security').value;
                        var smtpSettings = {
                            smtp_enabled: document.getElementById('smtp-enabled').checked,
                            smtp_server: document.getElementById('smtp-server').value,
                            smtp_port: parseInt(document.getElementById('smtp-port').value) || 587,
                            smtp_use_tls: securityValue === 'tls',
                            smtp_use_ssl: securityValue === 'ssl',
                            smtp_username: document.getElementById('smtp-username').value,
                            smtp_from_address: document.getElementById('smtp-from-address').value,
                            smtp_from_name: document.getElementById('smtp-from-name').value
                        };

                        // Only include password if it was changed
                        var passwordField = document.getElementById('smtp-password');
                        if (passwordField.value) {
                            smtpSettings.smtp_password = passwordField.value;
                        }

                        await api('/api/system/settings/smtp', {
                            method: 'PUT',
                            body: smtpSettings
                        });

                        statusEl.textContent = 'SMTP settings saved successfully!';
                        statusEl.className = 'text-sm text-green-600';
                        passwordField.value = ''; // Clear password field

                        setTimeout(function() {
                            statusEl.textContent = '';
                        }, 3000);

                    } catch (err) {
                        statusEl.textContent = 'Error: ' + err.message;
                        statusEl.className = 'text-sm text-red-600';
                    }
                });

                // Test SMTP connection
                document.getElementById('test-smtp-btn').addEventListener('click', async function() {
                    var statusEl = document.getElementById('smtp-status');

                    try {
                        statusEl.textContent = 'Testing SMTP connection...';
                        statusEl.className = 'text-sm text-blue-600';

                        var result = await api('/api/system/settings/smtp/test', {
                            method: 'POST'
                        });

                        if (result.success) {
                            statusEl.textContent = 'Connection successful! ' + result.message;
                            statusEl.className = 'text-sm text-green-600';
                        } else {
                            statusEl.textContent = 'Connection failed: ' + result.message;
                            statusEl.className = 'text-sm text-red-600';
                        }

                    } catch (err) {
                        statusEl.textContent = 'Connection failed: ' + err.message;
                        statusEl.className = 'text-sm text-red-600';
                    }
                });

                // Send test email
                document.getElementById('send-test-email-btn').addEventListener('click', async function() {
                    var statusEl = document.getElementById('smtp-status');
                    var emailTo = document.getElementById('test-email-address').value.trim();

                    if (!emailTo) {
                        statusEl.textContent = 'Please enter an email address';
                        statusEl.className = 'text-sm text-red-600';
                        return;
                    }

                    try {
                        statusEl.textContent = 'Sending test email...';
                        statusEl.className = 'text-sm text-blue-600';

                        var result = await api('/api/system/settings/smtp/test-email?to=' + encodeURIComponent(emailTo), {
                            method: 'POST'
                        });

                        if (result.success) {
                            statusEl.textContent = 'Test email sent successfully!';
                            statusEl.className = 'text-sm text-green-600';
                        } else {
                            statusEl.textContent = 'Send failed: ' + result.message;
                            statusEl.className = 'text-sm text-red-600';
                        }

                    } catch (err) {
                        statusEl.textContent = 'Send failed: ' + err.message;
                        statusEl.className = 'text-sm text-red-600';
                    }
                });

                // Save alert recipients
                document.getElementById('save-alert-recipients-btn').addEventListener('click', async function() {
                    var statusEl = document.getElementById('alert-recipients-status');

                    try {
                        statusEl.textContent = 'Saving...';
                        statusEl.className = 'text-sm text-blue-600';

                        var alertSettings = {
                            emails_compliance: document.getElementById('alert-emails-compliance').value,
                            emails_managers: document.getElementById('alert-emails-managers').value
                        };

                        await api('/api/system/settings/email-alerts', {
                            method: 'PUT',
                            body: alertSettings
                        });

                        statusEl.textContent = 'Recipients saved!';
                        statusEl.className = 'text-sm text-green-600';

                        setTimeout(function() {
                            statusEl.textContent = '';
                        }, 3000);

                    } catch (err) {
                        statusEl.textContent = 'Error: ' + err.message;
                        statusEl.className = 'text-sm text-red-600';
                    }
                });

                // Save alert settings
                document.getElementById('save-alert-settings-btn').addEventListener('click', async function() {
                    var statusEl = document.getElementById('alert-settings-status');

                    try {
                        statusEl.textContent = 'Saving...';
                        statusEl.className = 'text-sm text-blue-600';

                        var alertSettings = {
                            approaching_enabled: document.getElementById('alert-approaching-enabled').checked,
                            failed_enabled: document.getElementById('alert-failed-enabled').checked,
                            weekly_enabled: document.getElementById('alert-weekly-enabled').checked,
                            weekly_day: parseInt(document.getElementById('alert-weekly-day').value),
                            weekly_time: document.getElementById('alert-weekly-time').value
                        };

                        await api('/api/system/settings/email-alerts', {
                            method: 'PUT',
                            body: alertSettings
                        });

                        statusEl.textContent = 'Alert settings saved!';
                        statusEl.className = 'text-sm text-green-600';

                        setTimeout(function() {
                            statusEl.textContent = '';
                        }, 3000);

                    } catch (err) {
                        statusEl.textContent = 'Error: ' + err.message;
                        statusEl.className = 'text-sm text-red-600';
                    }
                });

                // ============================================================
                // SYSLOG CONFIGURATION
                // ============================================================

                // Toggle section helper
                function toggleSection(sectionId) {
                    var content = document.getElementById(sectionId + '-content');
                    var chevron = document.getElementById(sectionId + '-chevron');
                    if (content && chevron) {
                        content.classList.toggle('hidden');
                        chevron.classList.toggle('rotate-180');
                    }
                }
                window.toggleSection = toggleSection;

                // Syslog enable checkbox toggle
                var syslogEnabled = document.getElementById('syslog-enabled');
                if (syslogEnabled) {
                    syslogEnabled.addEventListener('change', function() {
                        var configFields = document.getElementById('syslog-config-fields');
                        configFields.className = this.checked ? '' : 'opacity-50';
                    });
                }

                // Protocol change - show/hide TLS options
                var syslogProtocol = document.getElementById('syslog-protocol');
                if (syslogProtocol) {
                    syslogProtocol.addEventListener('change', function() {
                        var tlsOptions = document.getElementById('syslog-tls-options');
                        var portInput = document.getElementById('syslog-port');
                        if (this.value === 'tls') {
                            tlsOptions.classList.remove('hidden');
                            if (portInput.value === '514') portInput.value = '6514';
                        } else {
                            tlsOptions.classList.add('hidden');
                            if (portInput.value === '6514') portInput.value = '514';
                        }
                    });
                }

                // Load syslog settings and events
                async function loadSyslogSettings() {
                    try {
                        // Load event types
                        var eventsResult = await api('/api/system/settings/syslog/events');
                        var eventsList = document.getElementById('syslog-events-list');

                        if (eventsResult.event_types && eventsResult.event_types.length > 0) {
                            eventsList.innerHTML = eventsResult.event_types.map(function(evt) {
                                return '<label class="flex items-center gap-2 p-2 bg-gray-700 rounded border border-gray-600 cursor-pointer hover:bg-gray-600">' +
                                    '<input type="checkbox" class="syslog-event-checkbox w-4 h-4 rounded border-gray-500 bg-gray-600" data-event="' + evt.id + '">' +
                                    '<div>' +
                                        '<span class="text-sm text-gray-200">' + escapeHtml(evt.name) + '</span>' +
                                        '<p class="text-xs text-gray-400">' + escapeHtml(evt.description) + '</p>' +
                                    '</div>' +
                                '</label>';
                            }).join('');
                        }

                        // Load current settings
                        var settingsResult = await api('/api/system/settings/syslog');
                        if (settingsResult.value) {
                            var config = typeof settingsResult.value === 'string' ? JSON.parse(settingsResult.value) : settingsResult.value;

                            // Set form fields
                            var enabledEl = document.getElementById('syslog-enabled');
                            var serverEl = document.getElementById('syslog-server');
                            var portEl = document.getElementById('syslog-port');
                            var protocolEl = document.getElementById('syslog-protocol');
                            var facilityEl = document.getElementById('syslog-facility');
                            var tlsVerifyEl = document.getElementById('syslog-tls-verify');
                            var configFields = document.getElementById('syslog-config-fields');

                            if (config.enabled) {
                                enabledEl.checked = true;
                                configFields.className = '';
                            }
                            if (config.server) serverEl.value = config.server;
                            if (config.port) portEl.value = config.port;
                            if (config.protocol) {
                                protocolEl.value = config.protocol;
                                if (config.protocol === 'tls') {
                                    document.getElementById('syslog-tls-options').classList.remove('hidden');
                                }
                            }
                            if (config.facility) facilityEl.value = config.facility;
                            if (config.tls_verify !== undefined) tlsVerifyEl.checked = config.tls_verify;

                            // Set enabled events
                            if (config.enabled_events) {
                                document.querySelectorAll('.syslog-event-checkbox').forEach(function(cb) {
                                    var eventId = cb.getAttribute('data-event');
                                    cb.checked = config.enabled_events[eventId] === true;
                                });
                            }
                        }
                    } catch (err) {
                        console.error('Error loading syslog settings:', err);
                    }
                }

                // Call load on page ready
                if (document.getElementById('syslog-events-list')) {
                    loadSyslogSettings();
                }

                // Select All / Select None buttons
                var selectAllBtn = document.getElementById('syslog-select-all');
                var selectNoneBtn = document.getElementById('syslog-select-none');

                if (selectAllBtn) {
                    selectAllBtn.addEventListener('click', function() {
                        document.querySelectorAll('.syslog-event-checkbox').forEach(function(cb) {
                            cb.checked = true;
                        });
                    });
                }

                if (selectNoneBtn) {
                    selectNoneBtn.addEventListener('click', function() {
                        document.querySelectorAll('.syslog-event-checkbox').forEach(function(cb) {
                            cb.checked = false;
                        });
                    });
                }

                // Save syslog settings
                var saveSyslogBtn = document.getElementById('save-syslog-btn');
                if (saveSyslogBtn) {
                    saveSyslogBtn.addEventListener('click', async function() {
                        var statusEl = document.getElementById('syslog-status');

                        try {
                            statusEl.textContent = 'Saving syslog settings...';
                            statusEl.className = 'text-sm text-blue-400';

                            // Collect enabled events
                            var enabledEvents = {};
                            document.querySelectorAll('.syslog-event-checkbox').forEach(function(cb) {
                                enabledEvents[cb.getAttribute('data-event')] = cb.checked;
                            });

                            var syslogConfig = {
                                enabled: document.getElementById('syslog-enabled').checked,
                                server: document.getElementById('syslog-server').value.trim(),
                                port: parseInt(document.getElementById('syslog-port').value) || 514,
                                protocol: document.getElementById('syslog-protocol').value,
                                facility: parseInt(document.getElementById('syslog-facility').value) || 16,
                                tls_verify: document.getElementById('syslog-tls-verify').checked,
                                enabled_events: enabledEvents
                            };

                            await api('/api/system/settings/syslog', {
                                method: 'PUT',
                                body: syslogConfig
                            });

                            statusEl.textContent = 'Syslog settings saved!';
                            statusEl.className = 'text-sm text-green-500';

                            setTimeout(function() {
                                statusEl.textContent = '';
                            }, 3000);

                        } catch (err) {
                            statusEl.textContent = 'Error: ' + err.message;
                            statusEl.className = 'text-sm text-red-500';
                        }
                    });
                }

                // Test syslog connection
                var testSyslogBtn = document.getElementById('test-syslog-btn');
                if (testSyslogBtn) {
                    testSyslogBtn.addEventListener('click', async function() {
                        var statusEl = document.getElementById('syslog-status');

                        try {
                            statusEl.textContent = 'Testing syslog connection...';
                            statusEl.className = 'text-sm text-blue-400';

                            var result = await api('/api/system/settings/syslog/test', {
                                method: 'POST'
                            });

                            if (result.success) {
                                statusEl.textContent = 'Connection successful! Test message sent.';
                                statusEl.className = 'text-sm text-green-500';
                            } else {
                                statusEl.textContent = 'Test failed: ' + result.message;
                                statusEl.className = 'text-sm text-red-500';
                            }

                        } catch (err) {
                            statusEl.textContent = 'Test failed: ' + err.message;
                            statusEl.className = 'text-sm text-red-500';
                        }
                    });
                }

                // ============================================================
                // USER MANAGEMENT
                // ============================================================

                // Function to load and display users
                async function loadUsersList() {
                    var usersListEl = document.getElementById('users-list');
                    var resetSelect = document.getElementById('reset-user-select');

                    try {
                        var users = await api('/api/auth/users');

                        // Update users list display
                        if (users.length === 0) {
                            usersListEl.innerHTML = '<p class="text-sm text-gray-400">No users found.</p>';
                        } else {
                            usersListEl.innerHTML = users.map(function(user) {
                                var roleClass = user.role === 'admin' ? 'bg-slate-600' : 'bg-blue-700';
                                var statusClass = user.is_active ? 'text-green-500' : 'text-red-500';
                                var statusText = user.is_active ? 'Active' : 'Inactive';
                                return `
                                    <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg border border-gray-600">
                                        <div class="flex items-center gap-3">
                                            <div>
                                                <p class="font-medium text-gray-200">${escapeHtml(user.full_name)}</p>
                                                <p class="text-xs text-gray-400">@${escapeHtml(user.username)}</p>
                                            </div>
                                            <span class="px-2 py-1 text-xs rounded ${roleClass} text-white">${escapeHtml(user.role)}</span>
                                            <span class="text-xs ${statusClass}">${statusText}</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            ${user.username !== currentUser.username ? `
                                                <button class="toggle-user-btn px-2 py-1 text-xs ${user.is_active ? 'bg-red-800 hover:bg-red-600' : 'bg-green-800 hover:bg-green-600'} text-white rounded"
                                                        data-username="${escapeHtml(user.username)}" data-active="${user.is_active}">
                                                    ${user.is_active ? 'Disable' : 'Enable'}
                                                </button>
                                                <button class="delete-user-btn px-2 py-1 text-xs bg-gray-600 hover:bg-gray-500 text-white rounded"
                                                        data-username="${escapeHtml(user.username)}">
                                                    Delete
                                                </button>
                                            ` : '<span class="text-xs text-gray-500">(You)</span>'}
                                        </div>
                                    </div>
                                `;
                            }).join('');

                            // Add event listeners for toggle and delete buttons
                            document.querySelectorAll('.delete-user-btn').forEach(function(btn) {
                                btn.addEventListener('click', async function() {
                                    var username = this.dataset.username;
                                    if (confirm('Are you sure you want to delete user "' + username + '"?')) {
                                        try {
                                            await api('/api/auth/users/' + encodeURIComponent(username), { method: 'DELETE' });
                                            loadUsersList();
                                        } catch (err) {
                                            alert('Error deleting user: ' + err.message);
                                        }
                                    }
                                });
                            });
                        }

                        // Update password reset dropdown
                        resetSelect.innerHTML = '<option value="">Select user...</option>' +
                            users.map(function(user) {
                                return '<option value="' + escapeHtml(user.username) + '">' +
                                    escapeHtml(user.full_name) + ' (@' + escapeHtml(user.username) + ')' +
                                    '</option>';
                            }).join('');

                    } catch (err) {
                        usersListEl.innerHTML = '<p class="text-sm text-red-500">Error loading users: ' + escapeHtml(err.message) + '</p>';
                    }
                }

                // Initial load of users
                loadUsersList();

                // Refresh users button
                document.getElementById('refresh-users-btn').addEventListener('click', loadUsersList);

                // Create user button
                document.getElementById('create-user-btn').addEventListener('click', async function() {
                    var username = document.getElementById('new-user-username').value.trim();
                    var fullName = document.getElementById('new-user-fullname').value.trim();
                    var password = document.getElementById('new-user-password').value;
                    var role = document.getElementById('new-user-role').value;
                    var statusEl = document.getElementById('create-user-status');

                    if (!username || !fullName || !password) {
                        statusEl.textContent = 'Please fill in all fields';
                        statusEl.className = 'text-sm text-red-500';
                        return;
                    }

                    try {
                        statusEl.textContent = 'Creating user...';
                        statusEl.className = 'text-sm text-gray-300';

                        await api('/api/auth/users', {
                            method: 'POST',
                            body: {
                                username: username,
                                full_name: fullName,
                                password: password,
                                role: role
                            }
                        });

                        statusEl.textContent = 'User created successfully!';
                        statusEl.className = 'text-sm text-green-500';

                        // Clear form
                        document.getElementById('new-user-username').value = '';
                        document.getElementById('new-user-fullname').value = '';
                        document.getElementById('new-user-password').value = '';

                        // Refresh users list
                        loadUsersList();

                        setTimeout(function() { statusEl.textContent = ''; }, 3000);

                    } catch (err) {
                        statusEl.textContent = 'Error: ' + err.message;
                        statusEl.className = 'text-sm text-red-500';
                    }
                });

                // Reset password button
                document.getElementById('reset-password-btn').addEventListener('click', async function() {
                    var username = document.getElementById('reset-user-select').value;
                    var newPassword = document.getElementById('reset-user-password').value;
                    var statusEl = document.getElementById('reset-password-status');

                    if (!username) {
                        statusEl.textContent = 'Please select a user';
                        statusEl.className = 'text-sm text-red-500';
                        return;
                    }

                    if (!newPassword) {
                        statusEl.textContent = 'Please enter a new password';
                        statusEl.className = 'text-sm text-red-500';
                        return;
                    }

                    try {
                        statusEl.textContent = 'Resetting password...';
                        statusEl.className = 'text-sm text-gray-300';

                        await api('/api/auth/users/' + encodeURIComponent(username) + '/password?new_password=' + encodeURIComponent(newPassword), {
                            method: 'PUT'
                        });

                        statusEl.textContent = 'Password reset successfully for ' + username + '!';
                        statusEl.className = 'text-sm text-green-500';

                        // Clear password field
                        document.getElementById('reset-user-password').value = '';

                        setTimeout(function() { statusEl.textContent = ''; }, 3000);

                    } catch (err) {
                        statusEl.textContent = 'Error: ' + err.message;
                        statusEl.className = 'text-sm text-red-500';
                    }
                });

                // Schedule type toggle - show/hide appropriate options
                var scheduleTypeRadios = document.querySelectorAll('input[name="schedule-type"]');
                scheduleTypeRadios.forEach(function(radio) {
                    radio.addEventListener('change', function() {
                        var dayOptions = document.getElementById('day-of-month-options');
                        var weekdayOptions = document.getElementById('weekday-pattern-options');
                        if (this.value === 'weekday_pattern') {
                            dayOptions.classList.add('hidden');
                            weekdayOptions.classList.remove('hidden');
                        } else {
                            dayOptions.classList.remove('hidden');
                            weekdayOptions.classList.add('hidden');
                        }
                    });
                });

                // Weekday pattern management
                var weekdayPatterns = [];
                var weekdayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                var occurrenceNames = ['1st', '2nd', '3rd', '4th'];

                function renderWeekdayPatterns() {
                    var container = document.getElementById('weekday-patterns-container');
                    if (!container) return;

                    if (weekdayPatterns.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-sm">No patterns configured. Click "Add Pattern" to add one.</p>';
                        return;
                    }

                    var html = '';
                    weekdayPatterns.forEach(function(pattern, index) {
                        html += '<div class="flex items-center gap-3 p-2 bg-gray-700 rounded">';
                        html += '  <select class="weekday-occurrence px-2 py-1 text-sm border border-gray-600 rounded bg-gray-800 text-gray-200" data-index="' + index + '">';
                        for (var i = 0; i < 4; i++) {
                            var selected = pattern.occurrence === (i + 1) ? 'selected' : '';
                            html += '    <option value="' + (i + 1) + '" ' + selected + '>' + occurrenceNames[i] + '</option>';
                        }
                        html += '  </select>';
                        html += '  <select class="weekday-day px-2 py-1 text-sm border border-gray-600 rounded bg-gray-800 text-gray-200" data-index="' + index + '">';
                        for (var j = 0; j < 7; j++) {
                            var selected = pattern.weekday === j ? 'selected' : '';
                            html += '    <option value="' + j + '" ' + selected + '>' + weekdayNames[j] + '</option>';
                        }
                        html += '  </select>';
                        html += '  <button type="button" class="remove-pattern px-2 py-1 text-xs bg-red-600/50 text-red-200 rounded hover:bg-red-600" data-index="' + index + '">Remove</button>';
                        html += '</div>';
                    });
                    container.innerHTML = html;

                    // Add event listeners for pattern changes
                    container.querySelectorAll('.weekday-occurrence').forEach(function(select) {
                        select.addEventListener('change', function() {
                            var idx = parseInt(this.getAttribute('data-index'));
                            weekdayPatterns[idx].occurrence = parseInt(this.value);
                        });
                    });
                    container.querySelectorAll('.weekday-day').forEach(function(select) {
                        select.addEventListener('change', function() {
                            var idx = parseInt(this.getAttribute('data-index'));
                            weekdayPatterns[idx].weekday = parseInt(this.value);
                        });
                    });
                    container.querySelectorAll('.remove-pattern').forEach(function(btn) {
                        btn.addEventListener('click', function() {
                            var idx = parseInt(this.getAttribute('data-index'));
                            weekdayPatterns.splice(idx, 1);
                            renderWeekdayPatterns();
                        });
                    });
                }

                // Add pattern button
                var addPatternBtn = document.getElementById('add-weekday-pattern');
                if (addPatternBtn) {
                    addPatternBtn.addEventListener('click', function() {
                        weekdayPatterns.push({ weekday: 1, occurrence: 1 });  // Default to 1st Tuesday
                        renderWeekdayPatterns();
                    });
                }

                // Initialize weekday patterns from settings
                try {
                    var patternsJson = settings.compliance_check_patterns ? settings.compliance_check_patterns.value : '[]';
                    weekdayPatterns = JSON.parse(patternsJson || '[]');
                    if (weekdayPatterns.length === 0) {
                        // Default patterns: 1st and 3rd Tuesday
                        weekdayPatterns = [
                            { weekday: 1, occurrence: 1 },
                            { weekday: 1, occurrence: 3 }
                        ];
                    }
                } catch (e) {
                    weekdayPatterns = [{ weekday: 1, occurrence: 1 }, { weekday: 1, occurrence: 3 }];
                }
                renderWeekdayPatterns();

                // Toggle extension days input based on checkbox
                document.getElementById('allow-deadline-extension').addEventListener('change', function() {
                    var maxExtInput = document.getElementById('max-extension-days');
                    var container = maxExtInput.closest('.ml-8');
                    if (this.checked) {
                        container.classList.remove('opacity-50');
                        maxExtInput.disabled = false;
                    } else {
                        container.classList.add('opacity-50');
                        maxExtInput.disabled = true;
                    }
                });

                document.getElementById('save-compliance-btn').addEventListener('click', async function() {
                    var statusEl = document.getElementById('compliance-status');

                    try {
                        statusEl.textContent = 'Saving all settings...';
                        statusEl.className = 'text-sm text-gray-300';

                        // Determine schedule type
                        var scheduleType = document.getElementById('schedule-type-weekday').checked ? 'weekday_pattern' : 'day_of_month';

                        // Get hour/minute based on schedule type
                        var checkHour, checkMinute;
                        if (scheduleType === 'weekday_pattern') {
                            checkHour = document.getElementById('compliance-check-hour-weekday').value.trim() || '2';
                            checkMinute = document.getElementById('compliance-check-minute-weekday').value.trim() || '0';
                        } else {
                            checkHour = document.getElementById('compliance-check-hour').value.trim() || '2';
                            checkMinute = document.getElementById('compliance-check-minute').value.trim() || '0';
                        }

                        // Schedule settings
                        var complianceSettings = {
                            'compliance_check_enabled': document.getElementById('compliance-check-enabled').checked ? 'true' : 'false',
                            'compliance_check_type': scheduleType,
                            'compliance_check_days': document.getElementById('compliance-check-days').value.trim() || '1,15',
                            'compliance_check_patterns': JSON.stringify(weekdayPatterns),
                            'compliance_check_hour': checkHour,
                            'compliance_check_minute': checkMinute,
                            // Behavior settings
                            'require_resolution_notes': document.getElementById('require-resolution-notes').checked ? 'true' : 'false',
                            'auto_pnci_on_failure': document.getElementById('auto-pnci-on-failure').checked ? 'true' : 'false',
                            // Deadline extension settings
                            'allow_deadline_extension': document.getElementById('allow-deadline-extension').checked ? 'true' : 'false',
                            'max_extension_days': document.getElementById('max-extension-days').value.trim() || '15',
                            // Dashboard settings
                            'show_compliance_percentage': document.getElementById('show-compliance-percentage').checked ? 'true' : 'false',
                            'historical_retention_days': document.getElementById('historical-retention-days').value.trim() || '365'
                        };

                        // Validate based on schedule type
                        if (scheduleType === 'day_of_month') {
                            // Validate days format
                            var days = complianceSettings['compliance_check_days'].split(',').map(function(d) { return parseInt(d.trim()); });
                            for (var i = 0; i < days.length; i++) {
                                if (isNaN(days[i]) || days[i] < 1 || days[i] > 31) {
                                    throw new Error('Invalid check day: ' + days[i] + '. Days must be 1-31.');
                                }
                            }
                        } else {
                            // Validate weekday patterns
                            if (weekdayPatterns.length === 0) {
                                throw new Error('Please add at least one weekday pattern.');
                            }
                        }

                        // Save each setting
                        for (var key in complianceSettings) {
                            await api('/api/system/settings/' + key + '?value=' + encodeURIComponent(complianceSettings[key]), {
                                method: 'PUT'
                            });
                        }

                        // Tell scheduler to reload settings
                        await api('/api/system/scheduler/reload', { method: 'POST' });

                        statusEl.textContent = 'All compliance settings saved successfully!';
                        statusEl.className = 'text-sm text-green-600';

                        setTimeout(function() {
                            statusEl.textContent = '';
                        }, 5000);

                    } catch (err) {
                        statusEl.textContent = 'Error: ' + err.message;
                        statusEl.className = 'text-sm text-red-600';
                    }
                });

                // Run compliance check now button
                document.getElementById('run-compliance-now-btn').addEventListener('click', async function() {
                    var statusEl = document.getElementById('compliance-status');
                    var resultsDiv = document.getElementById('last-compliance-check');
                    var resultsContent = document.getElementById('last-compliance-content');

                    try {
                        statusEl.textContent = 'Running compliance check...';
                        statusEl.className = 'text-sm text-blue-600';

                        var result = await api('/api/system/scheduler/run-check', {
                            method: 'POST'
                        });

                        statusEl.textContent = 'Compliance check completed!';
                        statusEl.className = 'text-sm text-green-600';

                        // Display results
                        var r = result.result;
                        resultsContent.innerHTML = `
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                <div class="text-center p-2 bg-gray-700 rounded border border-gray-600">
                                    <p class="text-xl font-bold text-gray-200">${r.assets_checked}</p>
                                    <p class="text-xs text-gray-300">Assets Checked</p>
                                </div>
                                <div class="text-center p-2 bg-green-900/50 rounded border border-green-700">
                                    <p class="text-xl font-bold text-green-300">${r.assets_unchanged}</p>
                                    <p class="text-xs text-gray-300">Compliant</p>
                                </div>
                                <div class="text-center p-2 bg-amber-900/50 rounded border border-amber-700">
                                    <p class="text-xl font-bold text-amber-300">${r.changes_detected}</p>
                                    <p class="text-xs text-gray-300">Changes Found</p>
                                </div>
                                <div class="text-center p-2 bg-red-900/50 rounded border border-red-700">
                                    <p class="text-xl font-bold text-red-300">${r.assets_in_investigation}</p>
                                    <p class="text-xs text-gray-300">Investigations</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-300">Check completed: ${r.check_date}</p>
                        `;
                        resultsDiv.classList.remove('hidden');

                    } catch (err) {
                        statusEl.textContent = 'Check failed: ' + err.message;
                        statusEl.className = 'text-sm text-red-600';
                    }
                });

                // Load email settings
                loadSmtpSettings();
                loadEmailAlertSettings();

            } catch (err) {
                container.innerHTML = '<div class="text-center py-12"><p class="text-red-500">Error loading settings: ' + escapeHtml(err.message) + '</p></div>';
            }
        }

        // ============================================================
        // COMPLIANCE VIEW
        // ============================================================

        async function renderCompliance(container) {
            container.innerHTML = '<div class="text-center py-12"><p class="text-gray-400">Loading compliance data...</p></div>';

            try {
                // Fetch compliance data
                var summary = await api('/api/reports/compliance/summary');
                var checks = await api('/api/reports/scheduled-checks?limit=10');
                var investigationsDetail = await api('/api/reports/compliance/investigations-detail');
                var investigationClosures = await api('/api/reports/investigation-closures/list');

                // Helper function for status colors
                function getStatusBadge(status, daysRemaining) {
                    switch(status) {
                        case 'overdue':
                            return '<span class="px-2 py-1 rounded text-xs font-bold bg-red-800 text-white">OVERDUE</span>';
                        case 'critical':
                            return '<span class="px-2 py-1 rounded text-xs font-bold bg-amber-700 text-white">' + daysRemaining + ' DAYS</span>';
                        case 'warning':
                            return '<span class="px-2 py-1 rounded text-xs font-bold bg-amber-800 text-white">' + daysRemaining + ' DAYS</span>';
                        default:
                            return '<span class="px-2 py-1 rounded text-xs font-medium bg-green-700 text-white">' + daysRemaining + ' DAYS</span>';
                    }
                }

                // Build the UI
                container.innerHTML = `
                    <div class="bg-gray-700 rounded-lg border-2 border-blue-700 shadow-xl overflow-hidden">
                        <!-- Header -->
                        <div class="p-4 md:p-6" style="background: linear-gradient(90deg, #1e3a5f 0%, #1e40af 100%);">
                            <h2 class="text-xl font-bold text-white mb-1">Compliance Tracking</h2>
                            <p class="text-sm text-amber-300">Comprehensive monitoring, investigation, and alerting for compliance activities</p>
                        </div>

                        <div class="p-4 md:p-6 space-y-6">

                            <!-- Summary Cards -->
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                <div class="text-center p-4 bg-gray-800 rounded-lg border border-gray-600">
                                    <p class="text-3xl font-bold text-gray-200">${summary.total_assets}</p>
                                    <p class="text-sm text-gray-400">Total Assets</p>
                                </div>
                                <div class="text-center p-4 bg-gray-800 rounded-lg border border-green-600">
                                    <p class="text-3xl font-bold text-green-500">${summary.compliant_assets}</p>
                                    <p class="text-sm text-gray-400">Compliant</p>
                                </div>
                                <div class="text-center p-4 bg-gray-800 rounded-lg border border-blue-600" title="Assets with pending changes - each change has a 30-day timer">
                                    <p class="text-3xl font-bold text-blue-400">${summary.assets_awaiting_review || 0}</p>
                                    <p class="text-sm text-gray-400">Awaiting Review</p>
                                    <p class="text-xs text-blue-300 mt-1">30-day per-change timers active</p>
                                </div>
                                <div class="text-center p-4 bg-gray-800 rounded-lg border border-amber-700">
                                    <p class="text-3xl font-bold text-yellow-400">${summary.investigation_assets}</p>
                                    <p class="text-sm text-gray-400">In Investigation</p>
                                </div>
                                <div class="text-center p-4 bg-gray-800 rounded-lg border border-orange-600">
                                    <p class="text-3xl font-bold text-orange-400">${investigationsDetail.summary.critical + investigationsDetail.summary.warning}</p>
                                    <p class="text-sm text-gray-400">Approaching Deadline</p>
                                    <p class="text-xs text-orange-300 mt-1">(subset of Investigation)</p>
                                </div>
                                <div class="text-center p-4 bg-gray-800 rounded-lg border border-red-600">
                                    <p class="text-3xl font-bold text-red-500">${summary.failed_assets}</p>
                                    <p class="text-sm text-gray-400">Failed</p>
                                </div>
                            </div>

                            <!-- Reports & Tools Section -->
                            <div class="bg-gray-800 rounded-lg p-6 border border-gray-600">
                                <h3 class="text-lg font-semibold text-white mb-4">Reports & Tools</h3>

                                <!-- Row 1: Date picker + 2 Report buttons -->
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                    <!-- Date Selection -->
                                    <div class="bg-gray-700/50 rounded-lg p-4 flex flex-col">
                                        <h4 class="font-medium text-blue-400 mb-2">üìÖ Report Date</h4>
                                        <p class="text-xs text-gray-400 mb-3 flex-grow">Select date for the reports to the right.</p>
                                        <input type="date" id="compliance-date" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" value="${new Date().toISOString().split('T')[0]}">
                                    </div>

<!-- Investigation Report -->
                                    <div class="bg-gray-700/50 rounded-lg p-4 flex flex-col">
                                        <h4 class="font-medium text-gray-300 mb-2">üîç Investigation Report</h4>
                                        <p class="text-xs text-gray-400 mb-3 flex-grow">Day 1, elapsed days, and all changes.</p>
                                        <button id="generate-investigation-report-btn" class="w-full px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500 text-sm font-medium">
                                            Generate Report
                                        </button>
                                    </div>

                                                                        <!-- Baseline Report -->
                                    <div class="bg-gray-700/50 rounded-lg p-4 flex flex-col">
                                        <h4 class="font-medium text-gray-300 mb-2">üìã Baseline Report</h4>
                                        <p class="text-xs text-gray-400 mb-2">Full asset baselines for audit documentation.</p>
                                        <input type="text" id="custom-baseline-assets" placeholder="Asset names (comma-separated)" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-xs mb-3 focus:border-blue-500 focus:outline-none">
                                        <button id="generate-baseline-report-btn" class="w-full px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500 text-sm font-medium mb-2" title="Generate TXT report for all assets">
                                            Print All Assets (TXT)
                                        </button>
                                        <button id="generate-custom-baseline-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 text-sm font-medium" title="Generate PDF for assets specified above">
                                            PDF by Asset Name
                                        </button>
                                    </div>
                                </div>

                                <!-- Row 2: Tools -->
                                <div class="grid grid-cols-1 md:grid-cols-2 ${currentUser && currentUser.role === 'admin' ? 'lg:grid-cols-3' : 'lg:grid-cols-2'} gap-4">
                                    <!-- Ticket Search -->
                                    <div class="bg-gray-700/50 rounded-lg p-4 flex flex-col">
                                        <h4 class="font-medium text-gray-300 mb-2">üîñ Ticket Search</h4>
                                        <p class="text-xs text-gray-400 mb-3 flex-grow">Find changes by ticket number.</p>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="ticket-search-input" placeholder="Ticket #..."
                                                class="flex-grow px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm focus:border-blue-500 focus:outline-none">
                                            <button id="ticket-search-btn" class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-500 text-sm font-medium">
                                                Search
                                            </button>
                                        </div>
                                    </div>

                                    ${currentUser && currentUser.role === 'admin' ? `
                                    <!-- User Audit (Admin Only) -->
                                    <div class="bg-gray-700/50 rounded-lg p-4 flex flex-col">
                                        <h4 class="font-medium text-gray-300 mb-2">üë§ User Audit</h4>
                                        <p class="text-xs text-gray-400 mb-3 flex-grow">Review user activity history.</p>
                                        <div class="flex items-center gap-2">
                                            <select id="audit-user-select" class="flex-grow px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm focus:border-blue-500 focus:outline-none">
                                                <option value="">Select user...</option>
                                            </select>
                                            <button id="view-user-audit-btn" class="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-500 text-sm font-medium">
                                                View
                                            </button>
                                        </div>
                                    </div>
                                    ` : ''}

                                    <!-- File Comparison Tool -->
                                    <div class="bg-gray-700/50 rounded-lg p-4 flex flex-col">
                                        <h4 class="font-medium text-gray-300 mb-2">üìã File Comparison</h4>
                                        <p class="text-xs text-gray-400 mb-3 flex-grow">Compare two baseline files side-by-side.</p>
                                        <button id="open-compare-tool-btn" class="w-full px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-500 text-sm font-medium">
                                            Open Comparison Tool
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Investigation Closure Reports Section -->
                            <div class="bg-gray-800 rounded-lg p-6 border border-gray-600">
                                <h3 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                    <span class="text-xl">&#128196;</span> Investigation Closure Reports
                                    <span class="text-xs font-normal text-gray-400">(PDF download)</span>
                                </h3>
                                
                                <!-- Filter Controls -->
                                <div class="flex flex-wrap gap-4 mb-4 items-end">
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">Filter by Date</label>
                                        <input type="date" id="closure-filter-date" class="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm" value="">
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-400 mb-1">Search</label>
                                        <div class="flex gap-2">
                                            <input type="text" id="closure-search" placeholder="Search..." class="px-3 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm w-48">
                                            <select id="closure-search-type" class="px-2 py-2 bg-gray-700 border border-gray-600 rounded text-gray-200 text-sm">
                                                <option value="asset">Asset</option>
                                                <option value="ticket">Ticket</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button onclick="loadInvestigationClosures()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-500">Search</button>
                                    <button onclick="clearClosureFilters()" class="px-4 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-500">Clear</button>
                                </div>
                                
                                <p class="text-sm text-gray-400 mb-4">Generate PDF reports for past investigation closures. Filter by date or search by asset/ticket number.</p>
                                
                                <!-- Results container -->
                                <div id="closure-results-container">
                                    <div id="closure-status" class="text-sm text-gray-400 mb-2"></div>
                                    <div id="closure-table-container" class="max-h-64 overflow-y-auto"></div>
                                    <div id="closure-load-more" class="mt-3 text-center hidden">
                                        <button onclick="loadMoreClosures()" class="px-4 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-500">Load More</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Investigation Tracking Table -->
                            <div>
                                <h3 class="font-bold text-lg text-gray-200 mb-3 flex items-center gap-2">
                                    <span class="text-xl">üîç</span> Investigation Tracking (${investigationsDetail.summary.total} assets)
                                </h3>
                                ${investigationsDetail.investigations.length > 0 ? `
                                <div class="bg-gray-800 border border-gray-600 rounded-lg overflow-hidden">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-900">
                                            <tr>
                                                <th class="px-3 py-3 text-left font-semibold text-gray-300">Asset</th>
                                                <th class="px-3 py-3 text-left font-semibold text-gray-300">Team</th>
                                                <th class="px-3 py-3 text-left font-semibold text-gray-300">Day 1 (Started)</th>
                                                <th class="px-3 py-3 text-left font-semibold text-gray-300">Days Elapsed</th>
                                                <th class="px-3 py-3 text-left font-semibold text-gray-300">Days Left</th>
                                                <th class="px-3 py-3 text-left font-semibold text-gray-300">Status</th>
                                                <th class="px-3 py-3 text-left font-semibold text-gray-300">Changes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${investigationsDetail.investigations.map(function(inv) {
                                                var rowClass = inv.status === 'overdue' ? 'bg-red-900/30' :
                                                               inv.status === 'critical' ? 'bg-orange-900/30' :
                                                               inv.status === 'warning' ? 'bg-yellow-900/20' : '';
                                                // Calculate days elapsed since investigation started
                                                var daysElapsed = 0;
                                                if (inv.investigation_started_at) {
                                                    var startDate = new Date(inv.investigation_started_at);
                                                    var today = new Date();
                                                    daysElapsed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                                                }
                                                return `
                                                <tr class="border-t border-gray-700 hover:bg-gray-700 cursor-pointer investigation-row ${rowClass}" data-asset-id="${inv.asset_id}">
                                                    <td class="px-3 py-3">
                                                        <span class="font-medium text-blue-400">${escapeHtml(inv.asset_name)}</span>
                                                    </td>
                                                    <td class="px-3 py-3 text-gray-300">${escapeHtml(inv.group_name)}</td>
                                                    <td class="px-3 py-3 text-gray-400">${inv.investigation_started_at ? new Date(inv.investigation_started_at).toLocaleDateString() : '-'}</td>
                                                    <td class="px-3 py-3">
                                                        <span class="font-bold ${daysElapsed > 25 ? 'text-red-500' : daysElapsed > 15 ? 'text-amber-500' : 'text-gray-200'}">${daysElapsed} days</span>
                                                    </td>
                                                    <td class="px-3 py-3">
                                                        <span class="font-bold ${inv.days_remaining <= 0 ? 'text-red-500' : inv.days_remaining <= 5 ? 'text-orange-400' : inv.days_remaining <= 10 ? 'text-yellow-400' : 'text-green-500'}">${inv.days_remaining} days</span>
                                                    </td>
                                                    <td class="px-3 py-3">
                                                        ${getStatusBadge(inv.status, inv.days_remaining)}
                                                    </td>
                                                    <td class="px-3 py-3 text-gray-400">${inv.change_count}</td>
                                                </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                ` : `
                                <div class="bg-green-900/30 border border-green-600 rounded-lg p-4 text-center text-green-500">
                                    ‚úì No open investigations. All assets are compliant.
                                </div>
                                `}
                            </div>

                            <!-- Help Section -->
                            <div class="bg-gray-800 border border-gray-600 rounded-lg overflow-hidden">
                                <button id="help-toggle" class="w-full px-4 py-3 text-left font-semibold text-gray-200 hover:bg-gray-700 flex items-center justify-between">
                                    <span>‚ÑπÔ∏è How Compliance Tracking Works</span>
                                    <span id="help-arrow" class="text-gray-400">‚ñº</span>
                                </button>
                                <div id="help-content" class="hidden px-4 py-4 border-t border-gray-600 text-sm text-gray-300 space-y-4">
                                    <div>
                                        <h4 class="font-bold text-blue-400 mb-2">Understanding Change Status vs Asset State</h4>
                                        <div class="space-y-3">
                                            <div class="bg-gray-900 p-3 rounded border border-gray-700">
                                                <p class="font-semibold text-blue-400 mb-1">Change Status (per change record)</p>
                                                <ul class="list-disc ml-4 mt-1 space-y-1 text-gray-400">
                                                    <li><strong class="text-white">Pending</strong> - Change detected, ${investigationsDetail.compliance_window_days}-day timer started automatically.</li>
                                                    <li><strong class="text-amber-400">Investigation</strong> - Change marked for investigation, timer continues.</li>
                                                    <li><strong class="text-green-400">Approved</strong> - Change accepted, will be promoted to baseline.</li>
                                                    <li><strong class="text-red-600">Failed</strong> - Timer expired without resolution.</li>
                                                </ul>
                                            </div>
                                            <div class="bg-gray-900 p-3 rounded border border-gray-700">
                                                <p class="font-semibold text-gray-200 mb-1">Asset State (derived from changes)</p>
                                                <ul class="list-disc ml-4 mt-1 space-y-1 text-gray-400">
                                                    <li><strong class="text-blue-400">Active</strong> - New asset, awaiting group assignment and baseline promotion.</li>
                                                    <li><strong class="text-green-400">Compliant</strong> - Baseline established, no outstanding changes.</li>
                                                    <li><strong class="text-blue-300">Pending</strong> - Asset has pending changes awaiting review.</li>
                                                    <li><strong class="text-amber-400">Investigation</strong> - Asset has one or more changes flagged for investigation.</li>
                                                    <li><strong class="text-red-500">Failed</strong> - Asset has one or more changes with expired timers.</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-blue-400 mb-2">Two Queues on the Dashboard</h4>
                                        <div class="space-y-3">
                                            <div class="bg-gray-900 p-3 rounded border border-gray-700">
                                                <p class="font-semibold text-gray-200 mb-1">üìã Pending Changes Queue</p>
                                                <p>Changes with <strong class="text-white">status = "pending"</strong>. These are newly detected differences with an active ${investigationsDetail.compliance_window_days}-day timer (started on detection). You can:</p>
                                                <ul class="list-disc ml-4 mt-1 text-gray-400">
                                                    <li>Approve - Accept the change and promote to baseline</li>
                                                    <li>Mark for Investigation - Flag for further review (timer continues)</li>
                                                </ul>
                                            </div>
                                            <div class="bg-amber-900/30 p-3 rounded border border-amber-600">
                                                <p class="font-semibold text-amber-400 mb-1">üîç Investigation Queue (Amber Section)</p>
                                                <p>Changes with <strong class="text-white">status = "investigation"</strong>. These are flagged for further review. The Investigation Queue shows:</p>
                                                <ul class="list-disc ml-4 mt-1 text-amber-200/80">
                                                    <li>Time remaining on each change's compliance timer</li>
                                                    <li>Progress bar showing changes reviewed vs remaining</li>
                                                    <li><strong>Investigation Notes</strong> - Document findings, root cause, remediation steps</li>
                                                    <li>Ticket number fields for CMDB linking</li>
                                                </ul>
                                                <p class="mt-2 text-amber-300">Approve or reject changes before their individual timers expire.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-amber-500 mb-2">Per-Change Compliance Timer (v4.0.0)</h4>
                                        <div class="space-y-2">
                                            <p><strong class="text-white">Automatic:</strong> Every change gets a ${investigationsDetail.compliance_window_days}-day timer that starts immediately on detection.</p>
                                            <p><strong class="text-white">Investigation Status:</strong> Click "Investigation" to flag a change for further review. The timer continues unchanged.</p>
                                            <div class="mt-2 p-2 bg-amber-900/30 border border-amber-600 rounded text-amber-200 text-xs">
                                                <strong>‚ö†Ô∏è Key Point:</strong> Approve or reject each change before its individual timer expires to remain compliant.
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-amber-500 mb-2">Timer Status Indicators</h4>
                                        <p>Each change shows its timer status based on days remaining until the <strong class="text-white">${investigationsDetail.compliance_window_days}-day deadline</strong>:</p>
                                        <ul class="space-y-1 ml-4 mt-2">
                                            <li><span class="px-2 py-0.5 rounded text-xs bg-green-700 text-white">XX DAYS</span> - On Track: More than ${investigationsDetail.thresholds ? investigationsDetail.thresholds.green : 10} days remaining</li>
                                            <li><span class="px-2 py-0.5 rounded text-xs bg-amber-800 text-white">XX DAYS</span> - Warning: ${investigationsDetail.thresholds ? investigationsDetail.thresholds.critical + 1 : 6}-${investigationsDetail.thresholds ? investigationsDetail.thresholds.yellow : 10} days remaining</li>
                                            <li><span class="px-2 py-0.5 rounded text-xs bg-amber-700 text-white">XX DAYS</span> - Critical: ${investigationsDetail.thresholds ? investigationsDetail.thresholds.critical : 5} or fewer days remaining</li>
                                            <li><span class="px-2 py-0.5 rounded text-xs bg-red-800 text-white">OVERDUE</span> - Failed: Timer expired, change requires PNCI</li>
                                        </ul>
                                        <p class="text-xs text-gray-500 mt-2 italic">Thresholds configurable in Settings ‚Üí CIP-010 Compliance Check Schedule</p>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-green-500 mb-2">Resolving Changes</h4>
                                        <ol class="list-decimal ml-6 space-y-1">
                                            <li>Review changes on the <strong class="text-blue-400">Dashboard</strong> or <strong class="text-amber-400">Investigation Queue</strong></li>
                                            <li>For each change, enter a <strong>ticket number</strong> (links to CMDB)</li>
                                            <li>Add <strong>Investigation Notes</strong> if needed (optional but recommended for investigations)</li>
                                            <li>Click <strong class="text-green-400">Approve</strong> for each change (or <strong class="text-sky-400">Investigate</strong> for further review)</li>
                                            <li>Click <strong>"Finalize Reviewed Changes"</strong> to apply your decisions</li>
                                        </ol>
                                        <p class="mt-2 text-gray-400">Approved changes update the baseline. The asset returns to <strong class="text-green-400">Compliant</strong> when all changes are resolved.</p>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-red-500 mb-2">PNCI / Extent of Condition Reporting</h4>
                                        <p>Changes that exceed the ${investigationsDetail.compliance_window_days}-day window (FAILED status) require:</p>
                                        <ul class="list-disc ml-6 space-y-1">
                                            <li><strong>PNCI</strong> - Potential Non-Compliance Identification documentation</li>
                                            <li><strong>Extent of Condition</strong> review to identify similar issues across other assets</li>
                                            <li><strong>Corrective Action Plan</strong> submission to address the root cause</li>
                                        </ul>
                                        <p class="mt-2">Use the <strong>"Baseline Report"</strong> button above to create documentation for compliance records.</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                `;

                // Event handlers - view report buttons
                document.querySelectorAll('.view-report-btn').forEach(function(btn) {
                    btn.addEventListener('click', async function() {
                        var reportId = this.getAttribute('data-report-id');
                        try {
                            var report = await api('/api/reports/' + reportId);
                            document.getElementById('report-title').textContent = report.title || 'Compliance Report';
                            document.getElementById('report-content').textContent = report.report_content;
                            document.getElementById('report-modal').classList.remove('hidden');

                            document.getElementById('report-close').onclick = function() {
                                document.getElementById('report-modal').classList.add('hidden');
                            };

                            document.getElementById('report-download').onclick = function() {
                                var blob = new Blob([report.report_content], { type: 'text/plain' });
                                var url = URL.createObjectURL(blob);
                                var a = document.createElement('a');
                                a.href = url;
                                a.download = 'CIP010_report_' + reportId + '.txt';
                                a.click();
                                URL.revokeObjectURL(url);
                            };

                            document.getElementById('report-copy').onclick = function() {
                                navigator.clipboard.writeText(report.report_content).then(function() {
                                    alert('Report copied to clipboard!');
                                });
                            };
                        } catch (err) {
                            if (err.message.includes('404')) {
                                alert('Report not found. It may have been deleted or was never generated.');
                            } else {
                                alert('Error loading report: ' + err.message);
                            }
                        }
                    });
                });

                // Event handlers - view check details buttons
                document.querySelectorAll('.view-check-details-btn').forEach(function(btn) {
                    btn.addEventListener('click', async function() {
                        var checkId = this.getAttribute('data-check-id');
                        try {
                            var checkDetails = await api('/api/reports/scheduled-checks/' + checkId);
                            var content = 'SCHEDULED CHECK DETAILS\\n';
                            content += '=' .repeat(50) + '\\n\\n';
                            content += 'Check ID: ' + checkDetails.id + '\\n';
                            content += 'Date: ' + checkDetails.scheduled_date + '\\n';
                            content += 'Executed: ' + (checkDetails.executed_at || 'Not yet') + '\\n';
                            content += 'Status: ' + checkDetails.status.toUpperCase() + '\\n';
                            content += 'Trigger: ' + (checkDetails.trigger_type === 'manual' ? 'Manual' : 'Scheduled Auto-Check') + '\\n';
                            if (checkDetails.triggered_by) {
                                content += 'Triggered By: ' + checkDetails.triggered_by + '\\n';
                            }
                            content += '\\n';
                            content += '-' .repeat(40) + '\\n';
                            content += 'SUMMARY\\n';
                            content += '-' .repeat(40) + '\\n';
                            content += 'Assets Checked: ' + checkDetails.assets_checked + '\\n';
                            content += 'Assets Unchanged: ' + checkDetails.assets_unchanged + '\\n';
                            content += 'Changes Detected: ' + checkDetails.changes_detected + '\\n';
                            content += 'Assets in Investigation: ' + checkDetails.assets_in_investigation + '\\n';
                            content += '\\n';

                            if (checkDetails.investigated_assets && checkDetails.investigated_assets.length > 0) {
                                content += '-' .repeat(40) + '\\n';
                                content += 'INVESTIGATED ASSETS\\n';
                                content += '-' .repeat(40) + '\\n\\n';

                                checkDetails.investigated_assets.forEach(function(asset) {
                                    var reasonText = asset.reason === 'new_changes' ? 'New changes detected' : 'Existing investigation';
                                    content += '  ‚Ä¢ ' + asset.asset_name + '\\n';
                                    content += '    Reason: ' + reasonText + '\\n';
                                    if (asset.changes && asset.changes.length > 0) {
                                        content += '    Changed Fields: ' + asset.changes.join(', ') + '\\n';
                                    }
                                    if (asset.new_changes_found > 0) {
                                        content += '    New Changes: ' + asset.new_changes_found + '\\n';
                                    }
                                    if (asset.pending_changes > 0) {
                                        content += '    Pending Changes: ' + asset.pending_changes + '\\n';
                                    }
                                    if (asset.approaching_deadline) {
                                        content += '    ‚ö†Ô∏è Approaching Deadline\\n';
                                    }
                                    if (asset.past_deadline) {
                                        content += '    ‚ùå Past Deadline (FAILED)\\n';
                                    }
                                    content += '\\n';
                                });
                            } else {
                                content += '-' .repeat(40) + '\\n';
                                content += 'No assets investigated in this check.\\n';
                            }

                            if (checkDetails.error_message) {
                                content += '\\n';
                                content += '-' .repeat(40) + '\\n';
                                content += 'ERROR\\n';
                                content += '-' .repeat(40) + '\\n';
                                content += checkDetails.error_message + '\\n';
                            }

                            document.getElementById('report-title').textContent = 'Check Details - ' + checkDetails.scheduled_date;
                            document.getElementById('report-content').textContent = content;
                            document.getElementById('report-modal').classList.remove('hidden');

                            document.getElementById('report-close').onclick = function() {
                                document.getElementById('report-modal').classList.add('hidden');
                            };

                            document.getElementById('report-download').onclick = function() {
                                var blob = new Blob([content], { type: 'text/plain' });
                                var url = URL.createObjectURL(blob);
                                var a = document.createElement('a');
                                a.href = url;
                                a.download = 'check_details_' + checkId + '.txt';
                                a.click();
                                URL.revokeObjectURL(url);
                            };

                            document.getElementById('report-copy').onclick = function() {
                                navigator.clipboard.writeText(content).then(function() {
                                    alert('Details copied to clipboard!');
                                });
                            };
                        } catch (err) {
                            alert('Error loading check details: ' + err.message);
                        }
                    });
                });

                // Event handlers - investigation rows (click to go to asset)
                document.querySelectorAll('.investigation-row').forEach(function(row) {
                    row.addEventListener('click', async function() {
                        var assetId = this.getAttribute('data-asset-id');
                        selectedAsset = await api('/api/assets/' + assetId);
                        currentView = 'assetDetail';
                        render();
                    });
                });

                // Event handler - help toggle
                document.getElementById('help-toggle').addEventListener('click', function() {
                    var content = document.getElementById('help-content');
                    var arrow = document.getElementById('help-arrow');
                    if (content.classList.contains('hidden')) {
                        content.classList.remove('hidden');
                        arrow.textContent = '‚ñ≤';
                    } else {
                        content.classList.add('hidden');
                        arrow.textContent = '‚ñº';
                    }
                });

                // Event handler - Historical Baseline Report (direct download)
                document.getElementById('generate-baseline-report-btn').addEventListener('click', async function() {
                    var dateInput = document.getElementById('compliance-date').value;
                    if (!dateInput) {
                        alert('Please select a date');
                        return;
                    }

                    try {
                        // Trigger direct download - the API returns a file
                        var downloadUrl = '/api/reports/compliance/baseline-report?report_date=' + dateInput;

                        // Fetch with auth header, then create blob download
                        var response = await fetch(downloadUrl, {
                            headers: {
                                'Authorization': 'Bearer ' + authToken
                            }
                        });

                        if (!response.ok) {
                            var errorData = await response.json();
                            throw new Error(errorData.detail || 'Failed to generate report');
                        }

                        var blob = await response.blob();
                        var url = URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'Baseline_Report_' + dateInput + '.txt';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (err) {
                        alert('Error generating baseline report: ' + err.message);
                    }
                });

                // Event handler - Custom Baseline PDF Report
                var customBaselineBtn = document.getElementById('generate-custom-baseline-btn');
                if (customBaselineBtn) {
                    customBaselineBtn.addEventListener('click', async function() {
                        var dateInput = document.getElementById('compliance-date').value;
                        var assetNames = document.getElementById('custom-baseline-assets').value.trim();
                        
                        if (!dateInput) {
                            alert('Please select a date');
                            return;
                        }
                        if (!assetNames) {
                            alert('Please enter asset names (comma-separated) for the custom PDF report');
                            return;
                        }
                        
                        try {
                            var downloadUrl = '/api/reports/compliance/custom-baseline-pdf?report_date=' + encodeURIComponent(dateInput) + '&asset_names=' + encodeURIComponent(assetNames);
                            
                            var response = await fetch(downloadUrl, {
                                headers: {
                                    'Authorization': 'Bearer ' + authToken
                                }
                            });
                            
                            if (!response.ok) {
                                var errorData = await response.json();
                                throw new Error(errorData.detail || 'Failed to generate PDF');
                            }
                            
                            var blob = await response.blob();
                            var url = URL.createObjectURL(blob);
                            var a = document.createElement('a');
                            a.href = url;
                            a.download = 'Custom_Baseline_' + dateInput + '.pdf';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                        } catch (err) {
                            alert('Error generating custom baseline PDF: ' + err.message);
                        }
                    });
                }

                // Event handler - Investigation Report (direct download)
                document.getElementById('generate-investigation-report-btn').addEventListener('click', async function() {
                    var dateInput = document.getElementById('compliance-date').value;
                    if (!dateInput) {
                        alert('Please select a date');
                        return;
                    }

                    try {
                        // Trigger direct download - the API returns a file
                        var downloadUrl = '/api/reports/compliance/investigation-report?report_date=' + dateInput;

                        // Fetch with auth header, then create blob download
                        var response = await fetch(downloadUrl, {
                            headers: {
                                'Authorization': 'Bearer ' + authToken
                            }
                        });

                        if (!response.ok) {
                            var errorData = await response.json();
                            throw new Error(errorData.detail || 'Failed to generate report');
                        }

                        var blob = await response.blob();
                        var url = URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'Investigation_Report_' + dateInput + '.txt';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (err) {
                        alert('Error generating investigation report: ' + err.message);
                    }
                });

                // Event handler - Ticket Search
                document.getElementById('ticket-search-btn').addEventListener('click', async function() {
                    var ticketNum = document.getElementById('ticket-search-input').value.trim();
                    if (!ticketNum) {
                        alert('Please enter a ticket number');
                        return;
                    }
                    try {
                        var results = await api('/api/changes/ticket-search/' + encodeURIComponent(ticketNum));
                        showTicketSearchResultsModal(ticketNum, results);
                    } catch (err) {
                        alert('Error searching ticket: ' + err.message);
                    }
                });

                // Also search on Enter key
                document.getElementById('ticket-search-input').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('ticket-search-btn').click();
                    }
                });

                // Event handler - Open Manual Comparison Tool
                document.getElementById('open-compare-tool-btn').addEventListener('click', function() {
                    previousView = currentView;  // Remember where we came from
                    currentView = 'compare';
                    render();
                });

                // Event handlers - User Audit (Admin Only)
                if (currentUser && currentUser.role === 'admin') {
                    // Load users into dropdown
                    try {
                        var auditSummary = await api('/api/system/audit/users');
                        var selectEl = document.getElementById('audit-user-select');
                        if (selectEl && auditSummary.users) {
                            auditSummary.users.forEach(function(user) {
                                var opt = document.createElement('option');
                                opt.value = user.user_id;
                                opt.textContent = user.username + ' (' + user.total_actions + ' actions)';
                                selectEl.appendChild(opt);
                            });
                        }
                    } catch (e) {
                        console.error('Failed to load audit users:', e);
                    }

                    // View user audit button
                    document.getElementById('view-user-audit-btn').addEventListener('click', async function() {
                        var userId = document.getElementById('audit-user-select').value;
                        if (!userId) {
                            alert('Please select a user');
                            return;
                        }
                        try {
                            var auditData = await api('/api/system/audit/users/' + userId + '?limit=200');
                            showUserAuditModal(auditData);
                        } catch (err) {
                            alert('Error loading user audit: ' + err.message);
                        }
                    });
                }

                // Load investigation closures with dynamic filtering
                loadInvestigationClosures();

            } catch (err) {
                container.innerHTML = '<div class="text-center py-12"><p class="text-red-500">Error loading compliance data: ' + escapeHtml(err.message) + '</p></div>';
            }
        }

        // Quick Start Guide Modal
        function showQuickStartGuide() {
            var modal = document.getElementById('quick-start-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'quick-start-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                document.body.appendChild(modal);
            }

            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col border border-gray-600">
                    <div class="flex justify-between items-center p-4 border-b border-gray-600 bg-green-900/30">
                        <div>
                            <h3 class="text-xl font-semibold text-white">üìñ Quick Start Guide</h3>
                            <p class="text-sm text-gray-400">Step-by-step tutorials for common tasks</p>
                        </div>
                        <button id="quick-start-close" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                    </div>
                    <div class="p-6 overflow-y-auto flex-grow space-y-6">

                        <!-- Tutorial 1: Initial Baseline -->
                        <div class="bg-gray-700 rounded-lg p-5 border border-gray-600">
                            <h4 class="text-lg font-semibold text-emerald-400 mb-3">1. Creating an Initial Baseline</h4>
                            <p class="text-sm text-gray-300 mb-4">When a new asset configuration is uploaded for the first time:</p>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-300">
                                <li>Go to <strong class="text-white">Assets</strong> page</li>
                                <li>Look for the yellow <strong class="text-amber-500">"Awaiting Review"</strong> banner at the top</li>
                                <li>Click <strong class="text-white">Review & Promote</strong> on the new asset</li>
                                <li>Review the configuration data displayed</li>
                                <li>Select the appropriate <strong class="text-white">Team</strong> from the dropdown (Server, Desktop, Network, Telecom)</li>
                                <li><span class="text-red-500 font-medium">Enter a Ticket Number</span> - This is <strong>required</strong> for audit compliance</li>
                                <li>Click <strong class="text-white">Promote Baseline</strong></li>
                            </ol>
                            <div class="mt-4 p-3 bg-amber-900/30 border border-amber-600/50 rounded text-sm">
                                <p class="text-amber-200"><strong>‚ö†Ô∏è Ticket Requirement:</strong> All baseline promotions require a Change Management ticket number. This creates an audit trail documenting authorization for the initial configuration.</p>
                            </div>
                        </div>

                        <!-- Tutorial 2: Single Change on One Asset -->
                        <div class="bg-gray-700 rounded-lg p-5 border border-gray-600">
                            <h4 class="text-lg font-semibold text-blue-400 mb-3">2. Reviewing a Single Change on One Asset</h4>
                            <p class="text-sm text-gray-300 mb-4">When one field changes on a specific asset:</p>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-300">
                                <li>The change appears on <strong class="text-white">Dashboard</strong> under "Asset-Specific Changes"</li>
                                <li>Review the change card showing: field name, old value ‚Üí new value</li>
                                <li><span class="text-red-500 font-medium">Enter a Ticket Number</span> in the ticket field on the change card</li>
                                <li>Choose an action:
                                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1 text-gray-400">
                                        <li><span class="text-green-500">Approve</span> - Accept the change, update the baseline to the new value</li>
                                        <li><span class="text-yellow-400">Investigate</span> - Flag for investigation (timer continues from detection)</li>
                                    </ul>
                                </li>
                                <li>Click <strong class="text-white">Finalize Reviewed Changes</strong> to apply your decision</li>
                            </ol>
                        </div>

                        <!-- Tutorial 3: Multiple Changes on One Asset -->
                        <div class="bg-gray-700 rounded-lg p-5 border border-gray-600">
                            <h4 class="text-lg font-semibold text-slate-400 mb-3">3. Multiple Changes on One Asset</h4>
                            <p class="text-sm text-gray-300 mb-4">When several fields change on the same asset:</p>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-300">
                                <li>All changes for the asset appear grouped together on the Dashboard</li>
                                <li>You can use <strong class="text-white">Per-Asset Ticket</strong> to apply one ticket number to all changes for that asset:
                                    <ul class="list-disc list-inside ml-4 mt-1 text-gray-400">
                                        <li>Enter the ticket number in the asset's ticket field</li>
                                        <li>Click <strong class="text-white">Apply to Asset</strong></li>
                                    </ul>
                                </li>
                                <li>Review and decide on each change individually (Approve or Investigate)</li>
                                <li>Or use different tickets for different changes by entering them on each change card</li>
                                <li>Click <strong class="text-white">Finalize Reviewed Changes</strong></li>
                            </ol>
                            <div class="mt-4 p-3 bg-blue-900/30 border border-blue-600/50 rounded text-sm">
                                <p class="text-blue-200"><strong>üí° Tip:</strong> Per-field tickets override per-asset tickets. Use per-field when changes have different authorizations.</p>
                            </div>
                        </div>

                        <!-- Tutorial 4: Same Change Across Multiple Assets -->
                        <div class="bg-gray-700 rounded-lg p-5 border border-gray-600">
                            <h4 class="text-lg font-semibold text-blue-400 mb-3">4. Same Change Across Multiple Assets</h4>
                            <p class="text-sm text-gray-300 mb-4">When identical changes appear on multiple assets (e.g., software version update):</p>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-300">
                                <li>These appear as <strong class="text-white">Grouped Changes</strong> on the Dashboard</li>
                                <li>The card shows "Affects X assets" - click <strong class="text-white">View affected assets</strong> to see the list</li>
                                <li>Enter a ticket number in the <strong class="text-white">Asset Ticket</strong> field to apply to all changes for that asset</li>
                                <li>Or use <strong class="text-white">Per-Field Ticket</strong> for individual field-level tracking</li>
                                <li>Click <strong class="text-green-500">Approve</strong> to accept the change for ALL affected assets at once</li>
                                <li>Click <strong class="text-white">Finalize Reviewed Changes</strong></li>
                            </ol>
                            <div class="mt-4 p-3 bg-slate-800/30 border border-slate-600/50 rounded text-sm">
                                <p class="text-blue-200"><strong>üí° Bulk Actions:</strong> Grouped changes let you approve/reject the same change across dozens of assets with one click, saving significant time during patch cycles.</p>
                            </div>
                        </div>

                        <!-- Tutorial 5: Reverting a Change -->
                        <div class="bg-gray-700 rounded-lg p-5 border border-gray-600">
                            <h4 class="text-lg font-semibold text-orange-400 mb-3">5. Reverting an Approved Change</h4>
                            <p class="text-sm text-gray-300 mb-4">If you need to undo a previously approved change:</p>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-300">
                                <li>Go to <strong class="text-white">Assets</strong> ‚Üí click the asset</li>
                                <li>Expand <strong class="text-white">Approved Changes History</strong></li>
                                <li>Find the change you want to revert</li>
                                <li>Click <strong class="text-white">Revert</strong> on that change</li>
                                <li>The baseline reverts to the previous value</li>
                            </ol>
                            <div class="mt-4 p-3 bg-orange-900/30 border border-orange-600/50 rounded text-sm">
                                <p class="text-orange-200"><strong>‚ö†Ô∏è Revert Conditions:</strong></p>
                                <ul class="list-disc list-inside mt-1 text-orange-200/80">
                                    <li>Only <strong>approved</strong> changes can be reverted</li>
                                    <li>The change must be the most recent for that field (can't skip over later changes)</li>
                                    <li>Reverts are logged in the audit trail</li>
                                    <li>Use this when a change was approved in error or needs to be rolled back</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Tutorial 6: Renaming an Asset -->
                        <div class="bg-gray-700 rounded-lg p-5 border border-gray-600">
                            <h4 class="text-lg font-semibold text-slate-400 mb-3">6. Renaming an Asset (FQDN Change)</h4>
                            <p class="text-sm text-gray-300 mb-4">When an asset's hostname/FQDN changes (server rename, domain migration):</p>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-300">
                                <li>Go to <strong class="text-white">Assets</strong> ‚Üí click the asset to rename</li>
                                <li>Scroll to the bottom of the asset detail page</li>
                                <li>Click <strong class="text-white">Rename Asset</strong></li>
                                <li>Enter the <strong class="text-white">new FQDN/hostname</strong></li>
                                <li>Click <strong class="text-white">Submit Rename Request</strong></li>
                                <li>The rename appears as a <strong class="text-white">pending change</strong> requiring approval</li>
                                <li>Go to Dashboard, find the rename change (shows as "Asset Name (FQDN)")</li>
                                <li><span class="text-red-500 font-medium">Enter a Ticket Number</span> and click <strong class="text-green-500">Approve</strong></li>
                                <li>Click <strong class="text-white">Finalize</strong> to complete the rename</li>
                            </ol>
                            <div class="mt-4 p-3 bg-slate-800/30 border border-slate-600/50 rounded text-sm">
                                <p class="text-slate-300"><strong>Why use Rename?</strong> The FQDN is the unique identifier matching config files to assets. Renaming preserves all baseline history, changes, and audit logs. Future uploads must use the new name.</p>
                            </div>
                        </div>

                        <!-- Tutorial 7: Retiring an Asset -->
                        <div class="bg-gray-700 rounded-lg p-5 border border-gray-600">
                            <h4 class="text-lg font-semibold text-gray-400 mb-3">7. Retiring an Asset</h4>
                            <p class="text-sm text-gray-300 mb-4">When decommissioning an asset:</p>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-300">
                                <li>Go to <strong class="text-white">Assets</strong> ‚Üí click the asset to retire</li>
                                <li>Scroll to the bottom of the asset detail page</li>
                                <li>Click <strong class="text-white">Retire Asset</strong></li>
                                <li><span class="text-red-500 font-medium">Enter a Ticket Number</span> - Required for audit compliance</li>
                                <li>Click <strong class="text-white">Confirm Retirement</strong></li>
                            </ol>
                            <div class="mt-4 p-3 bg-gray-900/50 border border-gray-500/50 rounded text-sm">
                                <p class="text-gray-300"><strong>Retired Asset Behavior:</strong></p>
                                <ul class="list-disc list-inside mt-1 text-gray-400">
                                    <li>Excluded from scheduled compliance checks</li>
                                    <li>Not included in change detection</li>
                                    <li>Full history preserved for audit (3+ years)</li>
                                </ul>
                            </div>

                            <h5 class="text-md font-semibold text-gray-300 mt-5 mb-2">Viewing Retired Assets:</h5>
                            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-300">
                                <li>Go to <strong class="text-white">Assets</strong> page</li>
                                <li>Click the <strong class="text-white">Retired</strong> tab at the top</li>
                                <li>Retired assets appear dimmed in the list</li>
                                <li>Click any retired asset to view its:
                                    <ul class="list-disc list-inside ml-4 mt-1 text-gray-400">
                                        <li>Final baseline configuration</li>
                                        <li>Complete change history</li>
                                        <li>Full audit log</li>
                                        <li>Retirement date and ticket</li>
                                    </ul>
                                </li>
                                <li>To restore: click <strong class="text-white">Restore Asset</strong> to return it to active status</li>
                            </ol>
                        </div>

                        <!-- Ticket Requirements Summary -->
                        <div class="bg-red-900/30 rounded-lg p-5 border border-red-600/50">
                            <h4 class="text-lg font-semibold text-red-500 mb-3">üìã Ticket Requirements Summary</h4>
                            <p class="text-sm text-gray-300 mb-3">The following actions <strong>require</strong> a Change Management ticket number:</p>
                            <ul class="list-disc list-inside space-y-1 text-sm text-gray-300">
                                <li>Promoting an initial baseline</li>
                                <li>Approving a change</li>
                                <li>Opening an investigation</li>
                                <li>Approving an asset rename</li>
                                <li>Retiring an asset</li>
                            </ul>
                            <p class="text-sm text-red-300 mt-3">All ticket numbers are recorded in the audit log and included in compliance reports.</p>
                        </div>

                    </div>
                    <div class="p-4 border-t border-gray-600 bg-gray-900/50 flex justify-between items-center">
                        <p class="text-xs text-gray-500">Press ? or click Help in the navigation for complete documentation</p>
                        <button id="quick-start-close-btn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500 text-sm">Close</button>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');

            document.getElementById('quick-start-close').onclick = function() {
                modal.classList.add('hidden');
            };
            document.getElementById('quick-start-close-btn').onclick = function() {
                modal.classList.add('hidden');
            };
            modal.onclick = function(e) {
                if (e.target === modal) modal.classList.add('hidden');
            };
        }

        // User Audit Modal
        function showUserAuditModal(auditData) {
            var modal = document.getElementById('user-audit-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'user-audit-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
                modal.innerHTML = `
                    <div class="bg-gray-800 rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] flex flex-col border border-gray-600">
                        <div class="flex justify-between items-center p-4 border-b border-gray-600 bg-slate-800/30">
                            <div>
                                <h3 id="user-audit-title" class="text-lg font-semibold text-white"></h3>
                                <p id="user-audit-subtitle" class="text-sm text-gray-400"></p>
                            </div>
                            <button id="user-audit-close" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div id="user-audit-content" class="p-4 overflow-y-auto flex-grow"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            var user = auditData.user;
            document.getElementById('user-audit-title').textContent = 'User Activity: ' + user.username;
            document.getElementById('user-audit-subtitle').textContent = user.full_name + ' (' + user.role + ') - ' + auditData.total + ' total actions';

            // Build action type summary
            var actionCounts = {};
            auditData.logs.forEach(function(log) {
                actionCounts[log.action] = (actionCounts[log.action] || 0) + 1;
            });

            var summaryHtml = '<div class="flex flex-wrap gap-2 mb-4">';
            Object.keys(actionCounts).sort(function(a, b) { return actionCounts[b] - actionCounts[a]; }).forEach(function(action) {
                var color = getActionColor(action);
                summaryHtml += '<span class="px-2 py-1 text-xs rounded ' + color + '">' + escapeHtml(action.replace(/_/g, ' ')) + ' (' + actionCounts[action] + ')</span>';
            });
            summaryHtml += '</div>';

            // Build log table
            var html = summaryHtml;
            html += '<div class="bg-gray-900 border border-gray-700 rounded-lg overflow-hidden">';
            html += '<table class="w-full text-sm">';
            html += '<thead class="bg-gray-800">';
            html += '<tr>';
            html += '<th class="px-3 py-2 text-left text-gray-300 text-xs">Timestamp</th>';
            html += '<th class="px-3 py-2 text-left text-gray-300 text-xs">Action</th>';
            html += '<th class="px-3 py-2 text-left text-gray-300 text-xs">Details</th>';
            html += '<th class="px-3 py-2 text-left text-gray-300 text-xs">Asset</th>';
            html += '<th class="px-3 py-2 text-left text-gray-300 text-xs">Ticket</th>';
            html += '</tr>';
            html += '</thead><tbody>';

            auditData.logs.forEach(function(log) {
                var actionBadge = '<span class="px-2 py-0.5 text-xs rounded ' + getActionColor(log.action) + '">' + escapeHtml(log.action.replace(/_/g, ' ')) + '</span>';
                var timestamp = new Date(log.timestamp).toLocaleString();
                var detail = log.action_detail ? (log.action_detail.length > 60 ? log.action_detail.substring(0, 57) + '...' : log.action_detail) : '-';
                
                // Get ticket number from details (already parsed by backend)
                var ticket = '';
                if (log.details && log.details.ticket_number) {
                    ticket = log.details.ticket_number;
                }

                html += '<tr class="border-t border-gray-700 hover:bg-gray-800">';
                html += '<td class="px-3 py-2 text-gray-400 text-xs whitespace-nowrap">' + timestamp + '</td>';
                html += '<td class="px-3 py-2">' + actionBadge + '</td>';
                html += '<td class="px-3 py-2 text-gray-300 text-xs">' + escapeHtml(detail) + '</td>';
                html += '<td class="px-3 py-2 text-blue-400 text-xs">' + (log.asset_name ? escapeHtml(log.asset_name) : '-') + '</td>';
                html += '<td class="px-3 py-2 text-amber-400 text-xs">' + (ticket ? escapeHtml(ticket) : '-') + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            if (auditData.total > auditData.logs.length) {
                html += '<p class="text-xs text-gray-500 mt-3 text-center">Showing ' + auditData.logs.length + ' of ' + auditData.total + ' total actions</p>';
            }

            document.getElementById('user-audit-content').innerHTML = html;
            modal.classList.remove('hidden');

            document.getElementById('user-audit-close').onclick = function() {
                modal.classList.add('hidden');
            };
            modal.onclick = function(e) {
                if (e.target === modal) modal.classList.add('hidden');
            };
        }

        function getActionColor(action) {
            var colors = {
                'create_asset': 'bg-green-700 text-green-100',
                'upload_changes': 'bg-blue-700 text-blue-100',
                'promote_initial_baseline': 'bg-green-800 text-green-200',
                'assign_group': 'bg-blue-800 text-blue-100',
                'change_approved': 'bg-green-800 text-green-100',
                'bulk_approved': 'bg-green-800 text-green-100',
                'change_rejected': 'bg-red-700 text-red-100',
                'bulk_rejected': 'bg-red-700 text-red-100',
                'change_investigation': 'bg-yellow-700 text-yellow-100',
                'bulk_investigation': 'bg-yellow-700 text-yellow-100',
                'finalize_baselines': 'bg-slate-700 text-slate-100',
                'delete_asset': 'bg-red-800 text-red-100',
                'rename_asset': 'bg-amber-800 text-orange-100',
                'retire_asset': 'bg-gray-600 text-gray-100',
                'scheduled_check': 'bg-slate-700 text-slate-200',
                'manual_config_edit': 'bg-amber-700 text-amber-100',
                'password_reset': 'bg-purple-700 text-purple-100',
                'revert_approval': 'bg-orange-700 text-orange-100'
            };
            return colors[action] || 'bg-gray-600 text-gray-200';
        }

        // Ticket Search Results Modal with color highlighting and print support
        function showTicketSearchResultsModal(ticketNumber, results) {
            var modal = document.getElementById('ticket-search-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'ticket-search-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
                modal.innerHTML = `
                    <div class="bg-gray-800 rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] flex flex-col border border-gray-600">
                        <div class="flex justify-between items-center p-4 border-b border-gray-600 bg-blue-900/30">
                            <div>
                                <h3 id="ticket-search-title" class="text-lg font-semibold text-white"></h3>
                                <p id="ticket-search-subtitle" class="text-sm text-gray-400"></p>
                            </div>
                            <button id="ticket-search-close" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div class="p-4 overflow-auto flex-1">
                            <div id="ticket-search-content"></div>
                        </div>
                        <div class="p-4 border-t border-gray-600 flex justify-end gap-3">
                            <button id="ticket-search-pdf" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Download PDF</button>
                            <button id="ticket-search-print" class="px-4 py-2 bg-slate-600 text-white rounded hover:bg-slate-700 text-sm">üñ®Ô∏è Print Report</button>
                            <button id="ticket-search-close-btn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 text-sm">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // API returns { assets: [{asset_name, changes: [...]}], total_changes, ... }
            var totalChanges = results.total_changes || 0;
            var assetCount = results.total_assets || 0;
            var assets = {};
            (results.assets || []).forEach(function(a) {
                assets[a.asset_name] = a.changes || [];
            });

            document.getElementById('ticket-search-title').textContent = 'Ticket Search: ' + ticketNumber;
            document.getElementById('ticket-search-subtitle').textContent = totalChanges + ' change(s) across ' + assetCount + ' asset(s)';

            // Build the content HTML grouped by asset
            var html = '<div id="ticket-search-printable">';
            html += '<div class="mb-4 p-3 bg-blue-900/30 rounded border border-blue-700">';
            html += '<p class="text-sm text-blue-200"><strong>Ticket Number:</strong> ' + escapeHtml(ticketNumber) + '</p>';
            html += '<p class="text-sm text-blue-200"><strong>Total Changes:</strong> ' + totalChanges + '</p>';
            html += '<p class="text-sm text-blue-200"><strong>Assets Affected:</strong> ' + assetCount + '</p>';
            html += '</div>';

            if (totalChanges === 0) {
                html += '<div class="text-center py-8 text-gray-400">No changes found for this ticket number.</div>';
            } else {
                Object.keys(assets).sort().forEach(function(assetName) {
                    var assetChanges = assets[assetName];
                    html += '<div class="mb-6 bg-gray-700/50 rounded-lg border border-gray-600 overflow-hidden">';
                    html += '<div class="px-4 py-3 bg-gray-700 border-b border-gray-600">';
                    html += '<h4 class="text-md font-semibold text-white">' + escapeHtml(assetName) + '</h4>';
                    html += '<p class="text-xs text-gray-400">' + assetChanges.length + ' change(s)</p>';
                    html += '</div>';
                    html += '<table class="w-full text-sm">';
                    html += '<thead class="bg-gray-800"><tr>';
                    html += '<th class="p-3 text-left text-gray-300">Field</th>';
                    html += '<th class="p-3 text-left text-gray-300 bg-red-900/20">Before</th>';
                    html += '<th class="p-3 text-left text-gray-300 bg-green-900/20">After</th>';
                    html += '<th class="p-3 text-left text-gray-300">Status</th>';
                    html += '<th class="p-3 text-left text-gray-300">Date</th>';
                    html += '</tr></thead><tbody>';

                    assetChanges.forEach(function(change) {
                        var oldVal = formatValue(change.old_value);
                        var newVal = formatValue(change.new_value);
                        var oldDisplay = oldVal.length > 50 ? oldVal.substring(0, 47) + '...' : oldVal;
                        var newDisplay = newVal.length > 50 ? newVal.substring(0, 47) + '...' : newVal;

                        var statusBadge = '';
                        var status = (change.status || '').toLowerCase();
                        if (status === 'approved') {
                            statusBadge = '<span class="px-2 py-1 text-xs rounded bg-green-700 text-green-100">APPROVED</span>';
                        } else if (status === 'rejected') {
                            statusBadge = '<span class="px-2 py-1 text-xs rounded bg-red-700 text-red-100">REJECTED</span>';
                        } else if (status === 'pending') {
                            statusBadge = '<span class="px-2 py-1 text-xs rounded bg-yellow-700 text-yellow-100">PENDING</span>';
                        } else {
                            statusBadge = '<span class="px-2 py-1 text-xs rounded bg-gray-600 text-gray-300">' + escapeHtml(change.status || 'UNKNOWN') + '</span>';
                        }

                        var dateStr = change.finalized_at ? new Date(change.finalized_at).toLocaleDateString() :
                                      change.created_at ? new Date(change.created_at).toLocaleDateString() : '‚Äî';

                        html += '<tr class="border-t border-gray-600">';
                        html += '<td class="p-3 font-mono text-xs text-amber-400">' + escapeHtml(formatFieldPath(change.field_path || change.field || '‚Äî')) + '</td>';
                        html += '<td class="p-3 bg-red-900/10"><code class="text-xs text-red-300">' + escapeHtml(oldDisplay) + '</code></td>';
                        html += '<td class="p-3 bg-green-900/10"><code class="text-xs text-green-300">' + escapeHtml(newDisplay) + '</code></td>';
                        html += '<td class="p-3">' + statusBadge + '</td>';
                        html += '<td class="p-3 text-gray-400 text-xs">' + dateStr + '</td>';
                        html += '</tr>';
                    });

                    html += '</tbody></table></div>';
                });
            }
            html += '</div>';

            document.getElementById('ticket-search-content').innerHTML = html;
            modal.classList.remove('hidden');

            // Event handlers
            document.getElementById('ticket-search-close').onclick = function() {
                modal.classList.add('hidden');
            };
            document.getElementById('ticket-search-close-btn').onclick = function() {
                modal.classList.add('hidden');
            };
            document.getElementById('ticket-search-pdf').onclick = async function() {
                // Download PDF via API with authentication
                var btn = this;
                btn.disabled = true;
                btn.textContent = 'Generating...';

                try {
                    var resp = await fetch('/api/reports/ticket-search-pdf/' + encodeURIComponent(ticketNumber), {
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('cip010_token')
                        }
                    });

                    if (!resp.ok) {
                        var contentType = resp.headers.get('content-type') || '';
                        if (contentType.includes('application/json')) {
                            var errData = await resp.json();
                            throw new Error(errData.detail || 'Download failed');
                        }
                        throw new Error('Download failed: ' + resp.status);
                    }
                    var blob = await resp.blob();
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'ticket_report_' + ticketNumber.replace(/[^a-zA-Z0-9]/g, '_') + '.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } catch (err) {
                    alert('Error downloading PDF: ' + err.message);
                }

                btn.textContent = 'Download PDF';
                btn.disabled = false;
            };
            document.getElementById('ticket-search-print').onclick = function() {
                // Create printable HTML with styles
                var printContent = document.getElementById('ticket-search-printable').innerHTML;
                var printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Ticket Report - ${escapeHtml(ticketNumber)}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; background: white; color: black; }
                            h4 { margin: 0 0 5px 0; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 12px; }
                            th { background: #f0f0f0; font-weight: bold; }
                            .header-box { background: #e8f4fc; border: 1px solid #0066cc; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
                            .asset-section { margin-bottom: 25px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
                            .asset-header { background: #f5f5f5; padding: 10px 15px; border-bottom: 1px solid #ddd; }
                            .before-col { background: #fff0f0 !important; }
                            .after-col { background: #f0fff0 !important; }
                            .status-approved { background: #22c55e; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; }
                            .status-rejected { background: #ef4444; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; }
                            .status-pending { background: #f59e0b; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; }
                            code { font-family: monospace; background: #f0f0f0; padding: 1px 4px; border-radius: 2px; }
                            .field-name { font-family: monospace; color: #996600; }
                            .page-title { text-align: center; margin-bottom: 20px; }
                            .print-date { text-align: right; color: #666; font-size: 11px; margin-bottom: 10px; }
                            @media print {
                                .before-col { background: #fff0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                .after-col { background: #f0fff0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                                .status-approved, .status-rejected, .status-pending { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="print-date">Printed: ${new Date().toLocaleString()}</div>
                        <h1 class="page-title">Ticket Change Report</h1>
                        <div class="header-box">
                            <p><strong>Ticket Number:</strong> ${escapeHtml(ticketNumber)}</p>
                            <p><strong>Total Changes:</strong> ${totalChanges}</p>
                            <p><strong>Assets Affected:</strong> ${assetCount}</p>
                        </div>
                `);

                // Build print-friendly content
                Object.keys(assets).sort().forEach(function(assetName) {
                    var assetChanges = assets[assetName];
                    printWindow.document.write('<div class="asset-section">');
                    printWindow.document.write('<div class="asset-header"><h4>' + escapeHtml(assetName) + '</h4><small>' + assetChanges.length + ' change(s)</small></div>');
                    printWindow.document.write('<table><thead><tr>');
                    printWindow.document.write('<th>Field</th><th class="before-col">Before</th><th class="after-col">After</th><th>Status</th><th>Date</th>');
                    printWindow.document.write('</tr></thead><tbody>');

                    assetChanges.forEach(function(change) {
                        var oldVal = formatValue(change.old_value);
                        var newVal = formatValue(change.new_value);
                        var status = (change.status || '').toLowerCase();
                        var statusClass = status === 'approved' ? 'status-approved' : status === 'rejected' ? 'status-rejected' : 'status-pending';
                        var statusText = (change.status || 'UNKNOWN').toUpperCase();
                        var dateStr = change.finalized_at ? new Date(change.finalized_at).toLocaleDateString() :
                                      change.created_at ? new Date(change.created_at).toLocaleDateString() : '‚Äî';

                        printWindow.document.write('<tr>');
                        printWindow.document.write('<td class="field-name">' + escapeHtml(formatFieldPath(change.field_path || change.field || '‚Äî')) + '</td>');
                        printWindow.document.write('<td class="before-col"><code>' + escapeHtml(oldVal) + '</code></td>');
                        printWindow.document.write('<td class="after-col"><code>' + escapeHtml(newVal) + '</code></td>');
                        printWindow.document.write('<td><span class="' + statusClass + '">' + statusText + '</span></td>');
                        printWindow.document.write('<td>' + dateStr + '</td>');
                        printWindow.document.write('</tr>');
                    });

                    printWindow.document.write('</tbody></table></div>');
                });

                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.print();
            };
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            };
        }

        // ============================================================
        // HELP VIEW
        // ============================================================

        function renderHelp(container) {
            var isAdmin = currentUser && currentUser.role === 'admin';

            var html = `
                <div class="max-w-screen-xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-100 mb-6">Fiducia Help Guide</h2>
                    <p class="text-gray-400 mb-8">CIP-010 Baseline Configuration Management System</p>

                    <!-- Quick Navigation -->
                    <div class="bg-gray-700 rounded-lg p-4 mb-8 border border-gray-600">
                        <h3 class="text-lg font-semibold text-white mb-3">Quick Navigation</h3>
                        <div class="flex flex-wrap gap-2">
                            <a href="#comparison-philosophy" class="px-3 py-1 bg-blue-700 text-blue-100 rounded hover:bg-blue-600 text-sm">Comparison Engine</a>
                            <a href="#getting-started" class="px-3 py-1 bg-gray-600 text-gray-200 rounded hover:bg-gray-500 text-sm">Getting Started</a>
                            <a href="#assets" class="px-3 py-1 bg-gray-600 text-gray-200 rounded hover:bg-gray-500 text-sm">Managing Assets</a>
                            <a href="#baselines" class="px-3 py-1 bg-gray-600 text-gray-200 rounded hover:bg-gray-500 text-sm">Baselines</a>
                            <a href="#changes" class="px-3 py-1 bg-gray-600 text-gray-200 rounded hover:bg-gray-500 text-sm">Reviewing Changes</a>
                            <a href="#renaming" class="px-3 py-1 bg-gray-600 text-gray-200 rounded hover:bg-gray-500 text-sm">Asset Renaming</a>
                            <a href="#retirement" class="px-3 py-1 bg-gray-600 text-gray-200 rounded hover:bg-gray-500 text-sm">Asset Retirement</a>
                            <a href="#compliance" class="px-3 py-1 bg-gray-600 text-gray-200 rounded hover:bg-gray-500 text-sm">Compliance Tracking</a>
                            <a href="#audit" class="px-3 py-1 bg-gray-600 text-gray-200 rounded hover:bg-gray-500 text-sm">Audit Logs</a>
                            <a href="#security" class="px-3 py-1 bg-red-700 text-red-100 rounded hover:bg-red-600 text-sm">Security</a>
                            ${isAdmin ? '<a href="#admin" class="px-3 py-1 bg-gray-600 text-gray-200 rounded hover:bg-gray-500 text-sm">Admin Settings</a>' : ''}
                        </div>
                    </div>

                    <!-- The Philosophy of Using Arrays for Baseline Comparisons -->
                    <div id="comparison-philosophy" class="bg-gradient-to-r from-blue-900/40 to-gray-700 rounded-lg p-6 mb-6 border border-blue-600/50">
                        <h3 class="text-xl font-semibold text-white mb-4">The Philosophy of Using Arrays for Baseline Comparisons</h3>
                        <div class="text-gray-300 space-y-4">

                            <div class="bg-gray-800/80 rounded p-4 border-l-4 border-blue-500">
                                <h4 class="font-semibold text-blue-300 mb-2">The Challenge</h4>
                                <p class="text-sm text-gray-300">Infrastructure configurations often contain complex, nested data structures‚Äîlists of open ports, installed software, network services, user accounts, and more. Traditional line-by-line comparison tools fail when:</p>
                                <ul class="list-disc list-inside mt-2 space-y-1 text-sm text-gray-400">
                                    <li>The <strong>order of items changes</strong> but the content remains the same</li>
                                    <li>Data is collected at different times, producing different ordering</li>
                                    <li>Tools report the data in non-deterministic order (common with API responses)</li>
                                    <li>The sheer volume of data makes manual comparison impractical</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800/80 rounded p-4 border-l-4 border-emerald-500">
                                <h4 class="font-semibold text-emerald-300 mb-2">Our Solution: Set-Based Array Comparison</h4>
                                <p class="text-sm text-gray-300 mb-3">Fiducia's comparison engine treats arrays as <strong>mathematical sets</strong>, not ordered lists. This means:</p>
                                <div class="grid md:grid-cols-2 gap-4 text-sm">
                                    <div class="bg-gray-900/50 rounded p-3">
                                        <p class="text-emerald-400 font-medium mb-1">Order Independence</p>
                                        <p class="text-gray-400">Two arrays with the same items in different orders are considered <strong>identical</strong>. No false positives from reordering.</p>
                                    </div>
                                    <div class="bg-gray-900/50 rounded p-3">
                                        <p class="text-emerald-400 font-medium mb-1">Precise Diff Detection</p>
                                        <p class="text-gray-400">Only <strong>actually added or removed items</strong> are reported. Items that exist in both (regardless of position) are ignored.</p>
                                    </div>
                                    <div class="bg-gray-900/50 rounded p-3">
                                        <p class="text-emerald-400 font-medium mb-1">Deep Object Comparison</p>
                                        <p class="text-gray-400">Nested objects within arrays are normalized and compared by content, not by memory reference or string representation.</p>
                                    </div>
                                    <div class="bg-gray-900/50 rounded p-3">
                                        <p class="text-emerald-400 font-medium mb-1">Signature-Based Grouping</p>
                                        <p class="text-gray-400">Identical changes across multiple assets are grouped together for bulk approval, saving review time.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gray-800/80 rounded p-4 border-l-4 border-amber-500">
                                <h4 class="font-semibold text-amber-300 mb-2">How It Works: Technical Overview</h4>
                                <div class="space-y-3 text-sm text-gray-300">
                                    <div>
                                        <p class="text-gray-200 font-medium">1. Canonical Key Generation</p>
                                        <p class="text-gray-400">Each array item (whether a simple value or complex nested object) is converted to a <strong>canonical string key</strong>. For objects, keys are sorted alphabetically and values are recursively processed, ensuring <code class="bg-gray-900 px-1 rounded">{a:1, b:2}</code> and <code class="bg-gray-900 px-1 rounded">{b:2, a:1}</code> produce identical keys.</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-200 font-medium">2. Set Membership Testing</p>
                                        <p class="text-gray-400">The baseline array and new array are both converted to sets of canonical keys. We then compute:</p>
                                        <ul class="list-disc list-inside ml-4 mt-1 text-gray-500">
                                            <li><strong class="text-emerald-400">Added items:</strong> Keys in new set but not in baseline set</li>
                                            <li><strong class="text-rose-400">Removed items:</strong> Keys in baseline set but not in new set</li>
                                            <li><strong class="text-gray-400">Unchanged:</strong> Keys present in both (ignored)</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <p class="text-gray-200 font-medium">3. Change Signature Computation</p>
                                        <p class="text-gray-400">Each detected change receives a SHA-256 signature based on the field path, change type, and the specific items added/removed. This allows identical changes across different assets to be grouped for bulk review.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gray-800/80 rounded p-4 border-l-4 border-purple-500">
                                <h4 class="font-semibold text-purple-300 mb-2">Real-World Example</h4>
                                <div class="text-sm text-gray-300">
                                    <p class="mb-3">Consider a server's <code class="bg-gray-900 px-1 rounded">ports_services</code> field with dozens of open ports:</p>
                                    <div class="grid md:grid-cols-2 gap-4 mb-3">
                                        <div class="bg-gray-900 rounded p-3">
                                            <p class="text-xs text-gray-500 mb-1">Baseline (collected Monday)</p>
                                            <code class="text-xs text-gray-400">[{port:22,proto:"tcp"}, {port:443,proto:"tcp"}, {port:80,proto:"tcp"}, ...]</code>
                                        </div>
                                        <div class="bg-gray-900 rounded p-3">
                                            <p class="text-xs text-gray-500 mb-1">New Config (collected Tuesday)</p>
                                            <code class="text-xs text-gray-400">[{port:80,proto:"tcp"}, {port:22,proto:"tcp"}, {port:8080,proto:"tcp"}, {port:443,proto:"tcp"}, ...]</code>
                                        </div>
                                    </div>
                                    <p class="mb-2"><strong>Traditional diff:</strong> Would show nearly every line as changed due to reordering.</p>
                                    <p><strong>Fiducia's comparison:</strong> Reports only the actual change:</p>
                                    <div class="bg-gray-900 rounded p-2 mt-2">
                                        <span class="text-emerald-400">+ Added:</span> <code class="text-emerald-300">{port: 8080, protocol: "tcp"}</code>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-blue-900/30 border border-blue-600/50 rounded p-4">
                                <h4 class="font-semibold text-blue-200 mb-2">Benefits for Compliance & Audit</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-blue-100/80">
                                    <li><strong>No false positives:</strong> Reviewers only see genuine configuration changes, not artifacts of data collection order</li>
                                    <li><strong>Reduced review burden:</strong> Bulk approval of identical changes across assets saves significant time</li>
                                    <li><strong>Clear audit trail:</strong> Each change shows exactly what was added or removed with the associated ticket number</li>
                                    <li><strong>Defensible methodology:</strong> The set-based comparison approach is mathematically sound and reproducible</li>
                                    <li><strong>Handles complexity:</strong> Works with nested objects, mixed data types, and large arrays without performance degradation</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Getting Started -->
                    <div id="getting-started" class="bg-gray-700 rounded-lg p-6 mb-6 border border-gray-600">
                        <h3 class="text-xl font-semibold text-white mb-4">Getting Started</h3>
                        <div class="text-gray-300 space-y-4">
                            <p><strong>Fiducia</strong> is a CIP-010 baseline configuration management system that tracks configuration changes across your assets and provides an audit trail for compliance.</p>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Key Concepts</h4>
                                <div class="space-y-4 text-sm text-gray-400">
                                    <div>
                                        <p class="text-gray-200 font-medium mb-1">Asset</p>
                                        <p>A tracked device or system (server, switch, firewall, workstation, etc.) identified by its FQDN or hostname. Each asset belongs to a team group and has its own baseline and change history.</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-200 font-medium mb-1">Baseline</p>
                                        <p>The <strong>approved configuration state</strong> for an asset. The baseline is the aggregation of all approved field values from uploaded JSON configuration files, stored as a database record. When you approve a change, that new value becomes part of the baseline. To view an asset's current baseline, go to <strong>Assets ‚Üí click the asset ‚Üí expand "Effective Baseline"</strong>.</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-200 font-medium mb-1">Detected Change</p>
                                        <p>When a new configuration file is uploaded for an existing asset, the system compares it against the current baseline. Any differences are flagged as <strong>detected changes</strong> with status "Pending". <span class="text-blue-400">Each detected change automatically starts a 30-day compliance timer</span> from the moment of detection.</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-200 font-medium mb-1">Baseline Monitoring (Scheduled Checks)</p>
                                        <p>A background process that periodically checks for changes whose 30-day timers have expired. This is a safety net, not the deadline driver - each change's timer runs independently from the moment of detection. <span class="text-yellow-400">Expired changes are marked as FAILED</span>, requiring PNCI documentation.</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-200 font-medium mb-1">Group</p>
                                        <p>Team assignment that determines visibility and responsibility. Options: Server, Desktop, Network, Telecom. Baseline Experts only see assets in their assigned group; Admins see all.</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-amber-900/40 border border-amber-600/50 rounded p-4">
                                <h4 class="font-semibold text-amber-200 mb-2">‚ö†Ô∏è Compliance Implications (v4.0.0)</h4>
                                <p class="text-sm text-amber-100/90 mb-3">The per-change timer system ensures timely resolution:</p>
                                <ul class="list-disc list-inside space-y-2 text-sm text-amber-100/80">
                                    <li><strong>Every detected change</strong> starts a 30-day timer immediately on detection</li>
                                    <li><strong>Baseline monitoring</strong> checks for expired timers and marks changes as FAILED</li>
                                    <li>The goal is to reconcile all changes with CMDB ticket activity <strong>within 30 days of detection</strong></li>
                                    <li>Each change has its own deadline ‚Äî resolve before the timer expires</li>
                                    <li>Changes that expire are marked <strong>FAILED</strong> and require PNCI documentation</li>
                                </ul>
                                <p class="text-sm text-amber-200 mt-3"><strong>Best Practice:</strong> Review and resolve changes promptly. Each change shows its remaining time.</p>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Workflow Overview (v4.0.0)</h4>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Upload asset configuration JSON files</li>
                                    <li>Assign new assets to a team and promote initial baseline</li>
                                    <li>System detects changes when new configs are uploaded ‚Äî 30-day timer starts automatically</li>
                                    <li>Review and approve/reject changes within 30 days, linking to CMDB tickets</li>
                                    <li>Approved changes become the new baseline</li>
                                    <li>On scheduled monitoring dates, expired timers mark changes as FAILED</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- Managing Assets -->
                    <div id="assets" class="bg-gray-700 rounded-lg p-6 mb-6 border border-gray-600">
                        <h3 class="text-xl font-semibold text-white mb-4">Managing Assets</h3>
                        <div class="text-gray-300 space-y-4">

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Adding New Assets</h4>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Go to <strong>Assets</strong> page</li>
                                    <li>Drag and drop JSON config files onto the upload area, or click to browse</li>
                                    <li>New assets appear in yellow "Awaiting Review" banner</li>
                                    <li>Click <strong>Review & Promote</strong> to assign a team</li>
                                    <li>Select a team from the dropdown and click <strong>Promote Baseline</strong></li>
                                </ol>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Asset States</h4>
                                <ul class="space-y-2 text-sm">
                                    <li><span class="text-gray-400 font-medium">ACTIVE</span> - New asset, awaiting initial baseline promotion</li>
                                    <li><span class="text-green-500 font-medium">COMPLIANT</span> - Baseline established, no pending changes</li>
                                    <li><span class="text-blue-400 font-medium">PENDING</span> - Changes detected, awaiting review</li>
                                    <li><span class="text-yellow-400 font-medium">INVESTIGATION</span> - One or more changes flagged for investigation. Timer continues from detection.</li>
                                    <li><span class="text-red-500 font-medium">FAILED</span> - 30-day compliance window exceeded without resolution</li>
                                    <li><span class="text-gray-500 font-medium">RETIRED</span> - Asset decommissioned, excluded from checks</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Viewing Asset Details</h4>
                                <p class="text-sm text-gray-400 mb-2">Click any asset row to view its details:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong>Effective Baseline</strong> - Current approved configuration</li>
                                    <li><strong>Pending Changes</strong> - Changes awaiting review</li>
                                    <li><strong>Raw Configuration Editor</strong> - Manually propose config changes</li>
                                    <li><strong>Audit Log</strong> - History of all actions on this asset</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Filtering Assets</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong>Status Tabs</strong> - Filter by Active, Retired, or All</li>
                                    <li><strong>Team Filter</strong> - Filter by team assignment (dropdown)</li>
                                    <li><strong>Column Sorting</strong> - Click column headers to sort</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Baselines -->
                    <div id="baselines" class="bg-gray-700 rounded-lg p-6 mb-6 border border-gray-600">
                        <h3 class="text-xl font-semibold text-white mb-4">Baselines</h3>
                        <div class="text-gray-300 space-y-4">

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Promoting Initial Baseline</h4>
                                <p class="text-sm text-gray-400 mb-2">When a new asset is uploaded:</p>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Asset appears in "Awaiting Review" section on Assets page</li>
                                    <li>Click <strong>Review & Promote</strong></li>
                                    <li>Review the configuration data</li>
                                    <li>Select the appropriate team</li>
                                    <li>Click <strong>Promote Baseline</strong> to establish the official baseline</li>
                                </ol>
                                <p class="text-sm text-gray-500 mt-2">This first config becomes the baseline all future uploads are compared against.</p>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Updating Baselines</h4>
                                <p class="text-sm text-gray-400 mb-2">Baselines are updated when changes are approved:</p>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Upload a new config file for an existing asset</li>
                                    <li>System detects differences and creates pending changes</li>
                                    <li>Review changes on Dashboard or Review page</li>
                                    <li>Approve changes ‚Üí baseline is updated with new values</li>
                                    <li>Investigate changes ‚Üí flag for further review before approval</li>
                                </ol>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Manual Configuration Edits</h4>
                                <p class="text-sm text-gray-400 mb-2">To manually modify a baseline:</p>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Go to <strong>Assets</strong> ‚Üí click the asset</li>
                                    <li>Expand <strong>Raw Configuration Editor</strong></li>
                                    <li>Edit the JSON directly</li>
                                    <li>Click <strong>Submit for Review</strong></li>
                                    <li>Changes go through normal approval workflow</li>
                                </ol>
                                <p class="text-sm text-gray-500 mt-2">Manual edits are logged with your username in the audit trail.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Reviewing Changes -->
                    <div id="changes" class="bg-gray-700 rounded-lg p-6 mb-6 border border-gray-600">
                        <h3 class="text-xl font-semibold text-white mb-4">Reviewing Changes</h3>
                        <div class="text-gray-300 space-y-4">

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Dashboard Review</h4>
                                <p class="text-sm text-gray-400 mb-2">The Dashboard shows pending changes inline:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong>Group Tabs</strong> - Filter changes by team (admins see "All Assets")</li>
                                    <li><strong>Grouped Changes</strong> - Same change across multiple assets (bulk action)</li>
                                    <li><strong>Asset-Specific Changes</strong> - Changes unique to single assets</li>
                                    <li>Click <strong>Approve</strong> or <strong>Investigate</strong> for each change</li>
                                    <li>Click <strong>Finalize Reviewed Changes</strong> to apply your decisions</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Change Actions</h4>
                                <ul class="space-y-2 text-sm">
                                    <li><span class="text-green-500 font-medium">Approve</span> - Accept change, update baseline to new value</li>
                                    <li><span class="text-yellow-400 font-medium">Investigate</span> - Flag change as requiring investigation. This moves the asset to INVESTIGATION state. The 30-day timer continues from detection. Use this when a change needs further review before approval/rejection.</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Bulk Approval</h4>
                                <p class="text-sm text-gray-400">When the same change appears across multiple assets (e.g., version update), you can approve/reject them all at once. Click "View X affected assets" to see which assets are impacted before deciding.</p>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Change Management Tickets</h4>
                                <p class="text-sm text-gray-400 mb-3">Associate change management ticket numbers with baseline changes for audit documentation. Two levels of ticket assignment:</p>
                                <ul class="list-disc list-inside space-y-2 text-sm text-gray-400">
                                    <li><span class="text-slate-300 font-medium">Per-Asset Ticket</span> (Slate) - Apply a ticket # to all changes for a specific asset. Each asset group has its own "Apply to Asset" button.</li>
                                    <li><span class="text-gray-400 font-medium">Per-Field Ticket</span> (Subtle) - Override individual change ticket #s when multiple tickets are involved. Enter directly on each change card.</li>
                                </ul>
                                <p class="text-sm text-gray-500 mt-3">Ticket numbers are included in all reports and the approved changes list for compliance documentation.</p>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Role-Based Access</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong>Team Members</strong> - Only see changes for their assigned team</li>
                                    <li><strong>Admins</strong> - See all changes across all teams</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Asset Renaming -->
                    <div id="renaming" class="bg-gray-700 rounded-lg p-6 mb-6 border border-gray-600">
                        <h3 class="text-xl font-semibold text-white mb-4">Renaming Assets (FQDN Change)</h3>
                        <div class="text-gray-300 space-y-4">
                            <p class="text-sm text-gray-400">When an asset's FQDN changes (server rename, domain migration, etc.), use the dedicated rename function to maintain continuity of all baselines, history, and audit records.</p>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">How to Rename an Asset</h4>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Go to <strong>Assets</strong> ‚Üí click the asset</li>
                                    <li>Scroll to bottom and click <strong>Rename Asset</strong></li>
                                    <li>Enter the new FQDN/hostname</li>
                                    <li>Click <strong>Submit</strong></li>
                                </ol>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Why Use Rename?</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li>The FQDN is the <strong>unique identifier</strong> used to match baseline files to assets</li>
                                    <li>Renaming preserves all baseline history, changes, and audit logs</li>
                                    <li>The audit log clearly captures: "old_name" ‚Üí "new_name"</li>
                                    <li>Future baseline uploads will match against the new name</li>
                                </ul>
                            </div>

                            <div class="bg-yellow-900/50 border border-amber-700/50 rounded p-4">
                                <h4 class="font-semibold text-yellow-200 mb-2">‚ö†Ô∏è Important</h4>
                                <p class="text-sm text-amber-400">After renaming, update your baseline collection scripts to export with the new FQDN. The next baseline upload must use the new name to be associated with this asset.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Asset Retirement -->
                    <div id="retirement" class="bg-gray-700 rounded-lg p-6 mb-6 border border-gray-600">
                        <h3 class="text-xl font-semibold text-white mb-4">Asset Retirement</h3>
                        <div class="text-gray-300 space-y-4">
                            <p class="text-sm text-gray-400">Retired assets are excluded from automated checks but retain their history for audit purposes (3+ years).</p>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">How to Retire an Asset</h4>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Go to <strong>Assets</strong> ‚Üí click the asset</li>
                                    <li>Scroll to bottom and click <strong>Retire Asset</strong></li>
                                    <li>Enter the retirement ticket number (required for audit)</li>
                                    <li>Click <strong>Submit</strong></li>
                                </ol>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Retired Asset Behavior</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li>Excluded from scheduled compliance checks</li>
                                    <li>Not included in change detection automation</li>
                                    <li>Appears in "Retired" tab on Assets page (dimmed)</li>
                                    <li>Full history preserved for audit</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Restoring a Retired Asset</h4>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Go to <strong>Assets</strong> ‚Üí click "Retired" tab</li>
                                    <li>Click the retired asset</li>
                                    <li>Click <strong>Restore Asset</strong></li>
                                    <li>Asset returns to active status and will be included in checks</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <!-- Compliance Tracking -->
                    <div id="compliance" class="bg-gray-700 rounded-lg p-6 mb-6 border border-gray-600">
                        <h3 class="text-xl font-semibold text-white mb-4">Compliance Tracking</h3>
                        <div class="text-gray-300 space-y-4">

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">What Triggers Investigation?</h4>
                                <p class="text-sm text-gray-400 mb-2">An asset enters INVESTIGATION state when:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong>Manual:</strong> A reviewer clicks "Investigate" on a detected change</li>
                                    <li><strong>Automatic:</strong> A scheduled compliance check finds the current config doesn't match the approved baseline</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">30-Day Per-Change Compliance Timer (v4.0.0)</h4>
                                <p class="text-sm text-gray-400">Per CIP-010 requirements, each detected change has its own timer:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400 mt-2">
                                    <li>Timer starts automatically when a change is detected</li>
                                    <li>Each change must be resolved (approved or rejected) within 30 days</li>
                                    <li>If not resolved within 30 days ‚Üí change moves to FAILED status</li>
                                    <li>Failed changes require PNCI (Potential Non-Compliance Identification) documentation</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Compliance Page Summary Cards</h4>
                                <p class="text-sm text-gray-400 mb-2">The compliance page shows six status cards:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong class="text-gray-300">Total Assets:</strong> All non-retired assets in the system</li>
                                    <li><strong class="text-green-500">Compliant (No Pending):</strong> Assets with an approved baseline and no changes awaiting review</li>
                                    <li><strong class="text-blue-400">Awaiting Review:</strong> Assets with pending changes that need approval or rejection. <em class="text-blue-300">Each change has a 30-day timer from detection.</em></li>
                                    <li><strong class="text-yellow-400">In Investigation:</strong> Assets with changes flagged for investigation - timers continue from detection</li>
                                    <li><strong class="text-orange-400">Approaching Deadline:</strong> Investigations nearing the 30-day compliance window (warning or critical)</li>
                                    <li><strong class="text-red-500">Failed/Overdue:</strong> Assets that exceeded the 30-day window or failed compliance</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Scheduled Checks (v4.0.0)</h4>
                                <p class="text-sm text-gray-400 mb-2">Automated compliance checks run on configured days (default: 1st and 15th of each month):</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li>Checks for changes with expired 30-day timers</li>
                                    <li>Expired changes are marked as FAILED status</li>
                                    <li>Generates compliance reports for audit documentation</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Reports & Tools</h4>
                                <p class="text-sm text-gray-400 mb-2">The Compliance page provides these reporting functions:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong class="text-slate-400">Investigation Report:</strong> Detailed report showing for each investigation: Day 1 (when started), days elapsed, days remaining, all changes under review with old/new values. Works for current or historical dates.</li>
                                    <li><strong class="text-gray-300">Baseline Report:</strong> Full asset baseline configurations for audit documentation. Use "Print All Assets (TXT)" for all assets or "PDF by Asset Name" for specific assets.</li>
                                    <li><strong class="text-emerald-400">Investigation Closure Reports:</strong> Filter by date, search by asset name or ticket number, with individual PDF downloads (v4.0.1)</li>
                                    <li><strong class="text-purple-400">Custom Baseline PDF:</strong> Generate PDF baseline reports for specific assets by entering comma-separated names (v4.0.1)</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Using Reports</h4>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Go to <strong>Compliance</strong> page</li>
                                    <li>Select a date using the date picker (defaults to today)</li>
                                    <li>Click the desired report button</li>
                                    
                                    <li><strong>Print All Assets (TXT)</strong> downloads all asset baselines. <strong>PDF by Asset Name</strong> generates a PDF for specific assets</li>
                                </ol>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Ticket Search</h4>
                                <p class="text-sm text-gray-400 mb-2">Find all changes associated with a Change Management ticket:</p>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Go to <strong>Compliance</strong> page</li>
                                    <li>Enter the ticket number in the <strong>Ticket Search</strong> field</li>
                                    <li>Click <strong>Search</strong></li>
                                    <li>View all approved, rejected, and pending changes linked to that ticket</li>
                                    <li>See before/after values for each change grouped by asset</li>
                                    <li>Click <strong>Download PDF</strong> to generate a formatted report for the ticket</li>
                                </ol>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">File Comparison Tool</h4>
                                <p class="text-sm text-gray-400 mb-2">Compare two baseline configuration files side-by-side:</p>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Go to <strong>Compliance</strong> page</li>
                                    <li>Click <strong>Open Comparison Tool</strong></li>
                                    <li>Upload a "Before" JSON file (drag & drop or click)</li>
                                    <li>Upload an "After" JSON file</li>
                                    <li>Click <strong>Compare Files</strong> to see differences</li>
                                </ol>
                                <p class="text-sm text-gray-500 mt-2">Useful for comparing configurations before uploading to verify expected changes.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Logs -->
                    <div id="audit" class="bg-gray-700 rounded-lg p-6 mb-6 border border-gray-600">
                        <h3 class="text-xl font-semibold text-white mb-4">Audit Logs</h3>
                        <div class="text-gray-300 space-y-4">
                            <p class="text-sm text-gray-400">Every action in Fiducia is logged for compliance and audit purposes.</p>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Logged Actions</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li>Asset creation and deletion</li>
                                    <li>Asset renaming (FQDN changes with old ‚Üí new name)</li>
                                    <li>Baseline promotion</li>
                                    <li>Change approvals and rejections</li>
                                    <li>Bulk approval actions</li>
                                    <li>Manual configuration edits</li>
                                    <li>Asset retirement and restoration</li>
                                    <li>Scheduled compliance checks</li>
                                    <li>Group/team assignments</li>
                                    <li>Password resets (with admin user tracking)</li>
                                    <li>Ticket numbers linked to change approvals</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Viewing Audit Logs</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong>Per Asset</strong>: Asset detail page ‚Üí expand "Audit Log" section</li>
                                    <li><strong>Per User</strong>: Compliance page ‚Üí User Audit dropdown (admin only)</li>
                                    <li><strong>System-wide</strong>: Settings ‚Üí Database section (admin only)</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Log Details</h4>
                                <p class="text-sm text-gray-400">Each log entry includes:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400 mt-2">
                                    <li>Timestamp</li>
                                    <li>Username who performed the action</li>
                                    <li>Action type and description</li>
                                    <li>Affected asset(s)</li>
                                    <li>Additional details (ticket numbers, change values, etc.)</li>
                                </ul>
                            </div>

                            ${isAdmin ? `
                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">User Activity Audit (Admin Only)</h4>
                                <p class="text-sm text-gray-400 mb-2">Review detailed activity history for any user:</p>
                                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-400">
                                    <li>Go to <strong>Compliance</strong> page</li>
                                    <li>Find the <strong>User Audit</strong> dropdown in the tools row</li>
                                    <li>Select a user (dropdown shows action counts per user)</li>
                                    <li>Click <strong>View</strong> to open the audit modal</li>
                                </ol>
                                <p class="text-sm text-gray-400 mt-3">The modal displays:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong>Action Summary</strong> - Color-coded badges showing counts by action type</li>
                                    <li><strong>Activity Log</strong> - Chronological list with timestamps, actions, and affected assets</li>
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    ${isAdmin ? `
                    <!-- Admin Settings -->
                    <div id="admin" class="bg-gray-700 rounded-lg p-6 mb-6 border border-gray-600">
                        <h3 class="text-xl font-semibold text-white mb-4">Admin Settings</h3>
                        <div class="text-gray-300 space-y-4">
                            <p class="text-sm text-gray-400">Admin-only configuration options available in Settings:</p>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">User Management</h4>
                                <p class="text-sm text-gray-400 mb-2">Go to <strong>Settings ‚Üí User Management</strong> to:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong>Create new users</strong> - Add local accounts with username, full name, password, and role</li>
                                    <li><strong>Assign roles:</strong>
                                        <ul class="list-disc list-inside ml-4 mt-1">
                                            <li><strong>Admin</strong> - Full access to all features including user management</li>
                                            <li><strong>Baseline Expert</strong> - Can review changes for their assigned team</li>
                                        </ul>
                                    </li>
                                    <li><strong>Reset passwords</strong> - Any admin can reset any user's password (including other admins)</li>
                                    <li><strong>Delete users</strong> - Remove user accounts (cannot delete yourself)</li>
                                </ul>
                            </div>

                            <div class="bg-amber-900/30 rounded p-4 border border-amber-600/50">
                                <h4 class="font-semibold text-amber-300 mb-2">LDAP vs Local Users</h4>
                                <p class="text-sm text-amber-200/80">
                                    If LDAP is enabled, users authenticate against Active Directory first. Password resets
                                    in Fiducia only affect the <em>local fallback password</em> used when LDAP is unavailable.
                                    To change an LDAP user's primary password, use Active Directory tools.
                                </p>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Watch Folder</h4>
                                <p class="text-sm text-gray-400">Configure automatic file ingestion:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400 mt-2">
                                    <li>Set watch folder path</li>
                                    <li>System automatically processes JSON files dropped in folder</li>
                                    <li>Trigger manual scan</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Scheduler</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li>View scheduler status</li>
                                    <li>Manually trigger compliance check</li>
                                    <li>Configure check days (default: 1st and 15th)</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">LDAP Integration</h4>
                                <p class="text-sm text-gray-400">Configure LDAP/Active Directory authentication for enterprise SSO.</p>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Email Notifications</h4>
                                <p class="text-sm text-gray-400 mb-2">Configure SMTP email alerts for compliance events:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong>SMTP Configuration</strong> - Server, port, TLS/SSL, authentication credentials</li>
                                    <li><strong>Approaching Deadline Alert</strong> - Sent when assets enter the warning threshold (5 days remaining)</li>
                                    <li><strong>Failed/Overdue Alert</strong> - Sent when assets exceed the 30-day compliance window</li>
                                    <li><strong>Weekly Investigation Report</strong> - Scheduled summary of all compliance status</li>
                                    <li><strong>Recipients</strong> - Configure separate email lists for compliance team and managers</li>
                                </ul>
                                <p class="text-sm text-gray-400 mt-2">Use "Test Connection" to verify SMTP settings and "Send Test Email" to confirm delivery.</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- API Integration -->
                    <div class="bg-gray-700 rounded-lg p-6 mb-6 border border-gray-600">
                        <h3 class="text-xl font-semibold text-white mb-4">API Integration & Automation</h3>
                        <div class="text-gray-300 space-y-4">
                            <p class="text-sm text-gray-400">Fiducia provides a REST API for integrating with automation tools, scripts, and CI/CD pipelines. You can submit configuration baselines directly via API without using file uploads.</p>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Authentication</h4>
                                <p class="text-sm text-gray-400 mb-2">All API requests require a Bearer token. Get one by logging in:</p>
                                <pre class="bg-gray-900 p-3 rounded text-xs text-green-400 overflow-x-auto"><code>curl -X POST http://localhost:8000/api/auth/login \\
  -H "Content-Type: application/json" \\
  -d '{"username": "your_user", "password": "your_pass"}'

# Response: {"access_token": "eyJ...", "token_type": "bearer"}</code></pre>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Submit Configuration via API</h4>
                                <p class="text-sm text-gray-400 mb-2">Use <code class="bg-gray-900 px-1 rounded">POST /api/assets/submit-config</code> to submit configurations directly from scripts:</p>
                                <pre class="bg-gray-900 p-3 rounded text-xs text-green-400 overflow-x-auto"><code>curl -X POST http://localhost:8000/api/assets/submit-config \\
  -H "Authorization: Bearer YOUR_TOKEN" \\
  -H "Content-Type: application/json" \\
  -d '{
    "config": {
      "fqdn": "server1.example.com",
      "timestamp": "2025-12-16T23:00:00Z",
      "network": {
        "dns": ["10.0.0.1", "10.0.0.2"],
        "gateway": "10.0.0.254"
      },
      "services": ["ssh", "http"],
      "installed_packages": ["openssh-server", "nginx"]
    },
    "source_name": "ansible_baseline_collection"
  }'</code></pre>
                                <p class="text-sm text-gray-400 mt-3"><strong>Response:</strong></p>
                                <pre class="bg-gray-900 p-3 rounded text-xs text-blue-400 overflow-x-auto"><code>{
  "asset_name": "server1.example.com",
  "is_new_asset": false,
  "changes_detected": 2,
  "message": "Detected 2 change(s) - review pending"
}</code></pre>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Required Config Fields</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong>fqdn</strong>, <strong>hostname</strong>, <strong>host</strong>, or <strong>name</strong> - Asset identifier (required)</li>
                                    <li><strong>timestamp</strong>, <strong>capture_date</strong>, or <strong>scan_date</strong> - When config was captured (optional, used for ordering)</li>
                                    <li><strong>version</strong> - Software/OS version (optional)</li>
                                    <li>Any other fields become part of the baseline configuration</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Python Example</h4>
                                <pre class="bg-gray-900 p-3 rounded text-xs text-green-400 overflow-x-auto"><code>import requests

# Login and get token
auth = requests.post("http://localhost:8000/api/auth/login",
    json={"username": "admin", "password": "password"})
token = auth.json()["access_token"]

# Submit configuration
config_data = {
    "config": {
        "fqdn": "webserver01.prod.local",
        "timestamp": "2025-12-16T12:00:00Z",
        "network": {"ip": "10.1.1.10", "dns": ["10.0.0.1"]},
        "services": ["nginx", "php-fpm"]
    },
    "source_name": "daily_baseline_scan"
}

response = requests.post(
    "http://localhost:8000/api/assets/submit-config",
    json=config_data,
    headers={"Authorization": f"Bearer {token}"}
)
print(response.json())</code></pre>
                            </div>

                            <div class="bg-blue-900/30 rounded p-4 border border-blue-600/50">
                                <h4 class="font-semibold text-blue-300 mb-2">Use Cases</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-blue-200/80">
                                    <li><strong>Ansible/Puppet/Chef</strong> - Post-deployment baseline collection</li>
                                    <li><strong>CI/CD Pipelines</strong> - Automated compliance checks after deployments</li>
                                    <li><strong>Cron Jobs</strong> - Scheduled baseline collection scripts</li>
                                    <li><strong>SIEM Integration</strong> - Forward config changes to security monitoring</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Security & Deployment -->
                    <div id="security" class="bg-gradient-to-r from-red-900/30 to-gray-700 rounded-lg p-6 mb-6 border border-red-600/50">
                        <h3 class="text-xl font-semibold text-white mb-4">üîí Security & Production Deployment</h3>
                        <div class="text-gray-300 space-y-4">
                            <p class="text-sm text-gray-400">When deploying Fiducia externally or in production, follow these security best practices.</p>

                            <div class="bg-red-900/40 border border-red-600 rounded p-4">
                                <h4 class="font-semibold text-red-300 mb-2">‚ö†Ô∏è Critical: Before Going Live</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-red-200/90">
                                    <li><strong>Change SECRET_KEY</strong> - Generate a secure key: <code class="bg-gray-900 px-1 rounded">export SECRET_KEY="$(openssl rand -hex 32)"</code></li>
                                    <li><strong>Change default passwords</strong> - Update admin and all team user passwords immediately</li>
                                    <li><strong>Set DEBUG=False</strong> - Disables API documentation and verbose error messages</li>
                                    <li><strong>Configure CORS_ORIGINS</strong> - Set to your actual domain(s), not "*"</li>
                                    <li><strong>Configure ALLOWED_HOSTS</strong> - Set to your domain to prevent host header attacks</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Environment Variables for Production</h4>
                                <pre class="bg-gray-900 p-3 rounded text-xs text-green-400 overflow-x-auto"><code># Required security settings
export SECRET_KEY="$(openssl rand -hex 32)"
export DEBUG=false
export CORS_ORIGINS="https://fiducia.yourcompany.com"
export ALLOWED_HOSTS="fiducia.yourcompany.com"

# Optional: Adjust session timeout (default 480 minutes = 8 hours)
export ACCESS_TOKEN_EXPIRE_MINUTES=60</code></pre>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Reverse Proxy Configuration (Nginx)</h4>
                                <p class="text-sm text-gray-400 mb-2">When behind a reverse proxy, configure proper headers:</p>
                                <pre class="bg-gray-900 p-3 rounded text-xs text-blue-400 overflow-x-auto"><code>server {
    listen 443 ssl http2;
    server_name fiducia.yourcompany.com;

    # SSL Configuration
    ssl_certificate /etc/ssl/certs/fiducia.crt;
    ssl_certificate_key /etc/ssl/private/fiducia.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    # Security Headers (additional to app-level)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Limit request body size
        client_max_body_size 10M;
    }
}</code></pre>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Built-in Security Features</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li><strong>Rate Limiting</strong> - Login attempts limited to 10 per minute per IP</li>
                                    <li><strong>Account Lockout</strong> - 5 failed logins = 15 minute lockout</li>
                                    <li><strong>Security Headers</strong> - X-Frame-Options, X-Content-Type-Options, CSP (in production)</li>
                                    <li><strong>Request Size Limits</strong> - 10MB max request body by default</li>
                                    <li><strong>JWT Tokens</strong> - Signed tokens with configurable expiration</li>
                                    <li><strong>Password Hashing</strong> - bcrypt with automatic salting</li>
                                    <li><strong>SQL Injection Protection</strong> - SQLAlchemy ORM with parameterized queries</li>
                                    <li><strong>API Docs Disabled</strong> - /docs and /redoc hidden when DEBUG=False</li>
                                </ul>
                            </div>

                            <div class="bg-gray-800 rounded p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">LDAP/Active Directory</h4>
                                <p class="text-sm text-gray-400 mb-2">For enterprise deployments, enable LDAP authentication:</p>
                                <ul class="list-disc list-inside space-y-1 text-sm text-gray-400">
                                    <li>Configure LDAP settings in Settings ‚Üí LDAP Integration</li>
                                    <li>Users authenticate against AD, with local password fallback</li>
                                    <li>Group membership can determine team assignment</li>
                                    <li>Use LDAPS (port 636) for encrypted authentication</li>
                                </ul>
                            </div>

                            <div class="bg-amber-900/30 border border-amber-600/50 rounded p-4">
                                <h4 class="font-semibold text-amber-300 mb-2">Network Security Recommendations</h4>
                                <ul class="list-disc list-inside space-y-1 text-sm text-amber-200/80">
                                    <li>Deploy behind a WAF (Web Application Firewall) if internet-facing</li>
                                    <li>Use network segmentation - limit access to trusted networks</li>
                                    <li>Enable audit logging at the network/firewall level</li>
                                    <li>Consider IP allowlisting for administrative access</li>
                                    <li>Regular security scanning and penetration testing</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- FAQ -->
                    <div class="bg-gray-700 rounded-lg p-6 mb-6 border border-gray-600">
                        <h3 class="text-xl font-semibold text-white mb-4">Frequently Asked Questions</h3>
                        <div class="space-y-4">

                            <div class="border-b border-gray-600 pb-4">
                                <h4 class="font-semibold text-gray-200 mb-2">How do I upload a new configuration file?</h4>
                                <p class="text-sm text-gray-400">Go to Assets, drag and drop JSON files onto the upload area. Files must contain an "fqdn" or "hostname" field for identification.</p>
                            </div>

                            <div class="border-b border-gray-600 pb-4">
                                <h4 class="font-semibold text-gray-200 mb-2">Why can't I see changes for other teams?</h4>
                                <p class="text-sm text-gray-400">Non-admin users only see changes for their assigned team. Contact your admin if you need access to other teams' assets.</p>
                            </div>

                            <div class="border-b border-gray-600 pb-4">
                                <h4 class="font-semibold text-gray-200 mb-2">What happens if I reject a change?</h4>
                                <p class="text-sm text-gray-400">The baseline retains its original value. The rejected change is logged in the audit trail. You may want to investigate why the configuration differs from baseline.</p>
                            </div>

                            <div class="border-b border-gray-600 pb-4">
                                <h4 class="font-semibold text-gray-200 mb-2">How do I fix a mistake in the baseline?</h4>
                                <p class="text-sm text-gray-400">Go to the asset's detail page, expand "Raw Configuration Editor", make your corrections, and submit for review. The changes go through normal approval workflow.</p>
                            </div>

                            <div class="border-b border-gray-600 pb-4">
                                <h4 class="font-semibold text-gray-200 mb-2">What's the difference between ACTIVE and COMPLIANT?</h4>
                                <p class="text-sm text-gray-400">ACTIVE means the asset was uploaded but hasn't been assigned to a team yet. COMPLIANT means a baseline has been promoted and there are no pending changes.</p>
                            </div>

                            <div class="pb-4">
                                <h4 class="font-semibold text-gray-200 mb-2">How long is audit data retained?</h4>
                                <p class="text-sm text-gray-400">All audit logs and retired asset data are retained indefinitely (configurable). This supports CIP-010 requirements for 3+ years of compliance records.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Version Info -->
                    <div class="text-center text-gray-500 text-sm mt-8">
                        <p>Fiducia v${APP_VERSION} - CIP-010 Baseline Configuration Management</p>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================

        async function init() {
            if (loadAuth()) {
                try {
                    var user = await api('/api/auth/me');
                    currentUser = user;
                    groups = await api('/api/system/groups');

                    // Set initial group selection based on user permissions
                    initDashboardGroupSelection();

                    currentView = 'dashboard';
                } catch (err) {
                    clearAuth();
                    currentView = 'login';
                }
            }

            render();
        }

        init();
    </script>
</body>
</html>
